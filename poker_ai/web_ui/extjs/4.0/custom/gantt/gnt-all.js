/*

Ext Gantt 2.1.0-alpha-3
Copyright(c) 2009-2012 Bryntum AB
http://bryntum.com/contact
http://bryntum.com/license

*/
Ext.define("Sch.util.Patch",{target:null,minVersion:null,maxVersion:null,reportUrl:null,description:null,ieOnly:false,onClassExtended:function(a,b){if(b.ieOnly&&!Ext.isIE){return}if((!b.minVersion||Ext.versions.extjs.equals(b.minVersion)||Ext.versions.extjs.isGreaterThan(b.minVersion))&&(!b.maxVersion||Ext.versions.extjs.equals(b.maxVersion)||Ext.versions.extjs.isLessThan(b.maxVersion))){b.requires[0].override(b.overrides)}}});Ext.define("Sch.util.Date",{requires:"Ext.Date",singleton:true,constructor:function(){var a=Ext.Date;var c={MILLI:a.MILLI,SECOND:a.SECOND,MINUTE:a.MINUTE,HOUR:a.HOUR,DAY:a.DAY,WEEK:"w",MONTH:a.MONTH,QUARTER:"q",YEAR:a.YEAR};Ext.apply(this,c);var b=this;this.units=[b.MILLI,b.SECOND,b.MINUTE,b.HOUR,b.DAY,b.WEEK,b.MONTH,b.QUARTER,b.YEAR];for(var d in c){if(c.hasOwnProperty(d)){b.unitNames[c[d]]=b.unitNames[d]}}},betweenLesser:function(b,d,a){var c=b.getTime();return d.getTime()<=c&&c<a.getTime()},constrain:function(b,c,a){return this.min(this.max(b,c),a)},compareUnits:function(c,b){var a=Ext.Array.indexOf(this.units,c),d=Ext.Array.indexOf(this.units,b);return a>d?1:(a<d?-1:0)},add:function(b,c,e){var f=Ext.Date.clone(b);if(!c||e===0){return f}switch(c.toLowerCase()){case this.MILLI:f=new Date(b.getTime()+e);break;case this.SECOND:f=new Date(b.getTime()+(e*1000));break;case this.MINUTE:f=new Date(b.getTime()+(e*60000));break;case this.HOUR:f=new Date(b.getTime()+(e*3600000));break;case this.DAY:f.setDate(b.getDate()+e);break;case this.WEEK:f.setDate(b.getDate()+e*7);break;case this.MONTH:var a=b.getDate();if(a>28){a=Math.min(a,Ext.Date.getLastDateOfMonth(this.add(Ext.Date.getFirstDateOfMonth(b),this.MONTH,e)).getDate())}f.setDate(a);f.setMonth(f.getMonth()+e);break;case this.QUARTER:f=this.add(b,this.MONTH,e*3);break;case this.YEAR:f.setFullYear(b.getFullYear()+e);break}return f},getMeasuringUnit:function(a){if(a===this.WEEK){return this.DAY}return a},getDurationInUnit:function(d,a,c){var b;switch(c){case this.QUARTER:b=Math.round(this.getDurationInMonths(d,a)/3);break;case this.MONTH:b=Math.round(this.getDurationInMonths(d,a));break;case this.WEEK:b=Math.round(this.getDurationInDays(d,a))/7;break;case this.DAY:b=Math.round(this.getDurationInDays(d,a));break;case this.HOUR:b=Math.round(this.getDurationInHours(d,a));break;case this.MINUTE:b=Math.round(this.getDurationInMinutes(d,a));break;case this.SECOND:b=Math.round(this.getDurationInSeconds(d,a));break;case this.MILLI:b=Math.round(this.getDurationInMilliseconds(d,a));break}return b},getUnitToBaseUnitRatio:function(b,a){if(b===a){return 1}switch(b){case this.YEAR:switch(a){case this.QUARTER:return 1/4;case this.MONTH:return 1/12}break;case this.QUARTER:switch(a){case this.YEAR:return 4;case this.MONTH:return 1/3}break;case this.MONTH:switch(a){case this.YEAR:return 12;case this.QUARTER:return 3}break;case this.WEEK:switch(a){case this.DAY:return 1/7;case this.HOUR:return 1/168}break;case this.DAY:switch(a){case this.WEEK:return 7;case this.HOUR:return 1/24;case this.MINUTE:return 1/1440}break;case this.HOUR:switch(a){case this.DAY:return 24;case this.MINUTE:return 1/60}break;case this.MINUTE:switch(a){case this.HOUR:return 60;case this.SECOND:return 1/60;case this.MILLI:return 1/60000}break;case this.SECOND:switch(a){case this.MILLI:return 1/1000}break;case this.MILLI:switch(a){case this.SECOND:return 1000}break}return -1},getDurationInMilliseconds:function(b,a){return(a-b)},getDurationInSeconds:function(b,a){return(a-b)/1000},getDurationInMinutes:function(b,a){return(a-b)/60000},getDurationInHours:function(b,a){return(a-b)/3600000},getDurationInDays:function(b,a){return(a-b)/86400000},getDurationInBusinessDays:function(g,b){var c=Math.round((b-g)/86400000),a=0,f;for(var e=0;e<c;e++){f=this.add(g,this.DAY,e).getDay();if(f!==6&&f!==0){a++}}return a},getDurationInMonths:function(b,a){return((a.getFullYear()-b.getFullYear())*12)+(a.getMonth()-b.getMonth())},getDurationInYears:function(b,a){return this.getDurationInMonths(b,a)/12},min:function(b,a){return b<a?b:a},max:function(b,a){return b>a?b:a},intersectSpans:function(c,d,b,a){return this.betweenLesser(c,b,a)||this.betweenLesser(b,c,d)},getNameOfUnit:function(a){switch(a.toLowerCase()){case this.YEAR:return"YEAR";case this.QUARTER:return"QUARTER";case this.MONTH:return"MONTH";case this.WEEK:return"WEEK";case this.DAY:return"DAY";case this.HOUR:return"HOUR";case this.MINUTE:return"MINUTE";case this.SECOND:return"SECOND";case this.MILLI:return"MILLI"}throw"Incorrect UnitName"},unitNames:{YEAR:{single:"year",plural:"years",abbrev:"yr"},QUARTER:{single:"quarter",plural:"quarters",abbrev:"q"},MONTH:{single:"month",plural:"months",abbrev:"mon"},WEEK:{single:"week",plural:"weeks",abbrev:"w"},DAY:{single:"day",plural:"days",abbrev:"d"},HOUR:{single:"hour",plural:"hours",abbrev:"h"},MINUTE:{single:"minute",plural:"minutes",abbrev:"min"},SECOND:{single:"second",plural:"seconds",abbrev:"s"},MILLI:{single:"ms",plural:"ms",abbrev:"ms"}},getReadableNameOfUnit:function(b,a){return this.unitNames[b][a?"plural":"single"]},getShortNameOfUnit:function(a){return this.unitNames[a.toUpperCase()].abbrev},getUnitByName:function(a){a=a.toUpperCase();if(!this[a]){Ext.Error.raise("Unknown unit name")}return this[a]},getNext:function(c,f,a,e){var d=Ext.Date.clone(c);a=a||1;switch(f){case this.DAY:Ext.Date.clearTime(d);d=this.add(d,this.DAY,a);break;case this.WEEK:var b=d.getDay();d=this.add(d,this.DAY,(7*(a-1))+(b<e?(e-b):(7-b+e)));break;case this.MONTH:d=this.add(d,this.MONTH,a);d.setDate(1);break;case this.QUARTER:d=this.add(d,this.MONTH,((a-1)*3)+(3-(d.getMonth()%3)));break;case this.YEAR:d=new Date(d.getFullYear()+a,0,1);break;default:d=this.add(c,f,a);break}return d},getNumberOfMsFromTheStartOfDay:function(a){return a-Ext.Date.clearTime(a,true)||86400000},getNumberOfMsTillTheEndOfDay:function(a){return this.getStartOfNextDay(a,true)-a},getStartOfNextDay:function(b,e){var d=this.add(Ext.Date.clearTime(b,e),this.DAY,1);if(d.getDate()==b.getDate()){var c=this.add(Ext.Date.clearTime(b,e),this.DAY,2).getTimezoneOffset();var a=b.getTimezoneOffset();d=this.add(d,this.MINUTE,a-c)}return d},getEndOfPreviousDay:function(b){var a=Ext.Date.clearTime(b,true);if(a-b){return a}else{return this.add(a,this.DAY,-1)}}});Ext.define("Sch.util.DragTracker",{extend:"Ext.dd.DragTracker",xStep:1,yStep:1,setXStep:function(a){this.xStep=a},setYStep:function(a){this.yStep=a},getRegion:function(){var e=this.startXY,d=this.getXY(),b=Math.min(e[0],d[0]),f=Math.min(e[1],d[1]),c=Math.abs(e[0]-d[0]),a=Math.abs(e[1]-d[1]);return new Ext.util.Region(f,b+c,f+a,b)},onMouseDown:function(f,d){if(this.disabled||f.dragTracked){return}var c=f.getXY(),g,b,a=c[0],h=c[1];if(this.xStep>1){g=this.el.getX();a-=g;a=Math.round(a/this.xStep)*this.xStep;a+=g}if(this.yStep>1){b=this.el.getY();h-=b;h=Math.round(h/this.yStep)*this.yStep;h+=b}this.dragTarget=this.delegate?d:this.handle.dom;this.startXY=this.lastXY=[a,h];this.startRegion=Ext.fly(this.dragTarget).getRegion();if(this.fireEvent("mousedown",this,f)===false||this.fireEvent("beforedragstart",this,f)===false||this.onBeforeStart(f)===false){return}this.mouseIsDown=true;f.dragTracked=true;if(this.preventDefault!==false){f.preventDefault()}Ext.getDoc().on({scope:this,mouseup:this.onMouseUp,mousemove:this.onMouseMove,selectstart:this.stopSelect});if(this.autoStart){this.timer=Ext.defer(this.triggerStart,this.autoStart===true?1000:this.autoStart,this,[f])}},onMouseMove:function(g,f){if(this.active&&Ext.isIE&&!g.browserEvent.button){g.preventDefault();this.onMouseUp(g);return}g.preventDefault();var d=g.getXY(),b=this.startXY;if(!this.active){if(Math.max(Math.abs(b[0]-d[0]),Math.abs(b[1]-d[1]))>this.tolerance){this.triggerStart(g)}else{return}}var a=d[0],h=d[1];if(this.xStep>1){a-=this.startXY[0];a=Math.round(a/this.xStep)*this.xStep;a+=this.startXY[0]}if(this.yStep>1){h-=this.startXY[1];h=Math.round(h/this.yStep)*this.yStep;h+=this.startXY[1]}var c=this.xStep>1||this.yStep>1;if(!c||a!==d[0]||h!==d[1]){this.lastXY=[a,h];if(this.fireEvent("mousemove",this,g)===false){this.onMouseUp(g)}else{this.onDrag(g);this.fireEvent("drag",this,g)}}}});Ext.define("Sch.util.HeaderRenderers",{singleton:true,requires:["Sch.util.Date","Ext.XTemplate"],constructor:function(){var b=Ext.create("Ext.XTemplate",'<table class="sch-nested-hdr-tbl '+Ext.baseCSSPrefix+'column-header-text" cellpadding="0" cellspacing="0"><tr><tpl for="."><td style="width:{[100/xcount]}%" class="{cls} sch-dayheadercell-{dayOfWeek}">{text}</td></tpl></tr></table>').compile();var a=Ext.create("Ext.XTemplate",'<table class="sch-nested-hdr-tbl" cellpadding="0" cellspacing="0"><tr><tpl for="."><td style="width:{[100/xcount]}%" class="{cls}">{text}</td></tpl></tr></table>').compile();return{quarterMinute:function(f,d,c,e){c.headerCls="sch-nested-hdr-pad";return'<table class="sch-nested-hdr-tbl" cellpadding="0" cellspacing="0"><tr><td>00</td><td>15</td><td>30</td><td>45</td></tr></table>'},dateCells:function(d,c,e){return function(j,g,f){f.headerCls="sch-nested-hdr-nopad";var i=[],h=Ext.Date.clone(j);while(h<g){i.push({text:Ext.Date.format(h,e)});h=Sch.util.Date.add(h,d,c)}i[0].cls="sch-nested-hdr-cell-first";i[i.length-1].cls="sch-nested-hdr-cell-last";return a.apply(i)}},dateNumber:function(g,d,c){c.headerCls="sch-nested-hdr-nopad";var f=[],e=Ext.Date.clone(g);while(e<d){f.push({dayOfWeek:e.getDay(),text:e.getDate()});e=Sch.util.Date.add(e,Sch.util.Date.DAY,1)}return b.apply(f)},dayLetter:function(g,d,c){c.headerCls="sch-nested-hdr-nopad";var f=[],e=g;while(e<d){f.push({dayOfWeek:e.getDay(),text:Ext.Date.dayNames[e.getDay()].substr(0,1)});e=Sch.util.Date.add(e,Sch.util.Date.DAY,1)}f[0].cls="sch-nested-hdr-cell-first";f[f.length-1].cls="sch-nested-hdr-cell-last";return b.apply(f)},dayStartEndHours:function(e,d,c){c.headerCls="sch-hdr-startend";return Ext.String.format('<span class="sch-hdr-start">{0}</span><span class="sch-hdr-end">{1}</span>',Ext.Date.format(e,"G"),Ext.Date.format(d,"G"))}}}});Ext.define("Sch.patches.CellEditing",{extend:"Sch.util.Patch",requires:["Ext.grid.plugin.CellEditing"],description:"PATCH for broken Ext cell editing",overrides:{}});Ext.define("Sch.patches.GroupingFeature",{extend:"Sch.util.Patch",requires:["Ext.grid.feature.Grouping"],description:"Grouping not supported together with locked columns",overrides:{expand:function(e,g){var d=this,b=d.view,c=b.up("gridpanel"),a;if(Ext.isString(e)){e=Ext.get(b.id+"-gp-"+e)}a=Ext.getDom(e);d.collapsedState[a.id]=false;e.removeCls(d.collapsedCls);e.prev().removeCls(d.hdCollapsedCls);if(g!==true){b.refreshHeight()}var f=a.id.match(b.id+"-gp-(.*)")[1];b.fireEvent("groupexpand",b,f)},collapse:function(e,g){var d=this,b=d.view,c=b.up("gridpanel"),a;if(Ext.isString(e)){e=Ext.get(b.id+"-gp-"+e)}a=Ext.getDom(e);d.collapsedState[a.id]=true;e.addCls(d.collapsedCls);e.prev().addCls(d.hdCollapsedCls);if(g!==true){b.refreshHeight()}var f=a.id.match(b.id+"-gp-(.*)")[1];b.fireEvent("groupcollapse",b,f)}}});Ext.define("Sch.patches.LoadMask",{extend:"Sch.util.Patch",requires:["Ext.view.AbstractView"],minVersion:"4.1.0b3",reportURL:"http://www.sencha.com/forum/showthread.php?187700-4.1.0-B3-Ext.AbstractView-no-longer-binds-its-store-to-load-mask",description:"In Ext4.1 loadmask no longer bind the store",overrides:{bindStore:function(a,b){this.callParent(arguments);if(!this.loadMask||!this.loadMask.bindStore){return}if(a&&Ext.Array.contains(a.alias,"store.node")){a=this.ownerCt.store}this.loadMask.bindStore(a)}}});Ext.define("Sch.patches.TreeStoreIE",{extend:"Sch.util.Patch",requires:["Ext.data.TreeStore"],description:"IE breaks when loading nested xml nodes",ieOnly:true,overrides:{onNodeAdded:function(d,e){var c=this.getProxy(),a=c.getReader(),f=e.raw||e.data,g,b;Ext.Array.remove(this.removed,e);if(!e.isLeaf()&&!e.isLoaded()){g=a.getRoot(f);if(g){this.fillNode(e,a.extractData(g));if(f[a.root]){delete f[a.root]}}}}}});Ext.define("Sch.patches.XmlReader",{extend:"Sch.util.Patch",requires:["Ext.data.reader.Xml"],description:"IE cannot handle loading nested XML",reportURL:"http://www.sencha.com/forum/showthread.php?136404-INFOREQ-4.0.2-RC3-Returning-nested-XML-data-for-a-Tree-doesn-t-work...",overrides:{extractData:function(a){var b=this.record;if(b!=a.nodeName){a=Ext.DomQuery.select(">"+b,a)}else{a=[a]}return Ext.data.reader.Xml.superclass.extractData.apply(this,[a])}}});Ext.define("Sch.model.Customizable",{extend:"Ext.data.Model",onClassExtended:function(b,d,a){var c=a.onBeforeCreated;a.onBeforeCreated=function(f,h){c.call(this,f,h);var g=f.prototype;if(!g._defaultFields_){return}g._defaultFields_=g._defaultFields_.concat(f.superclass._defaultFields_||[]);var i=g._defaultFields_;var e=g.fields;Ext.Array.each(i,function(o,m){if(typeof o=="string"){i[m]=o={name:o};o.isDefaultField=true}var l=o.name;var r=l.charAt(0).toLowerCase()+l.substr(1)+"Field";var n=g[r];if(n&&n!=l){if(!e.getByKey(n)){throw new Error("The override field ["+n+"] is not provided in definition of "+f.$className)}if(e.getByKey(l)&&e.getByKey(l).isDefaultField){e.removeAtKey(l)}}var q=n||l;if(!e.containsKey(q)){e.add(new Ext.data.Field(Ext.applyIf({name:q},o)))}var j=Ext.String.capitalize(l);if(j!="Id"){var p="get"+j;var k="set"+j;if(!g[p]||g[p].__getterFor__&&g[p].__getterFor__!=q){g[p]=function(){return this.get(q)};g[p].__getterFor__=q}if(!g[k]||g[k].__setterFor__&&g[k].__setterFor__!=q){g[k]=function(s){return this.set(q,s)};g[k].__setterFor__=q}}})}},set:function(c,b){if(arguments.length===2){this.previous=this.previous||{};var a=this.get(c);if(a!==b){this.previous[c]=a}}this.callParent(arguments)},afterEdit:function(){this.callParent(arguments);delete this.previous},reject:function(){var b=this,a=b.modified,c;b.previous=b.previous||{};for(c in a){if(a.hasOwnProperty(c)){if(typeof a[c]!="function"){b.previous[c]=b.get(c)}}}b.callParent(arguments);delete b.previous}});Ext.define("Sch.model.Range",{extend:"Sch.model.Customizable",requires:["Sch.util.Date"],startDateField:"StartDate",endDateField:"EndDate",clsField:"Cls",_defaultFields_:[{name:"StartDate",type:"date",dateFormat:"c"},{name:"EndDate",type:"date",dateFormat:"c"},{name:"Cls",defaultValue:"sch-daterange"}],setStartEndDate:function(b,a){this.beginEdit();this.set(this.startDateField,b);this.set(this.endDateField,a);this.endEdit()},getDates:function(){var c=[],b=this.getEndDate();for(var a=Ext.Date.clearTime(this.getStartDate(),true);a<b;a=Sch.util.Date.add(a,Sch.util.Date.DAY,1)){c.push(a)}return c},forEachDate:function(b,a){return Ext.each(this.getDates(),b,a)},isValid:function(){var b=this.callParent(arguments);if(b){var c=this.getStartDate(),a=this.getEndDate();b=c&&a&&(a-c>=0)}return b}});Ext.define("Sch.model.Resource",{extend:"Sch.model.Customizable",idProperty:"Id",nameField:"Name",_defaultFields_:["Id","Name"],getEventStore:function(){return this.stores[0]&&this.stores[0].eventStore||this.parentNode&&this.parentNode.getEventStore()},getEvents:function(){var d=[],e,f=this.getId()||this.internalId,c=this.getEventStore();for(var b=0,a=c.getCount();b<a;b++){e=c.getAt(b);if(e.data[e.resourceIdField]===f){d.push(e)}}return d}});Ext.define("Sch.data.mixin.ResourceStore",{});Ext.define("Sch.data.ResourceStore",{extend:"Ext.data.Store",model:"Sch.model.Resource",mixins:["Sch.data.mixin.ResourceStore"]});Ext.define("Sch.data.TimeAxis",{extend:"Ext.util.Observable",requires:["Ext.data.JsonStore","Sch.util.Date"],reverse:false,continuous:true,autoAdjust:true,constructor:function(a){Ext.apply(this,a);this.originalContinuous=this.continuous;this.addEvents("reconfigure");this.tickStore=new Ext.data.JsonStore({fields:["start","end"]});this.tickStore.on("datachanged",function(){this.fireEvent("reconfigure",this)},this);this.callParent(arguments)},reconfigure:function(a){Ext.apply(this,a);var c=this.tickStore,b=this.generateTicks(this.start,this.end,this.unit,this.increment||1,this.mainUnit);c.suspendEvents(true);c.loadData(b);if(c.getCount()===0){Ext.Error.raise("Invalid time axis configuration or filter, please check your input data.")}c.resumeEvents()},setTimeSpan:function(b,a){this.reconfigure({start:b,end:a})},filterBy:function(b,a){this.continuous=false;a=a||this;var c=this.tickStore;c.clearFilter(true);c.suspendEvents(true);c.filter([{filterFn:function(e,d){return b.call(a,e.data,d)}}]);if(c.getCount()===0){Ext.Error.raise("Invalid time axis filter - no columns passed through the filter. Please check your filter method.");this.clearFilter()}c.resumeEvents()},isContinuous:function(){return this.continuous&&!this.tickStore.isFiltered()},clearFilter:function(){this.continuous=this.originalContinuous;this.tickStore.clearFilter()},generateTicks:function(a,d,g,i){var h=[],f,b=Sch.util.Date,e=0;g=g||this.unit;i=i||this.increment;if(this.autoAdjust){a=this.floorDate(a||this.getStart(),false);d=this.ceilDate(d||b.add(a,this.mainUnit,this.defaultSpan),false)}while(a<d){f=this.getNext(a,g,i);if(g===b.HOUR&&i>1&&h.length>0&&e===0){var c=h[h.length-1];e=((c.start.getHours()+i)%24)-c.end.getHours();if(e!==0){f=b.add(f,b.HOUR,e)}}h.push({start:a,end:f});a=f}return h},getTickFromDate:function(c){if(this.getStart()>c||this.getEnd()<c){return -1}var f=this.tickStore.getRange(),e,a,d,b;if(this.reverse){for(d=f.length-1;d>=0;d--){a=f[d].data.end;if(c<=a){e=f[d].data.start;return d+(c<a?(1-(c-e)/(a-e)):0)}}}else{for(d=0,b=f.length;d<b;d++){a=f[d].data.end;if(c<=a){e=f[d].data.start;return d+(c>e?(c-e)/(a-e):0)}}}return -1},getDateFromTick:function(d,f){var g=this.tickStore.getCount();if(d===g){return this.reverse?this.getStart():this.getEnd()}var a=Math.floor(d),e=d-a,c=this.getAt(a);var b=Sch.util.Date.add(c.start,Sch.util.Date.MILLI,(this.reverse?(1-e):e)*(c.end-c.start));if(f){b=this[f+"Date"](b)}return b},getAt:function(a){return this.tickStore.getAt(a).data},getCount:function(){return this.tickStore.getCount()},getTicks:function(){var a=[];this.tickStore.each(function(b){a.push(b.data)});return a},getStart:function(){return Ext.Date.clone(this.tickStore[this.reverse?"last":"first"]().data.start)},getEnd:function(){return Ext.Date.clone(this.tickStore[this.reverse?"first":"last"]().data.end)},roundDate:function(r){var l=Ext.Date.clone(r),b=this.getStart(),s=this.resolutionIncrement;switch(this.resolutionUnit){case Sch.util.Date.MILLI:var e=Sch.util.Date.getDurationInMilliseconds(b,l),d=Math.round(e/s)*s;l=Sch.util.Date.add(b,Sch.util.Date.MILLI,d);break;case Sch.util.Date.SECOND:var i=Sch.util.Date.getDurationInSeconds(b,l),q=Math.round(i/s)*s;l=Sch.util.Date.add(b,Sch.util.Date.MILLI,q*1000);break;case Sch.util.Date.MINUTE:var n=Sch.util.Date.getDurationInMinutes(b,l),a=Math.round(n/s)*s;l=Sch.util.Date.add(b,Sch.util.Date.SECOND,a*60);break;case Sch.util.Date.HOUR:var m=Sch.util.Date.getDurationInHours(this.getStart(),l),j=Math.round(m/s)*s;l=Sch.util.Date.add(b,Sch.util.Date.MINUTE,j*60);break;case Sch.util.Date.DAY:var c=Sch.util.Date.getDurationInDays(b,l),f=Math.round(c/s)*s;l=Sch.util.Date.add(b,Sch.util.Date.DAY,f);break;case Sch.util.Date.WEEK:Ext.Date.clearTime(l);var o=l.getDay()-this.weekStartDay,t;if(o<0){o=7+o}if(Math.round(o/7)===1){t=7-o}else{t=-o}l=Sch.util.Date.add(l,Sch.util.Date.DAY,t);break;case Sch.util.Date.MONTH:var p=Sch.util.Date.getDurationInMonths(b,l)+(l.getDate()/Ext.Date.getDaysInMonth(l)),h=Math.round(p/s)*s;l=Sch.util.Date.add(b,Sch.util.Date.MONTH,h);break;case Sch.util.Date.QUARTER:Ext.Date.clearTime(l);l.setDate(1);l=Sch.util.Date.add(l,Sch.util.Date.MONTH,3-(l.getMonth()%3));break;case Sch.util.Date.YEAR:var k=Sch.util.Date.getDurationInYears(b,l),g=Math.round(k/s)*s;l=Sch.util.Date.add(b,Sch.util.Date.YEAR,g);break}return l},floorDate:function(s,d){d=d!==false;var m=Ext.Date.clone(s),b=d?this.getStart():null,t=this.resolutionIncrement;switch(d?this.resolutionUnit:this.mainUnit){case Sch.util.Date.MILLI:if(d){var f=Sch.util.Date.getDurationInMilliseconds(b,m),e=Math.floor(f/t)*t;m=Sch.util.Date.add(b,Sch.util.Date.MILLI,e)}break;case Sch.util.Date.SECOND:if(d){var j=Sch.util.Date.getDurationInSeconds(b,m),r=Math.floor(j/t)*t;m=Sch.util.Date.add(b,Sch.util.Date.MILLI,r*1000)}else{m.setMilliseconds(0)}break;case Sch.util.Date.MINUTE:if(d){var o=Sch.util.Date.getDurationInMinutes(b,m),a=Math.floor(o/t)*t;m=Sch.util.Date.add(b,Sch.util.Date.SECOND,a*60)}else{m.setSeconds(0);m.setMilliseconds(0)}break;case Sch.util.Date.HOUR:if(d){var n=Sch.util.Date.getDurationInHours(this.getStart(),m),k=Math.floor(n/t)*t;m=Sch.util.Date.add(b,Sch.util.Date.MINUTE,k*60)}else{m.setMinutes(0);m.setSeconds(0);m.setMilliseconds(0)}break;case Sch.util.Date.DAY:if(d){var c=Sch.util.Date.getDurationInDays(b,m),g=Math.floor(c/t)*t;m=Sch.util.Date.add(b,Sch.util.Date.DAY,g)}else{Ext.Date.clearTime(m)}break;case Sch.util.Date.WEEK:var p=m.getDay();Ext.Date.clearTime(m);if(p!==this.weekStartDay){m=Sch.util.Date.add(m,Sch.util.Date.DAY,-(p>this.weekStartDay?(p-this.weekStartDay):(7-p-this.weekStartDay)))}break;case Sch.util.Date.MONTH:if(d){var q=Sch.util.Date.getDurationInMonths(b,m),i=Math.floor(q/t)*t;m=Sch.util.Date.add(b,Sch.util.Date.MONTH,i)}else{Ext.Date.clearTime(m);m.setDate(1)}break;case Sch.util.Date.QUARTER:Ext.Date.clearTime(m);m.setDate(1);m=Sch.util.Date.add(m,Sch.util.Date.MONTH,-(m.getMonth()%3));break;case Sch.util.Date.YEAR:if(d){var l=Sch.util.Date.getDurationInYears(b,m),h=Math.floor(l/t)*t;m=Sch.util.Date.add(b,Sch.util.Date.YEAR,h)}else{m=new Date(s.getFullYear(),0,1)}break}return m},ceilDate:function(c,b){var e=Ext.Date.clone(c);b=b!==false;var a=b?this.resolutionIncrement:1,d=b?this.resolutionUnit:this.mainUnit,f=false;switch(d){case Sch.util.Date.DAY:if(e.getMinutes()>0||e.getSeconds()>0||e.getMilliseconds()>0){f=true}break;case Sch.util.Date.WEEK:Ext.Date.clearTime(e);if(e.getDay()!==this.weekStartDay){f=true}break;case Sch.util.Date.MONTH:Ext.Date.clearTime(e);if(e.getDate()!==1){f=true}break;case Sch.util.Date.QUARTER:Ext.Date.clearTime(e);if(e.getMonth()%3!==0){f=true}break;case Sch.util.Date.YEAR:Ext.Date.clearTime(e);if(e.getMonth()!==0&&e.getDate()!==1){f=true}break;default:break}if(f){return this.getNext(e,d,a)}else{return e}},getNext:function(b,c,a){return Sch.util.Date.getNext(b,c,a,this.weekStartDay)},getResolution:function(){return{unit:this.resolutionUnit,increment:this.resolutionIncrement}},setResolution:function(b,a){this.resolutionUnit=b;this.resolutionIncrement=a||1},shiftNext:function(a){a=a||this.getShiftIncrement();var b=this.getShiftUnit();this.setTimeSpan(Sch.util.Date.add(this.getStart(),b,a),Sch.util.Date.add(this.getEnd(),b,a))},shiftPrevious:function(a){a=-(a||this.getShiftIncrement());var b=this.getShiftUnit();this.setTimeSpan(Sch.util.Date.add(this.getStart(),b,a),Sch.util.Date.add(this.getEnd(),b,a))},getShiftUnit:function(){return this.shiftUnit||this.getMainUnit()},getShiftIncrement:function(){return this.shiftIncrement||1},getUnit:function(){return this.unit},getIncrement:function(){return this.increment},timeSpanInAxis:function(b,a){if(this.continuous){return Sch.util.Date.intersectSpans(b,a,this.getStart(),this.getEnd())}else{return a>b&&this.getTickFromDate(b)!==this.getTickFromDate(a)}}});Ext.define("Sch.preset.Manager",{extend:"Ext.util.MixedCollection",requires:["Sch.util.Date","Sch.util.HeaderRenderers"],singleton:true,constructor:function(){this.callParent(arguments);this.registerDefaults()},registerPreset:function(b,a){if(a){var c=a.headerConfig;var d=Sch.util.Date;for(var e in c){if(c.hasOwnProperty(e)){if(d[c[e].unit]){c[e].unit=d[c[e].unit.toUpperCase()]}}}if(!a.timeColumnWidth){a.timeColumnWidth=50}if(a.timeResolution&&d[a.timeResolution.unit]){a.timeResolution.unit=d[a.timeResolution.unit.toUpperCase()]}if(a.shiftUnit&&d[a.shiftUnit]){a.shiftUnit=d[a.shiftUnit.toUpperCase()]}}if(this.isValidPreset(a)){if(this.containsKey(b)){this.removeAtKey(b)}this.add(b,a)}else{throw"Invalid preset, please check your configuration"}},isValidPreset:function(a){var d=Sch.util.Date,b=true,c=Sch.util.Date.units;for(var e in a.headerConfig){if(a.headerConfig.hasOwnProperty(e)){b=b&&Ext.Array.indexOf(c,a.headerConfig[e].unit)>=0}}if(a.timeResolution){b=b&&Ext.Array.indexOf(c,a.timeResolution.unit)>=0}if(a.shiftUnit){b=b&&Ext.Array.indexOf(c,a.shiftUnit)>=0}return b},getPreset:function(a){return this.get(a)},deletePreset:function(a){this.removeAtKey(a)},registerDefaults:function(){var b=this,a=this.defaultPresets;for(var c in a){b.registerPreset(c,a[c])}},defaultPresets:{hourAndDay:{timeColumnWidth:60,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"G:i",shiftIncrement:1,shiftUnit:"DAY",defaultSpan:12,timeResolution:{unit:"MINUTE",increment:15},headerConfig:{middle:{unit:"HOUR",dateFormat:"G:i"},top:{unit:"DAY",dateFormat:"D d/m"}}},dayAndWeek:{timeColumnWidth:100,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"Y-m-d G:i",shiftUnit:"DAY",shiftIncrement:1,defaultSpan:5,timeResolution:{unit:"HOUR",increment:1},headerConfig:{middle:{unit:"DAY",dateFormat:"D d M"},top:{unit:"WEEK",renderer:function(c,b,a){return Sch.util.Date.getShortNameOfUnit("WEEK")+"."+Ext.Date.format(c,"W M Y")}}}},weekAndDay:{timeColumnWidth:100,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"Y-m-d",shiftUnit:"WEEK",shiftIncrement:1,defaultSpan:1,timeResolution:{unit:"DAY",increment:1},headerConfig:{bottom:{unit:"DAY",increment:1,dateFormat:"d/m"},middle:{unit:"WEEK",dateFormat:"D d M",align:"left"}}},weekAndMonth:{timeColumnWidth:100,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"Y-m-d",shiftUnit:"WEEK",shiftIncrement:5,defaultSpan:6,timeResolution:{unit:"DAY",increment:1},headerConfig:{middle:{unit:"WEEK",renderer:function(c,b,a){a.align="left";return Ext.Date.format(c,"d M")}},top:{unit:"MONTH",dateFormat:"M Y"}}},monthAndYear:{timeColumnWidth:110,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"Y-m-d",shiftIncrement:3,shiftUnit:"MONTH",defaultSpan:12,timeResolution:{unit:"DAY",increment:1},headerConfig:{middle:{unit:"MONTH",dateFormat:"M Y"},top:{unit:"YEAR",dateFormat:"Y"}}},year:{timeColumnWidth:100,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"Y-m-d",shiftUnit:"YEAR",shiftIncrement:1,defaultSpan:1,timeResolution:{unit:"MONTH",increment:1},headerConfig:{bottom:{unit:"QUARTER",renderer:function(c,b,a){return Ext.String.format(Sch.util.Date.getShortNameOfUnit("QUARTER").toUpperCase()+"{0}",Math.floor(c.getMonth()/3)+1)}},middle:{unit:"YEAR",dateFormat:"Y"}}},weekAndDayLetter:{timeColumnWidth:140,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"Y-m-d",shiftUnit:"WEEK",shiftIncrement:1,defaultSpan:10,timeResolution:{unit:"DAY",increment:1},headerConfig:{bottom:{unit:"WEEK",increment:1,renderer:function(){return Sch.util.HeaderRenderers.dayLetter.apply(this,arguments)}},middle:{unit:"WEEK",dateFormat:"D d M Y",align:"left"}}},weekDateAndMonth:{timeColumnWidth:30,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"Y-m-d",shiftUnit:"WEEK",shiftIncrement:1,defaultSpan:10,timeResolution:{unit:"DAY",increment:1},headerConfig:{middle:{unit:"WEEK",dateFormat:"d"},top:{unit:"MONTH",dateFormat:"Y F",align:"left"}}}}});Ext.define("Sch.feature.AbstractTimeSpan",{schedulerView:null,timeAxis:null,containerEl:null,disabled:false,cls:null,template:null,store:null,renderElementsBuffered:false,renderDelay:15,constructor:function(a){this.cls=this.cls||("sch-timespangroup-"+Ext.id());Ext.apply(this,a)},setDisabled:function(a){if(a){this.removeElements()}this.disabled=a},getElements:function(){if(this.containerEl){return this.containerEl.select("."+this.cls)}return null},removeElements:function(){var a=this.getElements();if(a){a.remove()}},init:function(a){this.timeAxis=a.getTimeAxis();this.schedulerView=a.getSchedulingView();if(!this.store){Ext.Error.raise("Error: You must define a store for this plugin")}this.schedulerView.on({afterrender:this.onAfterRender,destroy:this.onDestroy,scope:this})},onAfterRender:function(b){var a=this.schedulerView;this.containerEl=a.el;this.store.on({load:this.renderElements,datachanged:this.renderElements,clear:this.renderElements,add:this.renderElements,update:this.renderElements,remove:this.renderElements,scope:this});if(a.store instanceof Ext.data.NodeStore){if(a.animate){}else{a.store.on({expand:this.renderElements,collapse:this.renderElements,scope:this})}}a.on({itemadd:this.renderElements,itemremove:this.renderElements,itemupdate:this.renderElements,groupexpand:this.renderElements,groupcollapse:this.renderElements,scope:this});a.on({refresh:this.renderElements,scope:this});this.renderElements()},renderElements:function(){if(this.renderElementsBuffered||this.disabled||this.schedulerView.headerCt.getColumnCount()===0){return}this.renderElementsBuffered=true;Ext.Function.defer(this.renderElementsInternal,this.renderDelay,this)},renderElementsInternal:function(){this.renderElementsBuffered=false;if(this.disabled||this.schedulerView.isDestroyed||this.schedulerView.headerCt.getColumnCount()===0){return}this.removeElements();var e=this.timeAxis.getStart(),b=this.timeAxis.getEnd(),d=this.getElementData(e,b);for(var c=0,a=d.length;c<a;c++){d[c].uniquecls=this.cls}this.template.insertFirst(this.containerEl,d)},getElementData:function(c,a,b){throw"Abstract method call"},onDestroy:function(){if(this.store.autoDestroy){this.store.destroy()}}});Ext.define("Sch.plugin.Lines",{extend:"Sch.feature.AbstractTimeSpan",init:function(b){this.callParent(arguments);var a=this.schedulerView;if(!this.template){this.template=new Ext.XTemplate('<tpl for=".">','<div title="{[this.getTipText(values)]}" class="sch-timeline {uniquecls} {Cls}" style="left:{left}px;top:{top}px;height:{height}px;width:{width}px"></div>',"</tpl>",{getTipText:function(c){return a.getFormattedDate(c.Date)+" "+(c.Text||"")}})}},getElementData:function(j,m){var o=this.store,h=this.schedulerView,e=o.getRange(),g=[],n=this.containerEl.getHeight(),a,c,k,b;for(var f=0,d=o.getCount();f<d;f++){a=e[f];c=a.get("Date");if(c&&Ext.Date.between(c,j,m)){k=h.getTimeSpanRegion(c);g[g.length]=Ext.apply({left:k.left,top:k.top,width:Math.max(1,k.right-k.left),height:k.bottom-k.top},a.data)}}return g}});Ext.define("Sch.plugin.Zones",{extend:"Sch.feature.AbstractTimeSpan",requires:["Sch.model.Range"],init:function(a){if(!this.template){this.template=new Ext.XTemplate('<tpl for=".">','<div class="sch-zone {uniquecls} {Cls}" style="left:{left}px;top:{top}px;height:{height}px;width:{width}px"></div>',"</tpl>")}this.callParent(arguments)},getElementData:function(h,m){var n=this.store,g=this.schedulerView,d=n.getRange(),f=[],a,k,b,j;for(var e=0,c=n.getCount();e<c;e++){a=d[e];k=a.getStartDate();b=a.getEndDate();if(k&&b&&Sch.util.Date.intersectSpans(k,b,h,m)){j=g.getTimeSpanRegion(Sch.util.Date.max(k,h),Sch.util.Date.min(b,m));j.left=j.left-1;f[f.length]=Ext.apply({left:j.left,top:j.top,width:j.right-j.left,height:j.bottom-j.top},a.data)}}return f}});Ext.define("Sch.plugin.Pan",{alias:"plugin.pan",enableVerticalPan:true,panel:null,constructor:function(a){Ext.apply(this,a)},init:function(a){this.panel=a.normalGrid||a;this.view=a.getSchedulingView();this.view.on("afterrender",this.onRender,this)},onRender:function(a){this.view.el.on("mousedown",this.onMouseDown,this,{delegate:"."+this.view.timeCellCls})},onMouseDown:function(b,a){if(b.getTarget("."+this.view.timeCellCls)&&!b.getTarget(this.view.eventSelector)){this.mouseX=b.getPageX();this.mouseY=b.getPageY();Ext.getBody().on("mousemove",this.onMouseMove,this);Ext.getDoc().on("mouseup",this.onMouseUp,this)}},onMouseMove:function(d){d.stopEvent();var a=d.getPageX(),f=d.getPageY(),c=a-this.mouseX,b=f-this.mouseY;this.panel.scrollByDeltaX(-c);this.mouseX=a;this.mouseY=f;if(this.enableVerticalPan){this.panel.scrollByDeltaY(-b)}},onMouseUp:function(a){Ext.getBody().un("mousemove",this.onMouseMove,this);Ext.getDoc().un("mouseup",this.onMouseUp,this)}});Ext.define("Sch.view.Locking",{extend:"Ext.grid.LockingView",scheduleEventRelayRe:/^(schedule|event|beforeevent|afterevent|dragcreate|beforedragcreate|afterdragcreate|beforetooltipshow)/,constructor:function(b){this.callParent(arguments);var e=this,g=[],a=e.scheduleEventRelayRe,f=b.normal.getView(),c=f.events,d;for(d in c){if(c.hasOwnProperty(d)&&a.test(d)){g.push(d)}}e.relayEvents(f,g)},getElementFromEventRecord:function(a){return this.normal.getView().getElementFromEventRecord(a)},onClear:function(){this.relayFn("onClear",arguments)},beginBulkUpdate:function(){this.relayFn("beginBulkUpdate",arguments)},endBulkUpdate:function(){this.relayFn("endBulkUpdate",arguments)},refreshKeepingScroll:function(){this.normal.getView().refreshKeepingScroll();this.locked.getView().refresh()}});Ext.define("Sch.column.Time",{extend:"Ext.grid.column.Column",alias:"timecolumn",draggable:false,groupable:false,hideable:false,sortable:false,fixed:true,align:"center",tdCls:"sch-timetd",menuDisabled:true,initComponent:function(){this.addEvents("timeheaderdblclick");this.enableBubble("timeheaderdblclick");this.callParent()},initRenderData:function(){var a=this;a.renderData.headerCls=a.renderData.headerCls||a.headerCls;return a.callParent(arguments)},onElDblClick:function(b,a){this.callParent(arguments);this.fireEvent("timeheaderdblclick",this,this.startDate,this.endDate,b)}},function(){Sch.column.Time.prototype.renderTpl=Sch.column.Time.prototype.renderTpl.replace("column-header-inner","column-header-inner sch-timeheader {headerCls}")});Ext.define("Sch.column.timeAxis.Horizontal",{extend:"Ext.grid.column.Column",alias:"widget.timeaxiscolumn",requires:["Ext.Date","Ext.XTemplate","Sch.column.Time","Sch.preset.Manager"],cls:"sch-timeaxiscolumn",timeAxis:null,renderTpl:'<div id="{id}-titleEl" class="'+Ext.baseCSSPrefix+'column-header-inner"><span id="{id}-textEl" style="display:none" class="'+Ext.baseCSSPrefix+'column-header-text"></span><tpl if="topHeaderCells">{topHeaderCells}</tpl><tpl if="middleHeaderCells">{middleHeaderCells}</tpl></div>{%this.renderContainer(out,values)%}',headerRowTpl:'<table border="0" cellspacing="0" cellpadding="0" style="{tstyle}" class="sch-header-row sch-header-row-{position}"><thead><tr>{cells}</tr></thead></table>',headerCellTpl:'<tpl for="."><td class="sch-column-header x-column-header {headerCls}" style="position : static; text-align: {align}; {style}" tabIndex="0" id="{headerId}" headerPosition="{position}" headerIndex="{index}"><div class="x-column-header-inner">{header}</div></td></tpl>',columnConfig:{},timeCellRenderer:null,timeCellRendererScope:null,columnWidth:null,previousWidth:null,previousHeight:null,initComponent:function(){if(!(this.headerRowTpl instanceof Ext.Template)){this.headerRowTpl=Ext.create("Ext.XTemplate",this.headerRowTpl)}if(!(this.headerCellTpl instanceof Ext.Template)){this.headerCellTpl=Ext.create("Ext.XTemplate",this.headerCellTpl)}this.columns=[{}];this.addEvents("timeheaderdblclick","timeaxiscolumnreconfigured");this.enableBubble("timeheaderdblclick");this.stubForResizer=new Ext.Component({isOnLeftEdge:function(){return false},isOnRightEdge:function(){return false},el:{dom:{style:{}}}});this.callParent(arguments);this.onTimeAxisReconfigure();this.mon(this.timeAxis,"reconfigure",this.onTimeAxisReconfigure,this)},getSchedulingView:function(){return this.getOwnerHeaderCt().view},onTimeAxisReconfigure:function(){var e=this.timeAxis,d=e.preset.timeColumnWidth,f=this.rendered&&this.getSchedulingView(),g=e.headerConfig,b=e.getStart(),c=e.getEnd(),h={renderer:this.timeColumnRenderer,scope:this,width:this.rendered?f.calculateTimeColumnWidth(d):d};delete this.previousWidth;delete this.previousHeight;var j=this.columnConfig=this.createColumns(this.timeAxis,g,h);Ext.suspendLayouts();this.removeAll();if(this.rendered){var a=this.el.child(".x-column-header-inner");a.select("table").remove();var i=this.initRenderData();if(j.top){Ext.core.DomHelper.append(a,i.topHeaderCells)}if(j.middle){Ext.core.DomHelper.append(a,i.middleHeaderCells)}if(!j.top&&!j.middle){this.addCls("sch-header-single-row")}else{this.removeCls("sch-header-single-row")}}Ext.resumeLayouts();this.add(j.bottom);if(this.rendered){if(this.fireEvent("timeaxiscolumnreconfigured",this)!==false){f.refresh()}}},beforeRender:function(){var a=this.columnConfig;if(!a.middle&&!a.top){this.addCls("sch-header-single-row")}this.callParent(arguments)},timeColumnRenderer:function(i,e,f,l,d,c,k){var a="";if(Ext.isIE){e.style+=";z-index:"+(this.items.getCount()-d)}if(this.timeCellRenderer){var h=this.timeAxis,b=h.getAt(d),g=b.start,j=b.end;a=this.timeCellRenderer.call(this.timeCellRendererScope||this,e,f,l,d,c,g,j)}return a},initRenderData:function(){var a=this.columnConfig;var c=a.top?this.headerRowTpl.apply({cells:this.headerCellTpl.apply(a.top),position:"top",tstyle:"border-top : 0"}):"";var b=a.middle?this.headerRowTpl.apply({cells:this.headerCellTpl.apply(a.middle),position:"middle",tstyle:a.top?"":"border-top : 0"}):"";return Ext.apply(this.callParent(arguments),{topHeaderCells:c,middleHeaderCells:b})},defaultRenderer:function(c,b,a){return Ext.Date.format(c,a)},createColumns:function(e,g,c){if(!e||!g){throw"Invalid parameters passed to createColumns"}var b=[],k=g.bottom||g.middle,h=e.getTicks(),j;for(var d=0,a=h.length;d<a;d++){j={align:k.align||"center",headerCls:"",startDate:h[d].start,endDate:h[d].end};if(k.renderer){j.header=k.renderer.call(k.scope||this,h[d].start,h[d].end,j,d)}else{j.header=this.defaultRenderer(h[d].start,h[d].end,k.dateFormat)}b[b.length]=Ext.create("Sch.column.Time",Ext.apply(j,c))}var f=this.createHeaderRows(e,g);return{bottom:b,middle:f.middle,top:f.top}},createHeaderRows:function(e,c){var d={};if(c.top){var a;if(c.top.cellGenerator){a=c.top.cellGenerator.call(this,e.getStart(),e.getEnd())}else{a=this.createHeaderRow(e,c.top)}d.top=this.processHeaderRow(a,"top")}if(c.bottom){var b;if(c.middle.cellGenerator){b=c.middle.cellGenerator.call(this,e.getStart(),e.getEnd())}else{b=this.createHeaderRow(e,c.middle)}d.middle=this.processHeaderRow(b,"middle")}return d},processHeaderRow:function(c,a){var b=this;Ext.each(c,function(d,e){d.index=e;d.position=a;d.headerId=b.stubForResizer.id});return c},createHeaderRow:function(e,k){var n=[],l,a=e.getStart(),c=e.getEnd(),m=c-a,j=[],b=a,d=0,f,g=k.align||"center",h;while(b<c){h=Sch.util.Date.min(e.getNext(b,k.unit,k.increment||1),c);l={align:g,start:b,end:h,headerCls:""};if(k.renderer){l.header=k.renderer.call(k.scope||this,b,h,l,d)}else{l.header=this.defaultRenderer(b,h,k.dateFormat,l,d)}n.push(l);b=h;d++}return n},afterLayout:function(){delete this.columnWidth;this.callParent(arguments);var b=this.getWidth();var g=this.getHeight();if(b===this.previousWidth&&g===this.previousHeight){return}this.previousWidth=b;this.previousHeight=g;var i=this.columnConfig;var e=this;var c=this.el;var f=i.top;var d=0;var a=0;if(f){c.select(".sch-header-row-top").setWidth(this.lastBox.width);c.select(".sch-header-row-top td").each(function(l,m,j){var k=e.getHeaderGroupCellWidth(f[j].start,f[j].end);l.setVisibilityMode(Ext.Element.DISPLAY);if(k){d+=k;l.show();l.setWidth(k)}else{l.hide()}})}var h=i.middle;if(h){c.select(".sch-header-row-middle").setWidth(this.lastBox.width);c.select(".sch-header-row-middle td").each(function(l,m,j){var k=e.getHeaderGroupCellWidth(h[j].start,h[j].end);l.setVisibilityMode(Ext.Element.DISPLAY);if(k){a+=k;l.show();l.setWidth(k)}else{l.hide()}})}},getHeaderGroupCellWidth:function(h,b){var e=this.timeAxis.unit,d=this.timeAxis.increment,c,g=Sch.util.Date.getMeasuringUnit(e),a=Sch.util.Date.getDurationInUnit(h,b,g),f=this.getSchedulingView();if(this.timeAxis.isContinuous()){c=a*f.getSingleUnitInPixels(g)/d}else{c=f.getXYFromDate(b)[0]-f.getXYFromDate(h)[0]}return c},onElDblClick:function(d,f){this.callParent(arguments);var e=d.getTarget(".sch-column-header");if(e){var a=Ext.fly(e).getAttribute("headerPosition"),b=Ext.fly(e).getAttribute("headerIndex"),c=this.columnConfig[a][b];this.fireEvent("timeheaderdblclick",this,c.start,c.end,d)}},getTimeColumnWidth:function(){if(this.columnWidth===null){this.columnWidth=this.items.get(0).getWidth()}return this.columnWidth},setTimeColumnWidth:function(a){this.suspendEvents();this.items.each(function(b){b.setWidth(a)});this.resumeEvents()}});Ext.define("Sch.mixin.Lockable",{extend:"Ext.grid.Lockable",requires:["Sch.column.timeAxis.Horizontal"],inheritableStatics:{featureCascadeMap:{"Ext.grid.feature.Grouping":"both"},pluginCascadeMap:{"Ext.grid.plugin.Editing":"locked"}},processPlugins:function(d){d=d||[];var j=this,b=j.statics().pluginCascadeMap,g=d.length,f=[],h=[],a=0,e=0;for(e=g-1;e>=0;e--){for(var c in b){if(!d[e].ptype){if(d[e] instanceof Ext.ClassManager.get(c)){if(b[c]==="locked"||b[c]==="both"){f.push(d[e])}if(b[c]==="normal"||b[c]==="both"){h.push(new d[e].self())}Ext.Array.remove(d,d[e])}}else{h.push(Ext.clone(d[e]))}}}return{locked:f,normal:h}},processFeatures:function(e){e=e||[];var k=this,c=k.statics().featureCascadeMap,h=e.length,g=[],j=[],a=0,f=0;for(f=h-1;f>=0;f--){for(var d in c){if(e[f].isFeature){if(e[f] instanceof Ext.ClassManager.get(d)){if(c[d]==="locked"||c[d]==="both"){g.push(e[f]);if(e[f] instanceof Ext.grid.feature.Grouping){k.lockedGrouping=e[f]}}if(c[d]==="normal"||c[d]==="both"){var b=new e[f].self();j.push(b);if(b instanceof Ext.grid.feature.Grouping){k.normalGrouping=b}}Ext.Array.remove(e,e[f])}}else{j.push(Ext.clone(e[f]))}}}return{locked:g,normal:j}},injectLockable:function(){var i=this;var f=i.store instanceof Ext.data.TreeStore;var j=i.store.buffered;var g=this.processFeatures(this.features),d=this.processPlugins(this.plugins),c=i.getEventSelectionModel?i.getEventSelectionModel():i.getSelectionModel();i.lockedGridConfig=i.lockedGridConfig||{};i.normalGridConfig=i.schedulerConfig||{};var a=i.lockedGridConfig,h=i.normalGridConfig;Ext.apply(i.lockedGridConfig,{enableLocking:false,lockable:false,useArrows:true,xtype:i.lockedXType,plugins:d.locked,features:g.locked,columnLines:i.columnLines,rowLines:i.rowLines});Ext.apply(i.normalGridConfig,{xtype:i.normalXType,enableLocking:false,lockable:false,sortableColumns:false,enableColumnMove:false,enableColumnResize:false,enableColumnHide:false,selModel:c,_top:i,orientation:i.orientation,viewPreset:i.viewPreset,timeAxis:i.timeAxis,columnLines:i.columnLines,rowLines:i.rowLines,plugins:d.normal,features:g.normal});i.bothCfgCopy=i.bothCfgCopy||[];if(i.orientation==="vertical"){a.store=h.store=i.timeAxis.tickStore;i.resourceStore.on({clear:i.refreshResourceColumns,datachanged:i.refreshResourceColumns,load:i.refreshResourceColumns,scope:i})}if(a.width){i.syncLockedWidth=Ext.emptyFn;a.scroll="horizontal";a.scrollerOwner=true}if(i.resourceStore){h.resourceStore=i.resourceStore}if(i.eventStore){h.eventStore=i.eventStore}if(i.dependencyStore){h.dependencyStore=i.dependencyStore}a.viewConfig=i.lockedViewConfig||{};h.viewConfig=i.normalViewConfig||{};h.viewConfig.enableAnimations=a.viewConfig.enableAnimations=false;var e=i.layout;this.callParent(arguments);if(a.width){i.lockedGrid.setWidth(a.width)}var k=i.lockedGrid.getView();var b=i.normalGrid.getView();k.on("beforerefresh",function(){return b.store.getCount()>0},null,{single:true});b.on("beforerefresh",function(){return b.store.getCount()>0},null,{single:true});if(f){this.setupLockableTree()}else{if(i.lockedGrouping){k.on({groupexpand:this.onLockedViewGroupExpand,groupcollapse:this.onLockedViewGroupCollapse,scope:this});b.on({groupexpand:this.onNormalViewGroupExpand,groupcollapse:this.onNormalViewGroupCollapse,scope:this});k.on({refresh:i.createSpacer,beforerefresh:i.destroySpacer,scope:i})}}i.view.clearListeners();i.view=Ext.create("Sch.view.Locking",{locked:i.lockedGrid,normal:i.normalGrid,panel:i});if(i.syncRowHeight){b.on({itemadd:i.onNormalViewItemAdd,scope:i});if(Ext.isIE9&&Ext.isStrict){i.onNormalViewRefresh=function(){var l=i.normalGrid.getView(),n=l.el,p=n.query(l.getItemSelector()),o=p.length,m=0;i.normalHeights=[];for(;m<o;m++){i.normalHeights[m]=p[m].offsetHeight}i.syncRowHeights()};i.onNormalViewItemUpdate=function(l,m,o){if(i.lockedGridDependsOnSchedule){var n=i.lockedGrid.getView();n.suspendEvents();n.onUpdate(i.lockedGrid.store,l);n.resumeEvents()}var p=i.normalGrid.getView().getNode(m);p.style.height=o.style.height;i.normalHeights[m]=p.offsetHeight;i.syncRowHeights()}}}if(e!=="fit"){i.layout=e}},setupLockableTree:function(){var f;var d;var e=this;var g=e.store.buffered;var j=e.lockedGrid.getView();var b=e.normalGrid.getView();var h=b.store;var a=e.store;var i=function(o,n){var l=a.pageSize||50;var k=h.prefetchData.getCount();if(k){var m=n-o+1;if(m<l&&k>=m){n=o+l-1}if(n>=k){o=k-(n-o);n=k-1;o=Math.max(0,o)}h.guaranteeRange(o,n)}};a.on("root-fill-start",function(){d=true;h.suspendEvents();if(g){f=h.node;h.setNode()}});a.on("root-fill-end",function(){d=false;if(g){h.refreshFromTree();h.resumeEvents();i(0,(a.pageSize||50)-1);e.getView().refresh()}else{h.resumeEvents();e.getView().refresh()}});if(g){h.on("bufferchange",function(){e.getView().refresh()});var c=function(){if(d){return}h.refreshFromTree();var l=h.guaranteedStart,k=h.guaranteedEnd;delete h.guaranteedStart;delete h.guaranteedEnd;i(l,k);e.getView().refresh()};a.on({append:c,insert:c,remove:c,move:c,expand:c,collapse:c,sort:c,buffer:1})}a.on("filter",function(l,k){h.filter.apply(h,k);e.getView().refresh()});a.on("clearfilter",function(k){h.clearFilter();e.getView().refresh()});a.on("beforecascade",function(k){h.suspendEvents()});a.on("cascade",function(l,k){h.resumeEvents();if(k.nbrAffected>0){e.getSchedulingView().refreshKeepingScroll()}});j.store.destroyStore();j.bindStore(b.store);if(g&&e.normalGrid.verticalScroller){e.normalGrid.verticalScroller.store=j.store}},onNormalViewItemUpdate:function(a,b,d){if(this.lockedGridDependsOnSchedule){var c=this.lockedGrid.getView();c.suspendEvents();c.onUpdate(this.lockedGrid.store,a);c.resumeEvents()}var e=this.normalGrid.getView().getNode(b);e.style.height=d.style.height;this.normalHeights[b]=e.clientHeight;this.syncRowHeights()},onNormalViewItemAdd:function(c,d,b){var a=this.normalHeights;var e=this.lockedGrid.getView();Ext.each(c,function(g,f){a[e.getNode(g).viewIndex]=b[f].offsetHeight});this.syncRowHeights()},processColumns:function(b){var a=this.callParent(arguments);var c=[];Ext.each(b,function(d){if(d.position=="right"){d.processed=true;if(!Ext.isNumber(d.width)){Ext.Error.raise('"Right" columns must have a fixed width')}c.push(d);Ext.Array.remove(a.locked.items,d);a.lockedWidth-=d.width}});if(this.orientation==="horizontal"){a.normal.items=[{xtype:"timeaxiscolumn",timeAxis:this.timeAxis,timeCellRenderer:this.timeCellRenderer,timeCellRendererScope:this.timeCellRendererScope}].concat(c)}else{a.locked.items=[Ext.apply({xtype:"verticaltimeaxis",width:100,timeAxis:this.timeAxis},this.timeAxisColumnCfg||{})];a.lockedWidth=a.locked.items[0].width}return a},onNormalViewRefresh:function(){this.lockedGrid.getView().refresh();var f=this,a=f.normalGrid.getView(),d=a.el,g=d.query(a.getItemSelector()),e=g.length,b=0;f.normalHeights=[];for(;b<e;b++){var c=g[b].style.height;if(c){f.normalHeights[b]=c.substring(0,c.length-2)}}f.syncRowHeights()},syncRowHeights:function(){var h=this,b=h.lockedHeights,j=h.normalHeights,a=[],g=b.length||j.length,e=0,l,c,d,f;if(b.length||j.length){l=h.lockedGrid.getView();c=h.normalGrid.getView();if(!l.rendered||!c.rendered){return}d=l.el.query(l.getItemSelector());if(!d.length){return}var k=(Ext.isIE6||Ext.isIE7)&&Ext.isStrict?2:0;for(;e<g;e++){if(!isNaN(j[e])){Ext.fly(d[e]).setHeight(j[e]-k)}}h.lockedHeights=[];h.normalHeights=[]}},getMenuItems:function(){return function(){return Ext.grid.header.Container.prototype.getMenuItems.call(this)}},createSpacer:function(){if(this.lockedGrid.rendered&&this.normalGrid.rendered){this.callParent(arguments)}},onLockedViewGroupExpand:function(a,b){this.normalGrid.view.suspendEvents();this.normalGrouping.expand(b);this.normalGrid.view.resumeEvents()},onLockedViewGroupCollapse:function(a,b){this.normalGrid.view.suspendEvents();this.normalGrouping.collapse(b);this.normalGrid.view.resumeEvents()},onNormalViewGroupExpand:function(a,b){this.lockedGrid.view.suspendEvents();this.lockedGrouping.expand(b);this.lockedGrid.view.resumeEvents()},onNormalViewGroupCollapse:function(a,b){this.lockedGrid.view.suspendEvents();this.lockedGrouping.collapse(b);this.lockedGrid.view.resumeEvents()},applyColumnsState:Ext.emptyFn});Ext.define("Sch.mixin.TimelineView",{requires:["Sch.column.Time","Sch.data.TimeAxis"],orientation:"horizontal",overScheduledEventClass:"sch-event-hover",selectedEventCls:"sch-event-selected",altColCls:"sch-col-alt",timeCellCls:"sch-timetd",timeCellSelector:".sch-timetd",ScheduleEventMap:{click:"Click",dblclick:"DblClick",contextmenu:"ContextMenu",keydown:"KeyDown"},suppressFitCheck:0,forceFit:false,inheritables:function(){return{cellBorderWidth:1,initComponent:function(){this.setOrientation(this.panel._top.orientation||this.orientation);this.addEvents("beforetooltipshow","scheduleclick","scheduledblclick","schedulecontextmenu","columnwidthchange");this.enableBubble("columnwidthchange");var a={},c=Sch.util.Date;a[c.DAY]=a[c.WEEK]=a[c.MONTH]=a[c.QUARTER]=a[c.YEAR]=null;Ext.applyIf(this,{eventPrefix:this.id+"-",largeUnits:a});this.callOverridden(arguments);if(this.orientation==="horizontal"){this.getTimeAxisColumn().on("timeaxiscolumnreconfigured",this.checkHorizontalFit,this)}var b=this.panel._top;Ext.apply(this,{eventRendererScope:b.eventRendererScope,eventRenderer:b.eventRenderer,eventBorderWidth:b.eventBorderWidth,timeAxis:b.timeAxis,dndValidatorFn:b.dndValidatorFn||Ext.emptyFn,resizeValidatorFn:b.resizeValidatorFn||Ext.emptyFn,createValidatorFn:b.createValidatorFn||Ext.emptyFn,tooltipTpl:b.tooltipTpl,validatorFnScope:b.validatorFnScope||this,snapToIncrement:b.snapToIncrement,timeCellRenderer:b.timeCellRenderer,timeCellRendererScope:b.timeCellRendererScope,readOnly:b.readOnly,eventResizeHandles:b.eventResizeHandles,enableEventDragDrop:b.enableEventDragDrop,enableDragCreation:b.enableDragCreation,dragConfig:b.dragConfig,dropConfig:b.dropConfig,resizeConfig:b.resizeConfig,createConfig:b.createConfig,tipCfg:b.tipCfg,orientation:b.orientation,getDateConstraints:b.getDateConstraints||Ext.emptyFn})},onDestroy:function(){if(this.tip){this.tip.destroy()}this.callOverridden(arguments)},afterComponentLayout:function(){this.callOverridden(arguments);var b=this.getWidth();var a=this.getHeight();if(b===this.__prevWidth&&a===this.__prevHeight){return}this.__prevWidth=b;this.__prevHeight=a;if(!this.lockable&&!this.suppressFitCheck){this.checkHorizontalFit()}},beforeRender:function(){this.callOverridden(arguments);this.addCls("sch-timelineview");if(this.readOnly){this.addCls(this._cmpCls+"-readonly")}},afterRender:function(){this.callOverridden(arguments);if(this.overScheduledEventClass){this.mon(this.el,{mouseover:this.onMouseOver,mouseout:this.onMouseOut,delegate:this.eventSelector,scope:this})}if(this.tooltipTpl){this.el.on("mousemove",this.setupTooltip,this,{single:true})}this.setupTimeCellEvents()},processUIEvent:function(f){var c=this,a=f.getTarget(this.eventSelector),d=c.ScheduleEventMap,b=f.type;if(a&&b in d){this.fireEvent(this.scheduledEventName+b,this,this.resolveEventRecord(a),f)}else{this.callOverridden(arguments)}},onMouseOver:function(b,a){if(a!==this.lastItem){this.lastItem=a;Ext.fly(a).addCls(this.overScheduledEventClass)}},onMouseOut:function(b,a){if(this.lastItem){if(!b.within(this.lastItem,true,true)){Ext.fly(this.lastItem).removeCls(this.overScheduledEventClass);delete this.lastItem}}},highlightItem:function(b){if(b){var a=this;a.clearHighlight();a.highlightedItem=b;Ext.fly(b).addCls(a.overItemCls)}}}},hasRightColumns:function(){return this.headerCt.items.getCount()>1},checkHorizontalFit:function(){if(this.orientation==="horizontal"){var a=this.getActualTimeColumnWidth();var c=this.getFittingColumnWidth();if(this.forceFit){if(c!=a){this.fitColumns()}}else{if(this.snapToIncrement){var b=this.calculateTimeColumnWidth(a);if(b!==a){this.setColumnWidth(b)}}else{if(a<c){this.fitColumns()}}}}},getTimeAxisColumn:function(){return this.headerCt.items.get(0)},getNumberOfTimeColumns:function(){return this.timeAxis.getCount()},getFirstTimeColumn:function(){return this.headerCt.getGridColumns()[0]},getFormattedDate:function(a){return Ext.Date.format(a,this.getDisplayDateFormat())},getFormattedEndDate:function(d,a){var b=this.timeAxis,c=b.getResolution().unit;if(c in this.largeUnits&&d.getHours()===0&&d.getMinutes()===0&&!(d.getYear()===a.getYear()&&d.getMonth()===a.getMonth()&&d.getDate()===a.getDate())){d=Sch.util.Date.add(d,Sch.util.Date.DAY,-1)}return Ext.Date.format(d,this.getDisplayDateFormat())},getDisplayDateFormat:function(){return this.displayDateFormat},setDisplayDateFormat:function(a){this.displayDateFormat=a},getSingleUnitInPixels:function(a){return Sch.util.Date.getUnitToBaseUnitRatio(this.timeAxis.getUnit(),a)*this.getSingleTickInPixels()},getSingleTickInPixels:function(){throw"Must be implemented by horizontal/vertical"},scrollEventIntoView:function(c,a){var b=this.getOuterElementFromEventRecord(c);if(b){b.scrollIntoView(this.el);if(a){if(typeof a==="boolean"){b.highlight()}else{b.highlight(null,a)}}}},calculateTimeColumnWidth:function(e){if(!this.panel.rendered){return e}var b=0,d=this.timeAxis.getUnit(),j=this.timeAxis.getCount(),g=Number.MAX_VALUE;if(this.snapToIncrement){var h=this.timeAxis.getResolution(),i=h.unit,c=h.increment;g=Sch.util.Date.getUnitToBaseUnitRatio(d,i)*c}var f=Sch.util.Date.getMeasuringUnit(d);g=Math.min(g,Sch.util.Date.getUnitToBaseUnitRatio(d,f));var a=Math.floor(this.getAvailableWidthForSchedule()/j);b=this.forceFit||e<a?a:e;if(!this.forceFit||g<1){b=Math.round(Math.max(1,Math[this.forceFit?"floor":"round"](g*b))/g)}return b},getFittingColumnWidth:function(){var a=Math.floor(this.getAvailableWidthForSchedule()/this.getNumberOfTimeColumns());return this.calculateTimeColumnWidth(a)},fitColumns:function(b){var a=0;if(this.orientation==="horizontal"){a=this.getFittingColumnWidth()}else{a=Math.floor((this.panel.getWidth()-Ext.getScrollbarSize().width-1)/this.headerCt.getColumnCount())}this.setColumnWidth(a,b)},getAvailableWidthForSchedule:function(){var c=this.lastBox.width;var a=this.headerCt.items.items;for(var b=1;b<a.length;b++){c-=a[b].getWidth()}return c-Ext.getScrollbarSize().width-1},getRightColumnsWidth:function(){var c=0;var a=this.headerCt.items.items;for(var b=1;b<a.length;b++){c+=a[b].getWidth()}return c},fixRightColumnsPositions:function(){var a=this.headerCt.items.items;var c=a[0].getWidth();for(var b=1;b<a.length;b++){var d=a[b];d.el.setLeft(c);c+=d.getWidth()}},getElementFromEventRecord:function(a){return Ext.get(this.eventPrefix+a.internalId)},getEventNodeByRecord:function(a){return document.getElementById(this.eventPrefix+a.internalId)},getOuterElementFromEventRecord:function(a){return Ext.get(this.eventPrefix+a.internalId)},resolveColumnIndex:function(a){return Math.floor(a/this.getActualTimeColumnWidth())},getStartEndDatesFromRegion:function(b,a){throw"Must be implemented by horizontal/vertical"},setupTooltip:function(){var b=this,a=Ext.apply({renderTo:Ext.getBody(),delegate:b.eventSelector,target:b.el,anchor:"b"},b.tipCfg);b.tip=Ext.create("Ext.ToolTip",a);b.tip.on({beforeshow:function(d){if(!d.triggerElement||!d.triggerElement.id){return false}var c=this.resolveEventRecord(d.triggerElement);if(!c||this.fireEvent("beforetooltipshow",this,c)===false){return false}d.update(this.tooltipTpl.apply(this.getDataForTooltipTpl(c)));return true},scope:this})},getDataForTooltipTpl:function(a){return a.data},getTimeResolution:function(){return this.timeAxis.getResolution()},setTimeResolution:function(b,a){this.timeAxis.setResolution(b,a);if(this.snapToIncrement){this.refresh(true)}},getEventIdFromDomNodeId:function(a){return a.substring(this.eventPrefix.length)},getDateFromDomEvent:function(b,a){return this.getDateFromXY(b.getXY(),a)},handleScheduleEvent:function(c){var b=c.getTarget("."+this.timeCellCls,2);if(b){var a=this.getDateFromDomEvent(c,"floor");this.fireEvent("schedule"+c.type,this,a,this.indexOf(this.findItemByChild(b)),c)}},setupTimeCellEvents:function(){this.mon(this.el,{click:this.handleScheduleEvent,dblclick:this.handleScheduleEvent,contextmenu:this.handleScheduleEvent,scope:this},this)},getSnapPixelAmount:function(){if(this.snapToIncrement){var a=this.timeAxis.getResolution();return(a.increment||1)*this.getSingleUnitInPixels(a.unit)}else{return 1}},getActualTimeColumnWidth:function(){return this.headerCt.items.get(0).getTimeColumnWidth()},setSnapEnabled:function(a){this.snapToIncrement=a;if(a){this.refresh(true)}},setReadOnly:function(a){this.readOnly=a;this[a?"addCls":"removeCls"](this._cmpCls+"-readonly")},isReadOnly:function(){return this.readOnly},setOrientation:function(a){this.orientation=a;Ext.apply(this,Sch.view[Ext.String.capitalize(a)].prototype.props)},getOrientation:function(){return this.orientation},translateToScheduleCoordinate:function(a){throw"Abstract method call!"},translateToPageCoordinate:function(a){throw"Abstract method call!"},getDateFromXY:function(b,a){throw"Abstract method call!"},getXYFromDate:function(a,b){throw"Abstract method call!"},getTimeSpanRegion:function(a,b){throw"Abstract method call!"},getStart:function(){return this.timeAxis.getStart()},getEnd:function(){return this.timeAxis.getEnd()},setBarMargin:function(b,a){this.barMargin=b;if(!a){this.refresh()}},setRowHeight:function(a,b){this.rowHeight=a||24;if(this.rendered&&!b){this.refresh()}},refreshKeepingScroll:function(){this.saveScrollState();this.refresh();this.restoreScrollState()}});Ext.apply(Sch,{});Ext.define("Sch.view.Horizontal",{props:{translateToScheduleCoordinate:function(a){return a-this.el.getX()+this.el.getScroll().left},translateToPageCoordinate:function(a){return a+this.el.getX()-this.el.getScroll().left},getDateFromXY:function(g,e){var b,a=this.translateToScheduleCoordinate(g[0]),d=a/this.getActualTimeColumnWidth(),c=this.headerCt.getColumnCount();if(d<0||d>c){b=null}else{var f=d-this.resolveColumnIndex(a);if(f>2&&d>=c){return null}b=this.timeAxis.getDateFromTick(d,e)}return b},getXYFromDate:function(b,d){var a,c=this.timeAxis.getTickFromDate(b);if(c>=0){a=this.getActualTimeColumnWidth()*c}if(d===false){a=this.translateToPageCoordinate(a)}return[a,0]},getEventBox:function(e,b){var a=Math.floor(this.getXYFromDate(e)[0]),c=Math.floor(this.getXYFromDate(b)[0]),d=Math;if(this.managedEventSizing){return{top:Math.max(0,(this.barMargin-(Ext.isIE&&!Ext.isStrict)?0:this.eventBorderWidth-this.cellBorderWidth)),left:d.min(a,c),width:d.max(1,d.abs(a-c)),height:this.rowHeight-(2*this.barMargin)-this.eventBorderWidth}}return{left:d.min(a,c),width:d.max(1,d.abs(a-c))}},layoutEvents:function(a){var c=Ext.Array.clone(a);c.sort(this.sortEvents);var b=this.layoutEventsInBands(0,c);return b},layoutEventsInBands:function(d,a){var c=a[0],b=d===0?this.barMargin:(d*this.rowHeight-((d-1)*this.barMargin));if(b>=this.cellBorderWidth){b-=this.cellBorderWidth}while(c){c.top=b;Ext.Array.remove(a,c);c=this.findClosestSuccessor(c,a)}d++;if(a.length>0){return this.layoutEventsInBands(d,a)}else{return d}},getScheduleRegion:function(d,f){var h=d?Ext.fly(this.getNodeByRecord(d)).getRegion():this.el.down(".x-grid-table").getRegion(),e=this.timeAxis.getStart(),j=this.timeAxis.getEnd(),b=this.getDateConstraints(d,f)||{start:e,end:j},c=this.translateToPageCoordinate(this.getXYFromDate(b.start)[0]),i=this.translateToPageCoordinate(this.getXYFromDate(b.end)[0]),g=h.top+this.barMargin,a=(d?(g+this.rowHeight-this.barMargin):h.bottom)-this.barMargin;return new Ext.util.Region(g,Math.max(c,i),a,Math.min(c,i))},collectRowData:function(g,p,o){var c=p.getEvents();if(c.length===0||this.headerCt.getColumnCount()===0){g.rowHeight=this.rowHeight;return g}var a=Sch.util.Date,m=this.timeAxis,n=m.getStart(),r=m.getEnd(),k=[],j,f;for(j=0,f=c.length;j<f;j++){var b=c[j],d=b.getStartDate(),h=b.getEndDate();if(d&&h&&m.timeSpanInAxis(d,h)){var q=this.generateTplData(b,n,r,p,o);k[k.length]=q}}var e=1;if(this.dynamicRowHeight){e=this.layoutEvents(k)}g.rowHeight=(e*this.rowHeight)-((e-1)*this.barMargin);g[this.getFirstTimeColumn().id]+="&#160;"+this.eventTpl.apply(k);return g},resolveResource:function(a){var b=this.findItemByChild(a);if(b){return this.getRecord(b)}return null},getTimeSpanRegion:function(b,f){var d=this.getXYFromDate(b)[0],e=this.getXYFromDate(f||b)[0],c=this.el.down(".x-grid-table"),a=(c||this.el).dom.clientHeight;return new Ext.util.Region(0,Math.max(d,e),a,Math.min(d,e))},getStartEndDatesFromRegion:function(c,b){var a=this.getDateFromXY([c.left,c.top],b),d=this.getDateFromXY([c.right,c.bottom],b);if(d&&a){return{start:Sch.util.Date.min(a,d),end:Sch.util.Date.max(a,d)}}else{return null}},onEventAdd:function(c,e){var d;for(var b=0,a=e.length;b<a;b++){d=e[b].getResource();if(d){this.onUpdate(this.resourceStore,d)}}},onEventRemove:function(c,a){var b=this.getElementFromEventRecord(a);if(b){var d=this.resolveResource(b);b.fadeOut({callback:function(){if(this.resourceStore.indexOf(d)>=0){this.onUpdate(this.resourceStore,d)}},scope:this})}},onEventUpdate:function(b,c,a){var e,d=c.previous;if(d&&d[c.resourceIdField]){e=c.getResource(d[c.resourceIdField]);if(e){this.onUpdate(this.resourceStore,e)}}e=c.getResource();if(e){this.onUpdate(this.resourceStore,e)}},getSingleTickInPixels:function(){return this.getActualTimeColumnWidth()},setColumnWidth:function(b,a){if(this.getTimeAxisColumn()){this.getTimeAxisColumn().setTimeColumnWidth(b);this.columnWidth=b;if(!a){this.refresh()}}this.fireEvent("columnwidthchange",this,b)},getVisibleDateRange:function(){if(!this.rendered){return null}var b=this.getEl().getScroll(),a=this.panel.getStart(),g=this.panel.getEnd(),e=this.getWidth();var c=Ext.query(".x-grid-table",this.getEl().dom)[0];if(c.clientWidth<e){return{startDate:a,endDate:g}}var f=this.getSingleTickInPixels();var d=this.timeAxis.getUnit();return{startDate:Sch.util.Date.add(a,d,b.left/f),endDate:Sch.util.Date.add(a,d,b.left/f+e/f)}}}});Ext.define("Sch.view.TimelineTreeView",{extend:"Ext.tree.View",mixins:["Sch.mixin.TimelineView"],resetScrollersTimeoutId:null,cellBorderWidth:0,beforeRender:function(){this.addCls("sch-timelinetreeview");this.callOverridden(arguments)},attachStore:function(a){var b=this;b.store=a;b.store.on({beforeexpand:b.onBeforeExpand,expand:b.onExpand,beforecollapse:b.onBeforeCollapse,collapse:b.onCollapse,write:b.onStoreWrite,datachanged:b.onStoreDataChanged,scope:b})}},function(){this.override(Sch.mixin.TimelineView.prototype.inheritables()||{})});Ext.define("Sch.mixin.TimelinePanel",{requires:["Sch.util.Patch","Sch.patches.CellEditing","Sch.patches.LoadMask","Sch.patches.TreeStoreIE","Sch.patches.XmlReader","Sch.data.TimeAxis","Sch.view.Locking","Sch.mixin.Lockable","Sch.preset.Manager"],orientation:"horizontal",weekStartDay:1,snapToIncrement:false,readOnly:false,eventResizeHandles:"both",viewPreset:"weekAndDay",startDate:null,endDate:null,eventBorderWidth:1,syncCellHeight:Ext.emptyFn,tooltipTpl:null,tipCfg:{cls:"sch-tip",showDelay:1000,hideDelay:0,autoHide:true,anchor:"b"},inheritables:function(){return{columnLines:true,enableColumnMove:false,enableLocking:true,lockable:true,lockedXType:null,normalXType:null,initComponent:function(){this.addEvents("timeheaderdblclick","beforeviewchange","viewchange");if(!this.timeAxis){this.timeAxis=Ext.create("Sch.data.TimeAxis")}if(!this.columns&&!this.colModel){this.columns=[]}if(this.enableLocking){this.self.mixin("lockable",Sch.mixin.Lockable);var b=0,a=this.columns.length,c;for(;b<a;++b){c=this.columns[b];if(c.locked!==false){c.locked=true}}this.timeAxis.on("reconfigure",this.onTimeAxisReconfigure,this);this.switchViewPreset(this.viewPreset,this.startDate,this.endDate,true)}this.callOverridden(arguments);if(this.lockable){this.applyViewSettings(this.timeAxis.preset);if(!this.viewPreset){throw"You must define a valid view preset object. See Sch.preset.Manager class for reference"}}this.relayEvents(this.getView(),["beforetooltipshow","scheduleclick","scheduledblclick","schedulecontextmenu"])},initStateEvents:function(){this.stateEvents.push("viewchange");this.callOverridden()},getState:function(){var a=this,b=a.callParent(arguments);Ext.apply(b,{viewPreset:a.viewPreset,startDate:a.getStart(),endDate:a.getEnd()});return b},applyState:function(b){var a=this;a.callOverridden(arguments);if(b&&b.viewPreset){a.switchViewPreset(b.viewPreset,b.startDate,b.endDate)}},beforeRender:function(){this.callOverridden(arguments);if(this.lockable){this.addCls("sch-"+this.orientation)}},afterRender:function(){this.callOverridden(arguments);if(this.lockable){this.lockedGrid.on("itemdblclick",function(d,c,e,g,f){if(this.orientation=="vertical"&&c){this.fireEvent("timeheaderdblclick",this,c.get("start"),c.get("end"),g,f)}},this)}else{var b=this.headerCt;if(b&&b.reorderer&&b.reorderer.dropZone){var a=b.reorderer.dropZone;a.positionIndicator=Ext.Function.createSequence(a.positionIndicator,function(){this.valid=false})}}},delayScroll:function(){var a=this.getScrollTarget().el;if(a){this.scrollTask.delay(10,function(){if(a.dom){this.syncHorizontalScroll(a.dom.scrollLeft)}},this)}}}},setReadOnly:function(a){this.getSchedulingView().setReadOnly(a)},isReadOnly:function(){return this.getSchedulingView().isReadOnly()},switchViewPreset:function(d,a,g,b){if(this.fireEvent("beforeviewchange",this,d,a,g)!==false){if(Ext.isString(d)){this.viewPreset=d;d=Sch.preset.Manager.getPreset(d)}if(!d){throw"View preset not found"}var f=d.headerConfig;var c={unit:f.bottom?f.bottom.unit:f.middle.unit,increment:(f.bottom?f.bottom.increment:f.middle.increment)||1,resolutionUnit:d.timeResolution.unit,resolutionIncrement:d.timeResolution.increment,weekStartDay:this.weekStartDay,mainUnit:f.middle.unit,shiftUnit:d.shiftUnit,headerConfig:d.headerConfig,shiftIncrement:d.shiftIncrement||1,preset:d,defaultSpan:d.defaultSpan||1};if(b){c.start=a||new Date();c.end=g}else{c.start=a||this.timeAxis.getStart();c.end=g}var e=this.normalGrid;if(e&&e.headerCt){e.headerCt.on("afterlayout",function(){var i=this.lockedGrid.headerCt;var h=e.headerCt;i.setSize(i.lastBox.width,h.lastBox.height)},this,{single:true})}if(!b){this.applyViewSettings(d)}this.timeAxis.reconfigure(c)}},applyViewSettings:function(b){var a=this.getSchedulingView();a.setDisplayDateFormat(b.displayDateFormat);if(this.orientation==="horizontal"){a.setRowHeight(this.rowHeight||b.rowHeight,true)}},getStart:function(){return this.timeAxis.getStart()},getEnd:function(){return this.timeAxis.getEnd()},setTimeColumnWidth:function(b,a){this.getSchedulingView().setColumnWidth(b,a)},onTimeAxisReconfigure:function(){this.fireEvent("viewchange",this)},shiftNext:function(a){this.timeAxis.shiftNext(a)},shiftPrevious:function(a){this.timeAxis.shiftPrevious(a)},goToNow:function(){this.setTimeSpan(new Date())},setTimeSpan:function(b,a){if(this.timeAxis){this.timeAxis.setTimeSpan(b,a)}},setStart:function(a){this.setTimeSpan(a)},setEnd:function(a){this.setTimeSpan(null,a)},getTimeAxis:function(){return this.timeAxis},getResourceByEventRecord:function(a){return a.getResource()},scrollToDate:function(c,b){var a=this.getSchedulingView();var d=a.getXYFromDate(c,true);if(this.orientation=="horizontal"){a.getEl().scrollTo("left",Math.max(0,d[0]),b)}else{a.getEl().scrollTo("top",Math.max(0,d[1]),b)}},getSchedulingView:function(){return this.lockable?this.normalGrid.getView():this.getView()},timeCellRenderer:null,timeCellRendererScope:null,setOrientation:function(a){this.removeCls("sch-"+this.orientation);this.addCls("sch-"+a);this.orientation=a}});Ext.define("Sch.panel.TimelineTreePanel",{extend:"Ext.tree.Panel",requires:["Ext.data.TreeStore"],mixins:["Sch.mixin.TimelinePanel"],useArrows:true,rootVisible:false,constructor:function(a){a=a||{};a.animate=false;this.callParent(arguments)},initComponent:function(){this.callParent(arguments);if(this.lockable&&this.lockedGrid.headerCt.query("treecolumn").length===0){Ext.Error.raise("You must define an Ext.tree.Column (or use xtype : 'treecolumn').")}},onRootChange:function(a){if(!this.lockable){this.callOverridden(arguments)}}},function(){this.override(Sch.mixin.TimelinePanel.prototype.inheritables()||{})});Ext.define("Sch.plugin.Printable",{docType:'<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">',printableEventTpl:null,beforePrint:Ext.emptyFn,afterPrint:Ext.emptyFn,autoPrintAndClose:true,scheduler:null,constructor:function(a){Ext.apply(this,a)},init:function(a){this.scheduler=a;a.print=Ext.Function.bind(this.print,this)},mainTpl:'{docType}<html class="x-border-box {htmlClasses}"><head><meta content="text/html; charset=UTF-8" http-equiv="Content-Type" /><title>{title}</title>{styles}</head><body class="sch-print-body {bodyClasses}"><div class="sch-print-ct {componentClasses}" style="width:{totalWidth}px"><div class="sch-print-headerbg" style="border-left-width:{totalWidth}px;height:{headerHeight}px;"></div><div class="sch-print-header-wrap"><div class="sch-print-lockedheader x-grid-header-ct x-grid-header-ct-default x-docked x-docked-top x-grid-header-ct-docked-top x-grid-header-ct-default-docked-top x-box-layout-ct x-docked-noborder-top x-docked-noborder-right x-docked-noborder-left">{lockedHeader}</div><div style="left:{lockedWidth}px" class="sch-print-normalheader x-grid-header-ct x-grid-header-ct-default x-docked x-docked-top x-grid-header-ct-docked-top x-grid-header-ct-default-docked-top x-box-layout-ct x-docked-noborder-top x-docked-noborder-right x-docked-noborder-left">{normalHeader}</div></div><div id="lockedRowsCt" style="width:{lockedWidth}px;top:{headerHeight}px;" class="sch-print-locked-rows-ct {innerLockedClasses} x-grid-inner-locked">{lockedRows}</div><div id="normalRowsCt" style="left:{[Ext.isIE ? values.lockedWidth : 0]}px;top:{headerHeight}px;width:{normalWidth}px" class="sch-print-normal-rows-ct {innerNormalClasses}">{normalRows}</div></div><script type="text/javascript">{setupScript}<\/script></body></html>',getGridContent:function(h){var g=h.normalGrid,c=h.lockedGrid,i=c.getView(),d=g.getView(),e,b,f;this.beforePrint(h);var a=i.store.getRange();b=i.tpl.apply(i.collectData(a,0));f=d.tpl.apply(d.collectData(a,0));this.afterPrint(h);return{normalHeader:g.headerCt.el.dom.innerHTML,lockedHeader:c.headerCt.el.dom.innerHTML,lockedRows:b,normalRows:f,lockedWidth:c.getWidth(),normalWidth:g.getWidth(),headerHeight:g.headerCt.getHeight(),innerLockedClasses:c.view.el.dom.className,innerNormalClasses:g.view.el.dom.className,width:h.getWidth()}},getStylesheets:function(){return Ext.getDoc().select('link[rel="stylesheet"]')},print:function(){var g=this.scheduler;if(!(this.mainTpl instanceof Ext.Template)){var a=22;this.mainTpl=Ext.create("Ext.XTemplate",this.mainTpl,{compiled:true,disableFormats:true})}var h=g.getView(),i=this.getStylesheets(),e=Ext.get(Ext.core.DomHelper.createDom({tag:"div"})),b;i.each(function(j){e.appendChild(j.dom.cloneNode(true))});b=e.dom.innerHTML+"";var f=this.getGridContent(g),c=this.mainTpl.apply(Ext.apply({waitText:this.waitText,docType:this.docType,htmlClasses:"",bodyClasses:Ext.getBody().dom.className,componentClasses:g.el.dom.className,title:(g.title||""),styles:b,totalWidth:g.getWidth(),setupScript:"("+this.setupScript.toString()+")();"},f));var d=window.open("","printgrid");d.document.write(c);d.document.close();if(this.autoPrintAndClose){d.print();if(!Ext.isChrome){d.close()}}},setupScript:function(){var f=document.getElementById("lockedRowsCt"),d=document.getElementById("normalRowsCt"),b=f.getElementsByTagName("tr"),a=d.getElementsByTagName("tr"),e=a.length,c=0;for(;c<e;c++){b[c].style.height=a[c].style.height}}});Ext.define("Sch.plugin.TreeCellEditing",{extend:"Ext.grid.plugin.CellEditing",startEditByClick:function(c,a,h,b,g,d,f){if(f.getTarget(c.expanderSelector)){return}this.callParent(arguments)},startEdit:function(a,f){if(!a||!f){return}var d=this,b=d.getEditor(a,f),e=a.get(f.dataIndex),c=d.getEditingContext(a,f);a=c.record;f=c.column;d.completeEdit();if(f&&!f.getEditor(a)){return false}if(b){c.originalValue=c.value=e;if(d.beforeEdit(c)===false||d.fireEvent("beforeedit",c)===false||c.cancel){return false}d.context=c;d.setActiveEditor(b);d.setActiveRecord(a);d.setActiveColumn(f);d.grid.view.focusCell({column:c.colIdx,row:c.rowIdx});d.editTask.delay(15,b.startEdit,b,[d.getCell(a,f),c.value,c])}else{d.grid.getView().getEl(f).focus((Ext.isWebKit||Ext.isIE)?10:false)}},getEditingContext:function(e,c){var f=this,a=f.grid,i=a.store,b,d,g=a.getView(),h;if(Ext.isNumber(e)){b=e;e=i.getAt(b)}else{if(i.indexOf){b=i.indexOf(e)}else{b=g.indexOf(g.getNode(e))}}if(Ext.isNumber(c)){d=c;c=a.headerCt.getHeaderAtIndex(d)}else{d=c.getIndex()}h=e.get(c.dataIndex);return{grid:a,record:e,field:c.dataIndex,value:h,row:g.getNode(b),column:c,rowIdx:b,colIdx:d}},startEditByPosition:function(a){var f=this,d=f.grid,h=d.getSelectionModel(),b=f.view,e=this.view.getNode(a.row),g=d.headerCt.getHeaderAtIndex(a.column),c=b.getRecord(e);if(h.selectByPosition){h.selectByPosition(a)}f.startEdit(c,g)}});Ext.define("Sch.scroller.Paging",{extend:"Ext.grid.PagingScroller",alias:"widget.schpagingscroller",percentageFromEdge:0.35,scrollToLoadBuffer:200,activePrefetch:true,chunkSize:50,snapIncrement:1,syncScroll:true,initComponent:function(){var a=this,b=a.store;b.on("guaranteedrange",this.onGuaranteedRange,this);this.callParent(arguments)},onGuaranteedRange:function(c,f,a){var d=this,e=d.store,b;if(c.length&&d.visibleStart<c[0].index){return}e.loadRecords(c);e.fireEvent("bufferchange",e,c,f,a,this);if(!d.firstLoad){if(d.rendered){d.invalidate()}else{d.on("afterrender",this.invalidate,this,{single:true})}d.firstLoad=true}else{d.syncTo()}},syncTo:function(){if(!this.rendered){return}var h=this,b=h.getPanel(),i=this.store,g=this.scrollEl.dom,d=h.visibleStart-i.guaranteedStart,c=d*h.rowHeight,j=g.scrollHeight,e=g.clientHeight,a=g.scrollTop,f;if(Ext.isIE9&&Ext.isStrict){e=g.offsetHeight+2}f=(j-e-a<=0);this.setViewScrollTop(c,f)},getPageData:function(){var b=this.getPanel(),c=this.store,a=c.getTotalCount();return{total:a,currentPage:c.currentPage,pageCount:Math.ceil(a/c.pageSize),fromRecord:((c.currentPage-1)*c.pageSize)+1,toRecord:Math.min(c.currentPage*c.pageSize,a)}},onElScroll:function(v,l){var x=this,j=x.getPanel(),g=this.store,w=g.pageSize,c=g.guaranteedStart,s=g.guaranteedEnd,r=g.getTotalCount(),i=Math.ceil(x.percentageFromEdge*g.pageSize),y=l.scrollTop,f=Math.floor(y/x.rowHeight),k=j.down("tableview"),h=k.el,m=h.getHeight(),b=Math.ceil(m/x.rowHeight),a=f+b,d=Math.floor(f/g.pageSize),p=Math.floor(a/g.pageSize)+2,u=Math.ceil(r/g.pageSize),q=Math.floor(f/x.snapIncrement)*x.snapIncrement,n=q+w-1,o=x.activePrefetch;x.visibleStart=f;x.visibleEnd=a;x.syncScroll=true;if(r>=w){if(n>r-1){this.cancelLoad();if(g.rangeSatisfied(r-w,r-1)){x.syncScroll=true}g.guaranteeRange(r-w,r-1)}else{if(f<c||a>s){if(g.rangeSatisfied(q,n)){this.cancelLoad();delete g.guaranteedStart;delete g.guaranteedEnd;g.guaranteeRange(q,n)}else{g.mask();x.attemptLoad(q,n)}x.syncScroll=false}else{if(o&&f<(c+i)&&d>0){x.syncScroll=true;g.prefetchPage(d)}else{if(o&&a>(s-i)&&p<u){x.syncScroll=true;g.prefetchPage(p)}}}}}if(x.syncScroll){x.syncTo()}},getSizeCalculation:function(){var b=this.ownerGrid,d=b.getView(),e=this.store,g=this.dock,c=this.el.dom,f=1,a=1;if(!this.rowHeight){var h=d.el.down(d.getItemSelector());if(h){this.rowHeight=h.getHeight(false,true)}else{return{width:1,height:1}}}a=e[(!e.remoteFilter&&e.isFiltered())?"getCount":"getTotalCount"]()*this.rowHeight;if(isNaN(f)){f=1}if(isNaN(a)){a=1}return{width:f,height:a}},attemptLoad:function(c,a){var b=this;if(!b.loadTask){b.loadTask=Ext.create("Ext.util.DelayedTask",b.doAttemptLoad,b,[])}b.loadTask.delay(b.scrollToLoadBuffer,b.doAttemptLoad,b,[c,a])},cancelLoad:function(){if(this.loadTask){this.loadTask.cancel()}},doAttemptLoad:function(c,a){var b=this.store;b.guaranteeRange(c,a)},setViewScrollTop:function(c,d){var b=this.getPanel(),l=b.query("tableview"),f=0,h=l.length,a,e,g,k,j=this.el.dom;var m=this.store;b.virtualScrollTop=c;a=l[1]||l[0];e=a.el.dom;k=((m.pageSize*this.rowHeight)-e.clientHeight);g=(c%((m.pageSize*this.rowHeight)+1));if(d){g=k}if(g>k){return}for(;f<h;f++){l[f].el.dom.scrollTop=g}}});Ext.define("Sch.plugin.CurrentTimeLine",{extend:"Sch.plugin.Lines",tooltipText:"Current time",updateInterval:60000,autoUpdate:true,init:function(c){var b=Ext.create("Ext.data.JsonStore",{model:Ext.define("TimeLineEvent",{extend:"Ext.data.Model",fields:["Date","Cls","Text"]}),data:[{Date:new Date(),Cls:"sch-todayLine",Text:this.tooltipText}]});var a=b.first();if(this.autoUpdate){this.runner=Ext.create("Ext.util.TaskRunner");this.runner.start({run:function(){a.set("Date",new Date())},interval:this.updateInterval})}c.on("destroy",this.onHostDestroy,this);this.store=b;this.callParent(arguments)},onHostDestroy:function(){if(this.runner){this.runner.stopAll()}if(this.store.autoDestroy){this.store.destroy()}}});Ext.define("Gnt.model.CalendarDay",{requires:["Ext.data.Types"],extend:"Sch.model.Customizable",idProperty:"Id",_defaultFields_:[{name:"Date",type:"date",dateFormat:"c",convert:function(b,a){var c=Ext.data.Types.DATE.convert.call(this,b);Ext.Date.clearTime(c);a.data[a.idProperty]=c-0;return c}},{name:"Id"},{name:"IsWorkingDay",type:"boolean",defaultValue:false},{name:"Cls",defaultValue:"gnt-holiday"},"Name",{name:"Availability",convert:function(b,a){if(b){return Ext.typeOf(b)=="string"?[b]:b}else{return[]}}}],availability:null,dateField:"Date",isWorkingDayField:"IsWorkingDay",clsField:"Cls",nameField:"Name",availabilityField:"Availability",setDate:function(a){this.set(this.dateField,Ext.Date.clearTime(a,true))},getAvailability:function(b){var c=this;if(this.availability){return this.availability}var a=[];Ext.Array.each(this.get(this.availabilityField),function(d){a.push(Ext.typeOf(d)=="string"?c.parseInterval(d):d)});this.verifyAvailability(a);return this.availability=a},setAvailability:function(a){this.availability=null;this.set(this.availabilityField,this.stringifyIntervals(a))},verifyAvailability:function(b){b.sort(function(f,e){return f.startTime-e.startTime});Ext.Array.each(b,function(e){if(e.startTime>e.endTime){throw"Start time is greater than end time"}});for(var a=1;a<b.length;a++){var c=b[a-1];var d=b[a];if(c.endTime>d.startTime){throw"Availability intervals should not intersect"}}},prependZero:function(a){return a<10?"0"+a:a},stringifyInterval:function(b){var c=b.startTime;var a=b.endTime;return this.prependZero(c.getHours())+":"+this.prependZero(c.getMinutes())+"-"+this.prependZero(a.getHours())+":"+this.prependZero(a.getMinutes())},stringifyIntervals:function(b){var c=this;var a=[];Ext.Array.each(b,function(d){if(Ext.typeOf(d)=="string"){a.push(d)}else{a.push(c.stringifyInterval(d))}});return a},parseInterval:function(b){var a=/(\d\d):(\d\d)-(\d\d):(\d\d)/.exec(b);if(!a){throw"Invalid format for availability string: "+b+". It should have exact format: hh:mm-hh:mm"}return{startTime:new Date(0,0,0,a[1],a[2]),endTime:new Date(0,0,0,a[3],a[4])}},getTotalHours:function(){return this.getTotalMS()/1000/60/60},getTotalMS:function(){var a=0;Ext.Array.each(this.getAvailability(),function(b){a+=b.endTime-b.startTime});return a},addAvailabilityInterval:function(d,b){var a;if(d instanceof Date){a={startTime:d,endTime:b}}else{a=this.parseInterval(d+(b?"-"+b:""))}var c=this.getAvailability().concat(a);this.verifyAvailability(c);this.setAvailability(c)},removeAvailbilityInterval:function(a){var b=this.getAvailability();b.splice(a,1);this.setAvailability(b)},getAvailabilityIntervalsFor:function(d){d=typeof d=="number"?new Date(d):d;var c=d.getFullYear();var e=d.getMonth();var b=d.getDate();var a=[];Ext.Array.each(this.getAvailability(),function(f){var g=f.endTime.getDate();a.push({startDate:new Date(c,e,b,f.startTime.getHours(),f.startTime.getMinutes()),endDate:new Date(c,e,b+(g==1?1:0),f.endTime.getHours(),f.endTime.getMinutes())})});return a},getAvailabilityStartFor:function(b){var a=this.getAvailabilityIntervalsFor(b);if(!a.length){return null}return a[0].startDate},getAvailabilityEndFor:function(b){var a=this.getAvailabilityIntervalsFor(b);if(!a.length){return null}return a[a.length-1].endDate}});Ext.define("Gnt.model.Assignment",{extend:"Sch.model.Customizable",idProperty:"Id",_defaultFields_:[{name:"Id"},{name:"ResourceId"},{name:"TaskId"},{name:"Units",type:"float",defaultValue:100}],resourceIdField:"ResourceId",taskIdField:"TaskId",unitsField:"Units",isPersistable:function(){var a=this.getTask(),b=this.getResource();return a&&!a.phantom&&b&&!b.phantom},getUnits:function(){return Math.max(0,this.get(this.unitsField))},setUnits:function(a){if(a<0){throw"`Units` value for assignment can't be less than 0"}this.set(this.unitsField,a)},getResourceName:function(){return this.stores[0].getResourceStore().getById(this.getResourceId()).getName()},getTask:function(a){return(a||this.stores[0].getTaskStore()).getById(this.getTaskId())},getResource:function(){return this.stores[0].getResourceStore().getByInternalId(this.getResourceId())},getInternalId:function(){return this.getId()||this.internalId}});Ext.define("Gnt.model.Dependency",{extend:"Sch.model.Customizable",inheritableStatics:{Type:{StartToStart:0,StartToEnd:1,EndToStart:2,EndToEnd:3}},idProperty:"Id",_defaultFields_:[{name:"Id"},{name:"From"},{name:"To"},{name:"Type",type:"int",defaultValue:2},{name:"Lag",type:"int",defaultValue:0},{name:"Cls"}],fromField:"From",toField:"To",typeField:"Type",lagField:"Lag",clsField:"Cls",constructor:function(a){this.callParent(arguments);if(a){if(a.fromTask){if(a.fromTask instanceof Gnt.model.Task){this.setSourceTask(a.fromTask)}else{this.setSourceId(a.fromTask)}}if(a.toTask){if(a.toTask instanceof Gnt.model.Task){this.setTargetTask(a.toTask)}else{this.setTargetId(a.toTask)}}if(Ext.isDefined(a.type)){this.setType(a.type)}}},getTaskStore:function(){return this.stores[0].taskStore},getSourceTask:function(a){return this.getTaskStore().getById(this.getSourceId())},setSourceTask:function(a){this.setSourceId(a.getId()||a.internalId)},getTargetTask:function(){return this.getTaskStore().getById(this.getTargetId())},setTargetTask:function(a){this.setTargetId(a.getId()||a.internalId)},getSourceId:function(){return this.get(this.fromField)},setSourceId:function(a){this.set(this.fromField,a)},getTargetId:function(){return this.get(this.toField)},setTargetId:function(a){this.set(this.toField,a)},isPersistable:function(){var a=this.getSourceTask(),b=this.getTargetTask();return a&&!a.phantom&&b&&!b.phantom},isValid:function(a){var b=this.callParent(arguments);if(b&&this.stores[0]){b=this.stores[0].isValidDependency(this.getSourceId(),this.getTargetId(),true)}return b}});Ext.define("Gnt.model.Resource",{extend:"Sch.model.Resource",_defaultFields_:["CalendarId"],calendarIdField:"CalendarId",getTaskStore:function(){return this.stores[0].getTaskStore()},getEventStore:function(){return this.getTaskStore()},getEvents:function(){return this.getTasks()},getTasks:function(){var a=[];this.forEachAssignment(function(b){var c=b.getTask();if(c){a.push(c)}});return a},getCalendar:function(a){var b=this.getCalendarId();b=b?Gnt.data.Calendar.getCalendar(b):null;if(a||b){return b}return this.stores[0].getTaskStore().getCalendar()},getInternalId:function(){return this.getId()||this.internalId},assignTo:function(a,c){var b=a instanceof Gnt.model.Task?a:this.getTaskStore().getById(a);b.assign(this,c)},unassignFrom:function(){return this.unAssignFrom.apply(this,arguments)},unAssignFrom:function(a){var b=a instanceof Gnt.model.Task?a:this.getTaskStore().getById(a);b.unAssign(this)},forEachAssignment:function(b,a){a=a||this;var c=this.getInternalId();this.getTaskStore().getAssignmentStore().each(function(d){if(d.getResourceId()==c){return b.call(a,d)}})},collectAvailabilityIntervalPoints:function(e,f,b,h,c){for(var d=0;d<e.length;d++){var a=e[d];var g=a.startDate-0;var i=a.endDate-0;if(!h[g]){h[g]=[];c.push(g)}h[g].push(f(g));if(!h[i]){h[i]=[];c.push(i)}h[i].push(b(i))}},forEachAvailabilityIntervalWithTasks:function(d,f,a){a=a||this;var c=d.startDate;var t=d.endDate;if(!c||!t){throw"Both `startDate` and `endDate` are required for `forEachAvailabilityIntervalWithTasks`"}var g=new Date(c);var u=d.includeAllIntervals;var p=this.getCalendar();var l=[];var n=[];var b=[];this.forEachAssignment(function(k){var i=k.getTask();if(i.getStartDate()>t||i.getEndDate()<c){return}n.push(i);b.push(i.getCalendar());l.push(k)});if(!n.length){return}var e=Sch.util.Date;var y=[c-0,t-0];var j={};j[c-0]=[{type:"00-intervalStart"}];j[t-0]=[{type:"00-intervalEnd"}];while(g<t){this.collectAvailabilityIntervalPoints(p.getAvailabilityIntervalsFor(g),function(){return{type:"00-resourceAvailailabilityStart"}},function(){return{type:"01-resourceAvailailabilityEnd"}},j,y);for(var s=0;s<b.length;s++){this.collectAvailabilityIntervalPoints(b[s].getAvailabilityIntervalsFor(g),function(){return{type:"02-taskAvailailabilityStart",assignment:l[s],taskId:n[s].getInternalId(),units:l[s].getUnits()}},function(){return{type:"03-taskAvailailabilityEnd",taskId:n[s].getInternalId()}},j,y)}g=e.getStartOfNextDay(g)}y.sort();var v=false;var w={};var m=0;for(var s=0;s<y.length-1;s++){var r=j[y[s]];r.sort(function(k,i){return k.type<i.type});for(var q=0;q<r.length;q++){var o=r[q];if(o.type=="00-resourceAvailailabilityStart"){v=true}if(o.type=="01-resourceAvailailabilityEnd"){v=false}if(o.type=="02-taskAvailailabilityStart"){w[o.taskId]=o;m++}if(o.type=="03-taskAvailailabilityEnd"){delete w[o.taskId];m--}}if(u||v&&m){var x=y[s];var h=y[s+1];if(x>t||h<c){continue}if(x<c){x=c-0}if(h>t){h=t-0}if(f.call(a,x,h,w)===false){return false}}}},getAllocationInfo:function(a){var b=[];this.forEachAvailabilityIntervalWithTasks(a,function(h,g,f){var e=0;var c=[];for(var d in f){e+=f[d].units;c.push(f[d].assignment)}b.push({startDate:new Date(h),endDate:new Date(g),totalAllocation:e,assignments:c})});return b}});Ext.define("Gnt.model.Task",{extend:"Sch.model.Range",requires:["Sch.util.Date"],idProperty:"Id",_defaultFields_:[{name:"Id"},{name:"Name",type:"string"},{name:"Duration",type:"number",useNull:true},{name:"Effort",type:"number",useNull:true},{name:"EffortUnit",type:"string",defaultValue:"h"},{name:"CalendarId",type:"string"},{name:"DurationUnit",type:"string",defaultValue:"d",convert:function(a){return a||"d"}},{name:"PercentDone",type:"int",defaultValue:0},{name:"ManuallyScheduled",type:"boolean",defaultValue:false},{name:"SchedulingMode",type:"string",defaultValue:"Normal"},{name:"BaselineStartDate",type:"date",dateFormat:"c"},{name:"BaselineEndDate",type:"date",dateFormat:"c"},{name:"BaselinePercentDone",type:"int",defaultValue:0}],nameField:"Name",durationField:"Duration",durationUnitField:"DurationUnit",effortField:"Effort",effortUnitField:"EffortUnit",percentDoneField:"PercentDone",manuallyScheduledField:"ManuallyScheduled",schedulingModeField:"SchedulingMode",calendarIdField:"CalendarId",baselineStartDateField:"BaselineStartDate",baselineEndDateField:"BaselineEndDate",baselinePercentDoneField:"BaselinePercentDone",calendar:null,dependencyStore:null,taskStore:null,normalized:false,recognizedSchedulingModes:["Normal","Manual","FixedDuration","EffortDriven","DynamicAssignment"],normalize:function(){var g=this.getDuration(),f=this.getDurationUnit(),a=this.getStartDate(),e=this.getEndDate(),c=this.getSchedulingMode(),b=this.getEffort(),d=this.getEffortUnit();if(g==null&&a&&e){this.data[this.durationField]=this.calculateDuration(a,e,f)}if((c=="Normal"||this.isManuallyScheduled())&&e==null&&a&&g){this.data[this.endDateField]=this.calculateEndDate(a,g,f)}if(c=="FixedDuration"&&b==null&&a&&e){this.data[this.effortField]=this.calculateEffort(a,e,d)}if(c=="EffortDriven"&&e==null&&a&&b){this.data[this.endDateField]=this.calculateEffortDrivenEndDate(a,b,d);if(g==null){this.data[this.durationField]=this.calculateDuration(a,this.data[this.endDateField],f)}}this.normalized=true},getInternalId:function(){return this.getId()||this.internalId},getCalendar:function(b){var c=this.get(this.calendarIdField);c=c?Gnt.data.Calendar.getCalendar(c):this.calendar;if(b||c){return c}else{var a=this.stores[0];c=a&&a.getCalendar&&a.getCalendar()||this.parentNode&&this.parentNode.getCalendar()}if(!c){Ext.Error.raise("Can't find a calendar in `getCalendar`")}return c},setCalendar:function(a){this.calendar=a},getDependencyStore:function(){var a=this.dependencyStore||this.getTaskStore().dependencyStore;if(!a){Ext.Error.raise("Can't find a dependencyStore in `getDependencyStore`")}return a},getResourceStore:function(){return this.getTaskStore().getResourceStore()},getAssignmentStore:function(){return this.getTaskStore().getAssignmentStore()},getTaskStore:function(b){if(this.taskStore){return this.taskStore}var a=this.stores[0]&&this.stores[0].taskStore||this.parentNode&&this.parentNode.getTaskStore();if(!a&&!b){Ext.Error.raise("Can't find a taskStore in `getTaskStore`")}return this.taskStore=a},isManuallyScheduled:function(){return this.get(this.schedulingModeField)=="Manual"||this.get(this.manuallyScheduledField)},setManuallyScheduled:function(a){if(a){this.set(this.schedulingModeField,"Manual")}else{if(this.get(this.schedulingModeField)=="Manual"){this.set(this.schedulingModeField,"Normal")}}return this.set(this.manuallyScheduledField,a)},setSchedulingMode:function(a){if(Ext.Array.indexOf(this.recognizedSchedulingModes,a)==-1){throw"Unrecognized scheduling mode: "+a}this.beginEdit();this.set(this.schedulingModeField,a);if(a=="FixedDuration"){this.updateEffortBasedOnDuration()}if(a=="EffortDriven"){this.updateDurationBasedOnEffort()}this.endEdit()},setStartDate:function(a,e,d){this.beginEdit();var c=this.getCalendar();if(d&&!this.isManuallyScheduled()){if(!this.isMilestone()||c.isHoliday(a-1)){a=c.skipNonWorkingTime(a,true)}}if(e!==false){var b=this.getDuration();if(Ext.isNumber(b)){this.set(this.startDateField,a);this.set(this.endDateField,this.calculateEndDate(a,b,this.getDurationUnit()))}else{this.set(this.startDateField,a)}}else{this.set(this.startDateField,a);if(this.getEndDate()){this.set(this.durationField,this.calculateDuration(a,this.getEndDate(),this.getDurationUnit()))}}this.onPotentialEffortChange();this.endEdit()},setEndDate:function(a,e,d){this.beginEdit();var c=this.getCalendar();if(d&&!this.isManuallyScheduled()){a=c.skipNonWorkingTime(a,false)}if(e!==false){var b=this.getDuration();if(Ext.isNumber(b)){this.set(this.startDateField,this.calculateStartDate(a,b,this.getDurationUnit()));this.set(this.endDateField,a)}else{this.set(this.endDateField,a)}}else{this.set(this.endDateField,a);if(this.getStartDate()){this.set(this.durationField,this.calculateDuration(this.getStartDate(),a,this.getDurationUnit()))}}this.onPotentialEffortChange();this.endEdit()},setStartEndDate:function(a,c,d){this.beginEdit();var b=this.getCalendar();if(d&&!this.isManuallyScheduled()){a=b.skipNonWorkingTime(a,true);c=b.skipNonWorkingTime(c,false)}this.set(this.startDateField,a);this.set(this.endDateField,c);this.set(this.durationField,this.calculateDuration(a,c,this.getDurationUnit()));this.onPotentialEffortChange();this.endEdit()},getDuration:function(a){if(!a){return this.get(this.durationField)}var b=this.getCalendar(),c=b.convertDurationToMs(this.get(this.durationField),this.get(this.durationUnitField));return b.convertMSDurationToUnit(c,a)},getEffort:function(a){if(!a){return this.get(this.effortField)}var b=this.getCalendar(),c=b.convertDurationToMs(this.get(this.effortField),this.get(this.effortUnitField));return b.convertMSDurationToUnit(c,a)},setEffort:function(b,a){a=a||this.get(this.effortUnitField);this.beginEdit();this.set(this.effortField,b);this.set(this.effortUnitField,a);if(this.getSchedulingMode()=="EffortDriven"){this.updateDurationBasedOnEffort()}if(this.getSchedulingMode()=="DynamicAssignment"){this.updateAssignments()}this.endEdit()},getCalendarDuration:function(a){return this.getCalendar().convertMSDurationToUnit(this.getEndDate()-this.getStartDate(),a||this.get(this.durationUnitField))},setDuration:function(b,a){a=a||this.get(this.durationUnitField);this.beginEdit();this.set(this.endDateField,this.calculateEndDate(this.getStartDate(),b,a));this.set(this.durationField,b);this.set(this.durationUnitField,a);this.onPotentialEffortChange();this.endEdit()},calculateStartDate:function(c,b,a){a=a||this.getDurationUnit();if(this.isManuallyScheduled()){return Sch.util.Date.add(startDate,a,-b)}else{return this.getCalendar().calculateStartDate(c,b,a)}},calculateEndDate:function(a,c,b){b=b||this.getDurationUnit();if(this.isManuallyScheduled()){return Sch.util.Date.add(a,b,c)}else{return this.getCalendar().calculateEndDate(a,c,b)}},calculateDuration:function(a,c,b){b=b||this.getDurationUnit();if(this.isManuallyScheduled()){return this.getCalendar().convertMSDurationToUnit(c-a,b)}else{return this.getCalendar().calculateDuration(a,c,b)}},forEachAvailabilityIntervalWithResources:function(f,h,a){a=a||this;var d=f.startDate;var x=f.endDate;var j=new Date(d);var b=f.includeEmptyIntervals;var c=this.getCalendar();var q=this.getAssignments();if(!q.length){return}var y=[];var t=[];Ext.each(q,function(k){var i=k.getResource();y.push(i);t.push(i.getCalendar())});var g=Sch.util.Date;while(!x||j<x){var l=c.getAvailabilityIntervalsFor(j);var p={};var B=[];for(var s=0;s<l.length;s++){var z=l[s];var A=z.startDate-0;var n=z.endDate-0;if(!p[A]){p[A]=[];B.push(A)}p[A].push({type:"00-taskAvailailabilityStart"});B.push(n);p[n]=p[n]||[];p[n].push({type:"01-taskAvailailabilityEnd"})}for(var w=0;w<t.length;w++){var e=t[w].getAvailabilityIntervalsFor(j);for(var s=0;s<e.length;s++){var z=e[s];var A=z.startDate-0;var n=z.endDate-0;if(!p[A]){p[A]=[];B.push(A)}p[A].push({type:"02-resourceAvailailabilityStart",assignment:q[w],resourceId:y[w].getInternalId(),units:q[w].getUnits()});if(!p[n]){p[n]=[];B.push(n)}p[n].push({type:"03-resourceAvailailabilityEnd",resourceId:y[w].getInternalId()})}}B.sort();var v=false;var o={};var m=0;for(var w=0;w<B.length;w++){var u=p[B[w]];u.sort(function(k,i){return k.type<i.type});for(var s=0;s<u.length;s++){var r=u[s];if(r.type=="00-taskAvailailabilityStart"){v=true}if(r.type=="01-taskAvailailabilityEnd"){v=false}if(r.type=="02-resourceAvailailabilityStart"){o[r.resourceId]=r;m++}if(r.type=="03-resourceAvailailabilityEnd"){delete o[r.resourceId];m--}}if(v&&(m||b)){var A=B[w];var n=B[w+1];if(A>x||n<d){continue}if(A<d){A=d-0}if(n>x){n=x-0}if(h.call(a,A,n,o)===false){return false}}}j=g.getStartOfNextDay(j)}},calculateEffortDrivenEndDate:function(a,c,b){var e=this.getCalendar().convertDurationToMs(c,b||this.getEffortUnit());var d=new Date(a);this.forEachAvailabilityIntervalWithResources({startDate:a},function(l,k,j){var m=0;for(var h in j){m+=j[h].units}var g=k-l;var f=m*g/100;if(f>=e){d=new Date(l+e/f*g);return false}else{e-=f}});return d},indent:function(){var a=this.previousSibling;if(a){this.isMove=true;a.appendChild(this);delete this.isMove;a.set("leaf",false);a.expand()}},outdent:function(){var a=this.parentNode;if(a&&!a.isRoot()){a.set("leaf",a.childNodes.length===1);this.isMove=true;if(a.nextSibling){a.parentNode.insertBefore(this,a.nextSibling)}else{a.parentNode.appendChild(this)}delete this.isMove}},recalculateParents:function(){var b=new Date(9999,0,0),c=new Date(0),e=this.parentNode;var h,g;if(e&&!e.isRoot()&&e.childNodes.length>0){if(!e.isManuallyScheduled()){for(var d=0,a=e.childNodes.length;d<a;d++){var f=e.childNodes[d];b=Sch.util.Date.min(b,f.getStartDate()||b);c=Sch.util.Date.max(c,f.getEndDate()||c)}h=b-new Date(9999,0,0)!==0&&e.getStartDate()-b!==0;g=c-new Date(0)!==0&&e.getEndDate()-c!==0;if(h&&g){e.setStartEndDate(b,c,false)}else{if(h){e.setStartDate(b,g,false)}else{if(g){e.setEndDate(c,false,false)}}}}if(!h&&!g){e.recalculateParents()}}},isMilestone:function(){return this.getEndDate()-this.getStartDate()===0},getAllDependencies:function(a){a=a||this.getDependencyStore();return a.getDependenciesForTask(this)},hasIncomingDependencies:function(a){var c=this.getId()||this.internalId;a=a||this.getDependencyStore();var b=a.findBy(function(d){return d.getTargetId()==c});return b>=0},getIncomingDependencies:function(a){a=a||this.getDependencyStore();return a.getIncomingDependenciesForTask(this)},getOutgoingDependencies:function(a){a=a||this.getDependencyStore();return a.getOutgoingDependenciesForTask(this)},getConstrainContext:function(f){var g=this.getIncomingDependencies();if(!g.length){return null}var h=f||this.getTaskStore(),a=Gnt.model.Dependency.Type,c=new Date(0),b=new Date(0),i=Ext.Date,e=this.getCalendar(),d;Ext.each(g,function(l){var k=l.getSourceTask();if(k){var n=l.getLag()||0,m=k.getStartDate(),j=k.getEndDate();switch(l.getType()){case a.StartToEnd:m=e.skipWorkingDays(m,n);if(b<m){b=m;d=k}break;case a.StartToStart:m=e.skipWorkingDays(m,n);if(c<m){c=m;d=k}break;case a.EndToStart:j=e.skipWorkingDays(j,n);if(c<j){c=j;d=k}break;case a.EndToEnd:j=e.skipWorkingDays(j,n);if(b<j){b=j;d=k}break;default:throw"Invalid dependency type: "+l.getType()}}});return{startDate:c>0?c:null,endDate:b>0?b:null,constrainingTask:d}},getCriticalPaths:function(){var b=[this],a=this.getConstrainContext();while(a){b.push(a.constrainingTask);a=a.constrainingTask.getConstrainContext()}return b},constrain:function(c){if(this.isManuallyScheduled()){return false}var e=false;c=c||this.getTaskStore();var b=this.getConstrainContext(c);if(b){var a=b.startDate;var d=b.endDate;if(a&&a-this.getStartDate()!==0){this.setStartDate(a,true,c.skipWeekendsDuringDragDrop);e=true}else{if(d&&d-this.getEndDate()!==0){this.setEndDate(d,true,c.skipWeekendsDuringDragDrop);e=true}}}return e},cascadeChanges:function(a,b){a=a||this.getTaskStore();if(this.isLeaf()){if(this.constrain(a)){this.recalculateParents();b.nbrAffected++}}Ext.each(this.getOutgoingDependencies(),function(c){var d=c.getTargetTask();if(d&&!d.isManuallyScheduled()){d.cascadeChanges(a,b)}})},afterEdit:function(b){if(this.stores.length>0||!this.normalized){this.callParent(arguments)}else{var a=this.taskStore||this.getTaskStore(true);if(a&&!a.isFillingRoot){a.afterEdit(this,b)}this.callParent(arguments)}},afterCommit:function(){this.callParent(arguments);if(this.stores.length>0||!this.normalized){return}var a=this.taskStore||this.getTaskStore(true);if(a&&!a.isFillingRoot){a.afterCommit(this)}},afterReject:function(){if(this.stores.length>0){this.callParent(arguments)}else{var a=this.getTaskStore(true);if(a&&!a.isFillingRoot){a.afterReject(this)}this.callParent(arguments)}},getDurationUnit:function(){return this.get(this.durationUnitField)||"d"},getEffortUnit:function(){return this.get(this.effortUnitField)||"d"},remove:function(){this.callParent(arguments);if(this.parentNode.childNodes.length===0&&this.getTaskStore().recalculateParents){this.parentNode.set("leaf",true)}},addSubtask:function(a){this.set("leaf",false);this.appendChild(a);this.expand()},addSuccessor:function(b){var c=this.rec,d=this.getDependencyStore();b=b||new this.self();this.addTaskBelow(b);b.beginEdit();b.setStartDate(this.getEndDate());b.setDuration(1,Sch.util.Date.DAY);b.endEdit();var a=new d.model({fromTask:this,toTask:b,type:d.model.Type.EndToStart});d.add(a)},addPredecessor:function(c){var b=this.getDependencyStore();c=c||new this.self();this.addTaskAbove(c);c.beginEdit();c.set(this.startDateField,c.calculateStartDate(this.getStartDate(),1,Sch.util.Date.DAY));c.set(this.endDateField,this.getStartDate());c.set(this.durationField,1);c.set(this.durationUnitField,Sch.util.Date.DAY);c.endEdit();var a=new b.model({fromTask:c,toTask:this,type:b.model.Type.EndToStart});b.add(a)},getSuccessors:function(){var g=this.getId()||this.internalId;var d=d||this.getDependencyStore();var b=this.getTaskStore(),f=[];for(var e=0,a=d.getCount();e<a;e++){var c=d.getAt(e);if(c.getSourceId()==g){f.push(c.getTargetTask())}}return f},getPredecessors:function(){var g=this.getId()||this.internalId;var d=d||this.getDependencyStore();var b=this.getTaskStore(),f=[];for(var e=0,a=d.getCount();e<a;e++){var c=d.getAt(e);if(c.getTargetId()==g){f.push(c.getSourceTask())}}return f},addTaskAbove:function(a){a=a||new this.self();this.parentNode.insertBefore(a,this)},addTaskBelow:function(a){a=a||new this.self();if(this.nextSibling){this.parentNode.insertBefore(a,this.nextSibling)}else{this.parentNode.appendChild(a)}},getBaselinePercentDone:function(){return this.get(this.baselinePercentDoneField)||0},isPersistable:function(){var a=this.parentNode;return !a.phantom},getResources:function(){var a=this.getTaskStore(),d=this.getInternalId(),b=a.getResourceStore();var c=[];a.getAssignmentStore().each(function(e){if(e.getTaskId()==d){c.push(e.getResource())}});return c},getAssignments:function(){var b=this.getTaskStore(),c=this.getInternalId();var a=[];b.getAssignmentStore().each(function(d){if(d.getTaskId()==c){a.push(d)}});return a},getAssignmentFor:function(c){var a=this.getTaskStore(),e=this.getInternalId(),d=c instanceof Gnt.model.Resource?c.getInternalId():c;var b;a.getAssignmentStore().each(function(f){if(f.getTaskId()==e&&f.getResourceId()==d){b=f;return false}});return b},unassign:function(){return this.unAssign.apply(this,arguments)},unAssign:function(a){var b=this.getAssignmentStore();var c=a instanceof Gnt.model.Resource?a.getInternalId():a;b.removeAt(b.find("ResourceId",c))},assign:function(d,a){var b=this.getTaskStore(),g=this.getInternalId(),e=b.getAssignmentStore(),c=b.getResourceStore();var f=d instanceof Gnt.model.Resource?d.getInternalId():d;e.each(function(h){if(h.getTaskId()==g&&h.getResourceId()==f){throw"Resource can't be assigned twice to the same task"}});if(d instanceof Gnt.model.Resource&&c.indexOf(d)==-1){c.add(d)}e.add(Ext.create("Gnt.model.Assignment",{TaskId:g,ResourceId:f,Units:a}))},calculateEffort:function(a,c,b){var d=0;this.forEachAvailabilityIntervalWithResources({startDate:a,endDate:c},function(h,g,f){var j=0;for(var e in f){j+=f[e].units}d+=(g-h)*j/100});return this.getCalendar().convertMSDurationToUnit(d,b||this.getEffortUnit())},updateAssignments:function(){var b={};var a=this.getStartDate();var d=this.getEndDate();var c=0;this.forEachAvailabilityIntervalWithResources({startDate:a,endDate:d},function(h,g,f){for(var i in f){c+=g-h}});if(!c){return}var e=this.getEffort(Sch.util.Date.MILLI);Ext.Array.each(this.getAssignments(),function(f){f.setUnits(e/c*100)})},updateEffortBasedOnDuration:function(){this.setEffort(this.calculateEffort(this.getStartDate(),this.getEndDate()))},updateDurationBasedOnEffort:function(){this.setEndDate(this.calculateEffortDrivenEndDate(this.getStartDate(),this.getEffort(),this.getEffortUnit()),false)},onPotentialEffortChange:function(){if(this.getSchedulingMode()=="FixedDuration"){this.updateEffortBasedOnDuration()}if(this.getSchedulingMode()=="DynamicAssignment"){this.updateAssignments()}},onAssignmentMutation:function(){if(this.getSchedulingMode()=="FixedDuration"){this.updateEffortBasedOnDuration()}if(this.getSchedulingMode()=="EffortDriven"){this.updateDurationBasedOnEffort()}},onAssignmentStructureMutation:function(){if(this.getSchedulingMode()=="FixedDuration"){this.updateEffortBasedOnDuration()}if(this.getSchedulingMode()=="EffortDriven"){this.updateDurationBasedOnEffort()}if(this.getSchedulingMode()=="DynamicAssignment"){this.updateAssignments()}},adjustToCalendar:function(){if(this.get("leaf")&&!this.isManuallyScheduled()){var a=this.hasIncomingDependencies();if(a){this.constrain()}else{this.setStartDate(this.getStartDate(),true,true)}}},isEditable:function(a){if((a==this.durationField||a==this.endDateField)&&this.getSchedulingMode()=="EffortDriven"){return false}if(a==this.effortField&&this.getSchedulingMode()=="FixedDuration"){return false}return true}});Ext.define("Gnt.data.Calendar",{extend:"Ext.data.Store",requires:["Ext.Date","Gnt.model.CalendarDay","Sch.model.Range","Sch.util.Date"],model:"Gnt.model.CalendarDay",daysPerMonth:30,daysPerWeek:7,hoursPerDay:24,unitsInMs:null,defaultNonWorkingTimeCssCls:"gnt-holiday",weekendsAreWorkdays:false,weekendFirstDay:6,weekendSecondDay:0,holidaysCache:null,weekAvailability:null,parent:null,statics:{getCalendar:function(a){if(a instanceof Gnt.data.Calendar){return a}return Ext.StoreManager.lookup("GNT_CALENDAR:"+a)}},constructor:function(a){if(a.calendarId){this.storeId="GNT_CALENDAR:"+a.calendarId}this.callParent(arguments);var b=this.parent=Gnt.data.Calendar.getCalendar(a.parent);this.unitsInMs={MILLI:1,SECOND:1000,MINUTE:60*1000,HOUR:60*60*1000,DAY:this.hoursPerDay*60*60*1000,WEEK:this.daysPerWeek*this.hoursPerDay*60*60*1000,MONTH:this.daysPerMonth*this.hoursPerDay*60*60*1000,QUARTER:3*this.daysPerMonth*24*60*60*1000,YEAR:4*3*this.daysPerMonth*24*60*60*1000};this.weekAvailability=a.weekAvailability||b?[]:[this.weekendsAreWorkdays?new Gnt.model.CalendarDay({Date:new Date(),Availability:["00:00-24:00"],IsWorkingDay:true}):new Gnt.model.CalendarDay({Date:new Date(),Availability:[]}),new Gnt.model.CalendarDay({Date:new Date(),Availability:["00:00-24:00"],IsWorkingDay:true}),new Gnt.model.CalendarDay({Date:new Date(),Availability:["00:00-24:00"],IsWorkingDay:true}),new Gnt.model.CalendarDay({Date:new Date(),Availability:["00:00-24:00"],IsWorkingDay:true}),new Gnt.model.CalendarDay({Date:new Date(),Availability:["00:00-24:00"],IsWorkingDay:true}),new Gnt.model.CalendarDay({Date:new Date(),Availability:["00:00-24:00"],IsWorkingDay:true}),this.weekendsAreWorkdays?new Gnt.model.CalendarDay({Date:new Date(),Availability:["00:00-24:00"],IsWorkingDay:true}):new Gnt.model.CalendarDay({Date:new Date(),Availability:[]})];this.holidaysCache={};this.on("datachanged",this.clearCache,this);b&&b.on("clearcache",this.clearCache,this)},clearCache:function(){this.holidaysCache={};this.fireEvent("clearcache",this)},getCalendarDay:function(b){b=typeof b=="number"?new Date(b):b;var a=this.getOverrideDay(b);if(a){return a}return this.getDefaultCalendarDay(b.getDay())},getOverrideDay:function(a){var b=this.getOwnCalendarDay(a);if(b){return b}if(this.parent){return this.parent.getOverrideDay(a)}return null},getOwnCalendarDay:function(a){a=typeof a=="number"?new Date(a):a;return this.getById(Ext.Date.clearTime(a,true)-0)},getDefaultCalendarDay:function(a){if(this.weekAvailability[a]){return this.weekAvailability[a]}if(this.parent){return this.parent.getDefaultCalendarDay(a)}return null},isHoliday:function(c){var b=c-0;var d=this.holidaysCache;if(d[b]!=null){return d[b]}c=typeof c=="number"?new Date(c):c;var a=this.getCalendarDay(c);if(!a){throw"Can't find day for "+c}return d[b]=!a.getIsWorkingDay()},isWeekend:function(b){var a=b.getDay();return a===this.weekendFirstDay||a===this.weekendSecondDay},isWorkingDay:function(a){return !this.isHoliday(a)},convertMSDurationToUnit:function(a,b){return a/this.unitsInMs[Sch.util.Date.getNameOfUnit(b)]},convertDurationToMs:function(b,a){return b*this.unitsInMs[Sch.util.Date.getNameOfUnit(a)]},getHolidaysRanges:function(d,g,a){if(d>g){Ext.Error.raise("startDate can't be bigger than endDate")}d=Ext.Date.clearTime(d,true);g=Ext.Date.clearTime(g,true);var c=[],h,e;for(e=d;e<g;e=Sch.util.Date.add(e,Sch.util.Date.DAY,1)){if(this.isHoliday(e)||(this.weekendsAreWorkdays&&a&&this.isWeekend(e))){var i=this.getCalendarDay(e);var j=i&&i.getCls()||this.defaultNonWorkingTimeCssCls;var f=Sch.util.Date.add(e,Sch.util.Date.DAY,1);if(!h){h={StartDate:e,EndDate:f,Cls:j}}else{if(h.Cls==j){h.EndDate=f}else{c.push(h);h={StartDate:e,EndDate:f,Cls:j}}}}else{if(h){c.push(h);h=null}}}if(h){c.push(h)}var b=[];Ext.each(c,function(k){b.push(Ext.create("Sch.model.Range",{StartDate:k.StartDate,EndDate:k.EndDate,Cls:k.Cls}))});return b},forEachAvailabilityInterval:function(a,g,e,d){d=d||this;a=new Date(a);var f=Sch.util.Date;while(!g||a<g){var c=this.getAvailabilityIntervalsFor(a);for(var b=0;b<c.length;b++){if(e.call(d,c[b])===false){return false}}a=f.getStartOfNextDay(a)}},forEachAvailabilityIntervalBackward:function(f,d,c){c=c||this;f=new Date(f);var e=Sch.util.Date;while(true){var b=this.getAvailabilityIntervalsFor(f-1);for(var a=0;a<b.length;a++){if(d.call(c,b[a])===false){return false}}f=e.getEndOfPreviousDay(f)}},calculateDuration:function(a,d,b){if(a>d){Ext.Error.raise("startDate can't be bigger than endDate")}var c=0;this.forEachAvailabilityInterval(a,d,function(e){var i=e.startDate;var h=e.endDate;if(i>d||h<a){return}var g=i>a?i:a;var f=h>d?d:h;c+=f-g});return this.convertMSDurationToUnit(c,b)},calculateEndDate:function(a,e,b){if(!e){return new Date(a)}var d;e=this.convertDurationToMs(e,b);var c=e==0&&Ext.Date.clearTime(a,true)-a==0?Sch.util.Date.add(a,Sch.util.Date.DAY,-1):a;this.forEachAvailabilityInterval(c,null,function(f){var j=f.startDate;var i=f.endDate;if(i<a){return}var h=j>a?j:a;var g=i;if(g-h>=e){d=new Date(h-0+e);return false}else{e-=g-h}});return d},calculateStartDate:function(d,c,b){if(!c){return new Date(d)}var a;c=this.convertDurationToMs(c,b);this.forEachAvailabilityIntervalBackward(d,function(e){var i=e.startDate;var h=e.endDate;if(i>d){return}var g=i;var f=h<d?h:d;if(f-g>=c){a=new Date(f-c);return false}else{c-=f-g}});return a},skipNonWorkingTime:function(a,b){while(this.isHoliday(a-(b?0:1))){if(b){a=Sch.util.Date.getStartOfNextDay(a,true)}else{a=Sch.util.Date.getEndOfPreviousDay(a)}}return a},skipWorkingDays:function(a,b){var c=0,d=b>0,e=Ext.Date.clone(a);b=Math.abs(b);while(c<b){if(!this.isHoliday(e-(d?0:1))){c++;if(d){e=Sch.util.Date.getStartOfNextDay(e,true)}else{e=Sch.util.Date.getEndOfPreviousDay(e)}}if(d||c<b){e=this.skipNonWorkingTime(e,d)}}e.setHours(a.getHours());e.setMinutes(a.getMinutes());e.setSeconds(a.getSeconds());e.setMilliseconds(a.getMilliseconds());return e},getAvailabilityIntervalsFor:function(a){return this.getCalendarDay(a).getAvailabilityIntervalsFor(a)},intersectAvailabilities:function(b,a){throw"yo"}});Ext.define("Gnt.data.Calendar.BusinessTime",{extend:"Gnt.data.Calendar",daysPerMonth:20,daysPerWeek:5,hoursPerDay:8,constructor:function(a){this.callParent(arguments);this.weekAvailability=a.weekAvailability||this.parent?[]:[new Gnt.model.CalendarDay({Date:new Date(),Availability:[]}),new Gnt.model.CalendarDay({Date:new Date(),Availability:["08:00-12:00","13:00-17:00"],IsWorkingDay:true}),new Gnt.model.CalendarDay({Date:new Date(),Availability:["08:00-12:00","13:00-17:00"],IsWorkingDay:true}),new Gnt.model.CalendarDay({Date:new Date(),Availability:["08:00-12:00","13:00-17:00"],IsWorkingDay:true}),new Gnt.model.CalendarDay({Date:new Date(),Availability:["08:00-12:00","13:00-17:00"],IsWorkingDay:true}),new Gnt.model.CalendarDay({Date:new Date(),Availability:["08:00-12:00","13:00-17:00"],IsWorkingDay:true}),new Gnt.model.CalendarDay({Date:new Date(),Availability:[]})]}});Ext.define("Gnt.data.TaskStore",{extend:"Ext.data.TreeStore",requires:["Gnt.model.Task","Gnt.data.Calendar"],model:"Gnt.model.Task",calendar:null,dependencyStore:null,resourceStore:null,assignmentStore:null,weekendsAreWorkdays:true,buffered:false,pageSize:null,cascadeChanges:false,recalculateParents:true,skipWeekendsDuringDragDrop:true,cascadeDelay:10,cascading:false,isFillingRoot:false,constructor:function(c){this.addEvents("root-fill-start","root-fill-end","filter","clearfilter","beforecascade","cascade");c=c||{};if(!c.calendar){var a={};if(c.hasOwnProperty("weekendsAreWorkdays")){a.weekendsAreWorkdays=c.weekendsAreWorkdays}c.calendar=new Gnt.data.Calendar(a)}this.hasListeners={};this.on({remove:this.onTaskDeleted,beforesync:this.onTaskStoreBeforeSync,scope:this});var b=c.dependencyStore;if(b){delete c.dependencyStore;this.setDependencyStore(b)}var d=c.resourceStore;if(d){delete c.resourceStore;this.setResourceStore(d)}var f=c.assignmentStore;if(f){delete c.assignmentStore;this.setAssignmentStore(f)}var e=c.calendar;if(e){delete c.calendar;this.setCalendar(e)}this.callParent([c])},onNodeAdded:function(a,b){if(!b.normalized&&!b.isRoot()){b.normalize()}this.callParent(arguments)},setRootNode:function(){var b=this;this.tree.setRootNode=Ext.Function.createInterceptor(this.tree.setRootNode,function(c){Ext.apply(c,{calendar:b.calendar,taskStore:b,dependencyStore:b.dependencyStore,phantom:false,dirty:false})});var a=this.callParent(arguments);delete this.tree.setRootNode;return a},fillNode:function(f,b){if(f.isRoot()){this.isFillingRoot=true;this.un({remove:this.onNodeUpdated,append:this.onNodeUpdated,insert:this.onNodeUpdated,update:this.onTaskUpdated,scope:this});this.fireEvent("root-fill-start",this,f,b)}var e=this,d=b?b.length:0,c=0,a;if(d&&e.sortOnLoad&&!e.remoteSort&&e.sorters&&e.sorters.items){a=Ext.create("Ext.util.MixedCollection");a.addAll(b);a.sort(e.sorters.items);b=a.items}f.set("loaded",true);if(this.buffered){for(;c<d;c++){f.appendChild(b[c],true,true);this.onNodeAdded(null,b[c]);this.tree.registerNode(b[c])}}else{for(;c<d;c++){f.appendChild(b[c],false,true)}}if(f.isRoot()){this.isFillingRoot=false;this.on({remove:this.onNodeUpdated,append:this.onNodeUpdated,insert:this.onNodeUpdated,update:this.onTaskUpdated,scope:this});this.fireEvent("root-fill-end",this,f,b)}return b},getById:function(a){return this.tree.getNodeById(a)},setDependencyStore:function(a){if(this.dependencyStore){this.dependencyStore.un({add:this.onDependencyAddOrUpdate,update:this.onDependencyAddOrUpdate,beforesync:this.onBeforeDependencySync,scope:this})}this.dependencyStore=a;if(a){a.taskStore=this;a.on({add:this.onDependencyAddOrUpdate,update:this.onDependencyAddOrUpdate,scope:this})}},setResourceStore:function(a){this.resourceStore=a;a.taskStore=this},getResourceStore:function(){return this.resourceStore||null},setAssignmentStore:function(a){if(this.assignmentStore){this.assignmentStore.un({add:this.onAssignmentStructureMutation,update:this.onAssignmentMutation,remove:this.onAssignmentStructureMutation,scope:this})}this.assignmentStore=a;a.taskStore=this;a.on({add:this.onAssignmentStructureMutation,update:this.onAssignmentMutation,remove:this.onAssignmentStructureMutation,scope:this})},getAssignmentStore:function(){return this.assignmentStore||null},renormalizeTasks:function(){this.getRootNode().cascadeBy(function(a){a.adjustToCalendar()})},getCalendar:function(){return this.calendar||null},setCalendar:function(b){var a={datachanged:this.renormalizeTasks,clear:this.renormalizeTasks,scope:this};if(this.calendar){this.calendar.un(a)}this.calendar=b;b.on(a)},filter:function(){this.fireEvent("filter",this,arguments)},clearFilter:function(){this.fireEvent("clearfilter",this)},getCriticalPaths:function(){var b=this.getRootNode(),a=[],d=new Date(0);b.cascadeBy(function(e){d=Sch.util.Date.max(e.getEndDate(),d)});b.cascadeBy(function(e){if(d-e.getEndDate()===0&&!e.isRoot()){a.push(e)}});var c=[];Ext.each(a,function(e){c.push(e.getCriticalPaths())});return c},onNodeUpdated:function(a,b){if(!this.cascading&&this.recalculateParents){b.recalculateParents()}},onTaskUpdated:function(c,b,a){var d=b.previous;if(!this.cascading&&(a===Ext.data.Model.EDIT||a===Ext.data.Model.REJECT)&&(!d||b.startDateField in d||b.endDateField in d)){if(this.cascadeChanges){Ext.Function.defer(this.cascadeChangesForTask,this.cascadeDelay,this,[b])}if(this.recalculateParents){b.recalculateParents()}}},cascadeChangesForTask:function(a){var c=this,b={nbrAffected:0};Ext.each(a.getOutgoingDependencies(),function(d){var e=d.getTargetTask();if(e){if(!c.cascading){c.fireEvent("beforecascade",c)}c.cascading=true;e.cascadeChanges(c,b)}});if(c.cascading){c.cascading=false;c.fireEvent("cascade",c,b)}},onTaskDeleted:function(c,b){if(!b.isReplace&&!b.isMove){var a=this.dependencyStore;a.remove(b.getAllDependencies(a))}},onAssignmentMutation:function(c,a){var b=this;Ext.each(a,function(d){d.getTask(b).onAssignmentMutation(d)})},onAssignmentStructureMutation:function(c,a){var b=this;Ext.each(a,function(d){d.getTask(b).onAssignmentStructureMutation(d)})},onDependencyAddOrUpdate:function(a,c){if(this.cascadeChanges){var b=this;Ext.each(c,function(d){d.getTargetTask().constrain(b)})}},getNewRecords:function(){return Ext.Array.filter(this.tree.flatten(),this.filterNew,this)},getUpdatedRecords:function(){return Ext.Array.filter(this.tree.flatten(),this.filterUpdated,this)},filterNew:function(a){return a.phantom===true&&a.isValid()&&a!=this.tree.root},filterUpdated:function(a){return a.dirty===true&&a.phantom!==true&&a.isValid()&&a!=this.tree.root},onTaskStoreBeforeSync:function(b,c){var a=b.create;if(a){for(var e,d=a.length-1;d>=0;d--){e=a[d];e._phantomId=e.internalId}}},getTotalTimeSpan:function(){var a=new Date(9999,0,1),b=new Date(0),c=Sch.util.Date;this.getRootNode().cascadeBy(function(d){if(d.getStartDate()){a=c.min(d.getStartDate(),a)}if(d.getEndDate()){b=c.max(d.getEndDate(),b)}});a=a<new Date(9999,0,1)?a:null;b=b>new Date(0)?b:null;return{start:a,end:b||a||null}},getCount:function(b){var a=b===false?0:-1;this.getRootNode().cascadeBy(function(){a++});return a},toArray:function(){var a=[];this.getRootNode().cascadeBy(function(b){a.push(b)});return a}});Ext.define("Gnt.data.DependencyStore",{extend:"Ext.data.Store",model:"Gnt.model.Dependency",constructor:function(){this.callParent(arguments);this.init()},init:function(){this.on({beforesync:this.onBeforeSyncOperation,scope:this})},onBeforeSyncOperation:function(a,b){if(a.create){for(var d,c=a.create.length-1;c>=0;c--){d=a.create[c];if(!d.isPersistable()){Ext.Array.remove(a.create,d)}}if(a.create.length===0){delete a.create}}return Boolean((a.create&&a.create.length>0)||(a.update&&a.update.length>0)||(a.destroy&&a.destroy.length>0))},getDependenciesForTask:function(b){var g=b.getId()||b.internalId;var e=[],f=this;for(var d=0,a=f.getCount();d<a;d++){var c=f.getAt(d);if(c.getSourceId()==g||c.getTargetId()==g){e.push(c)}}return e},getIncomingDependenciesForTask:function(b){var g=b.getId()||b.internalId;var e=[],f=this;for(var d=0,a=f.getCount();d<a;d++){var c=f.getAt(d);if(c.getTargetId()==g){e.push(c)}}return e},getOutgoingDependenciesForTask:function(b){var g=b.getId()||b.internalId;var e=[],f=this;for(var d=0,a=f.getCount();d<a;d++){var c=f.getAt(d);if(c.getSourceId()==g){e.push(c)}}return e},hasTransitiveDependency:function(d,b,a){var c=this;return this.findBy(function(f){var e=f.getTargetId();if(f.getSourceId()===d){return(e===b&&f!==a)?true:c.hasTransitiveDependency(f.getTargetId(),b,a)}})>=0},isValidDependency:function(h,b,e){var f=true;var d,c,a;if(h instanceof Gnt.model.Dependency){d=h.getSourceId();c=this.getSourceTask(d);b=h.getTargetId();a=this.getTargetTask(b)}else{d=h;c=this.getSourceTask(d);a=this.getTargetTask(b)}if(!e&&h instanceof Gnt.model.Dependency){f=h.isValid()}else{f=d&&b&&d!==b}if(f){if(c&&a&&(c.contains(a))||a.contains(c)){f=false}var g=e||(h instanceof Gnt.model.Dependency);if(f&&((!g&&this.areTasksLinked(d,b))||this.hasTransitiveDependency(b,d,g?h:null))){f=false}}return f},areTasksLinked:function(a,c){var b=this;a=a instanceof Gnt.model.Task?(a.getId()||a.internalId):a;c=c instanceof Gnt.model.Task?(c.getId()||c.internalId):c;return this.findBy(function(f){var d=f.getTargetId(),e=f.getSourceId();if((e===a&&d===c)||(e===c&&d===c)){return true}})>=0},getSourceTask:function(a){var b=a instanceof Gnt.model.Dependency?dependency.getSourceId():a;return this.getTaskStore().getById(b)},getTargetTask:function(a){var b=a instanceof Gnt.model.Dependency?dependency.getSourceId():a;return this.getTaskStore().getById(b)},getTaskStore:function(){return this.taskStore}});Ext.define("Gnt.data.ResourceStore",{requires:["Gnt.model.Resource"],model:"Gnt.model.Resource",extend:"Sch.data.ResourceStore",taskStore:null,getTaskStore:function(){return this.taskStore||null},getAssignmentStore:function(){return this.assignmentStore||null},getByInternalId:function(a){return this.data.getByKey(a)||this.getById(a)}});Ext.define("Gnt.data.AssignmentStore",{requires:["Gnt.model.Assignment"],model:"Gnt.model.Assignment",extend:"Ext.data.Store",taskStore:null,getTaskStore:function(){return this.taskStore},getResourceStore:function(){return this.getTaskStore().resourceStore},getByInternalId:function(a){return this.data.getByKey(a)||this.getById(a)}});Ext.define("Gnt.template.Task",{extend:"Ext.XTemplate",constructor:function(a){this.callParent(['<div class="sch-event-wrap '+a.baseCls+' x-unselectable" style="left:{leftOffset}px;">'+(a.leftLabel?'<div class="sch-gantt-labelct sch-gantt-labelct-left"><label class="sch-gantt-label sch-gantt-label-left">{leftLabel}</label></div>':"")+'<div id="'+a.prefix+'{id}" class="sch-gantt-item sch-gantt-task-bar {internalcls} {cls}" unselectable="on" style="width:{width}px;{style}">'+(a.enableDependencyDragDrop?'<div unselectable="on" class="sch-gantt-terminal sch-gantt-terminal-start"></div>':"")+((a.resizeHandles==="both"||a.resizeHandles==="left")?'<div class="sch-resizable-handle sch-gantt-task-handle sch-resizable-handle-west"></div>':"")+'<div class="sch-gantt-progress-bar" style="width:{percentDone}%;{progressBarStyle}" unselectable="on">&#160;</div>'+((a.resizeHandles==="both"||a.resizeHandles==="right")?'<div class="sch-resizable-handle sch-gantt-task-handle sch-resizable-handle-east"></div>':"")+(a.enableDependencyDragDrop?'<div unselectable="on" class="sch-gantt-terminal sch-gantt-terminal-end"></div>':"")+(a.enableProgressBarResize?'<div style="left:{percentDone}%" class="sch-gantt-progressbar-handle"></div>':"")+"</div>"+(a.rightLabel?'<div class="sch-gantt-labelct sch-gantt-labelct-right" style="left:{width}px"><label class="sch-gantt-label sch-gantt-label-right">{rightLabel}</label></div>':"")+"</div>",{compiled:true,disableFormats:true}])}});Ext.define("Gnt.template.Milestone",{extend:"Ext.XTemplate",constructor:function(a){this.callParent(['<div class="sch-event-wrap '+a.baseCls+' x-unselectable" style="left:{leftOffset}px">'+(a.leftLabel?'<div class="sch-gantt-labelct sch-gantt-labelct-left"><label class="sch-gantt-label sch-gantt-label-left">{leftLabel}</label></div>':"")+(a.printable?('<img id="'+a.prefix+'{id}" src="'+a.imgSrc+'" class="sch-gantt-item sch-gantt-milestone-diamond {internalcls} {cls}" unselectable="on" style="{style}" />'):('<div id="'+a.prefix+'{id}" class="sch-gantt-item sch-gantt-milestone-diamond {internalcls} {cls}" unselectable="on" style="{style}">'+(a.enableDependencyDragDrop?'<div class="sch-gantt-terminal sch-gantt-terminal-start"></div><div class="sch-gantt-terminal sch-gantt-terminal-end"></div>':"")+"</div>"))+(a.rightLabel?'<div class="sch-gantt-labelct sch-gantt-labelct-right" style="left:{width}px"><label class="sch-gantt-label sch-gantt-label-right">{rightLabel}</label></div>':"")+"</div>",{compiled:true,disableFormats:true}])}});Ext.define("Gnt.template.ParentTask",{extend:"Ext.XTemplate",constructor:function(a){this.callParent(['<div class="sch-event-wrap '+a.baseCls+' x-unselectable" style="left:{leftOffset}px;width:{width}px">'+(a.leftLabel?'<div class="sch-gantt-labelct sch-gantt-labelct-left"><label class="sch-gantt-label sch-gantt-label-left">{leftLabel}</label></div>':"")+'<div id="'+a.prefix+'{id}" class="sch-gantt-item sch-gantt-parenttask-bar {internalcls} {cls}" style="{style}"><div class="sch-gantt-progress-bar" style="width:{percentDone}%;{progressBarStyle}">&#160;</div>'+(a.enableDependencyDragDrop?'<div class="sch-gantt-terminal sch-gantt-terminal-start"></div>':"")+'<div class="sch-gantt-parenttask-arrow sch-gantt-parenttask-leftarrow"></div><div class="sch-gantt-parenttask-arrow sch-gantt-parenttask-rightarrow"></div>'+(a.enableDependencyDragDrop?'<div class="sch-gantt-terminal sch-gantt-terminal-end"></div>':"")+"</div>"+(a.rightLabel?'<div class="sch-gantt-labelct sch-gantt-labelct-right" style="left:{width}px"><label class="sch-gantt-label sch-gantt-label-right">{rightLabel}</label></div>':"")+"</div>",{compiled:true,disableFormats:true}])}});Ext.define("Gnt.Tooltip",{extend:"Ext.ToolTip",requires:["Ext.Template"],startText:"Starts: ",endText:"Ends: ",durationText:"Duration:",mode:"startend",cls:"sch-tip",height:40,autoHide:false,anchor:"b-tl",initComponent:function(){if(this.mode==="startend"&&!this.startEndTemplate){this.startEndTemplate=new Ext.Template('<div class="sch-timetipwrap {cls}"><div>'+this.startText+"{startText}</div><div>"+this.endText+"{endText}</div></div>").compile()}if(this.mode==="duration"&&!this.durationTemplate){this.durationTemplate=new Ext.Template('<div class="sch-timetipwrap {cls}">',"<div>"+this.startText+" {startText}</div>","<div>"+this.durationText+" {duration} {unit}</div>","</div>").compile()}this.callParent(arguments)},update:function(e,b,d,a){var c;if(this.mode==="duration"){c=this.getDurationContent(e,b,d,a)}else{c=this.getStartEndContent(e,b,d,a)}this.callParent([c])},getStartEndContent:function(b,f,a,h){var e=this.gantt,i=e.getFormattedDate(b),d=i,g;if(f-b>0){d=e.getFormattedEndDate(f,b)}var c={cls:a?"sch-tip-ok":"sch-tip-notok",startText:i,endText:d};if(this.showClock){Ext.apply(c,{startHourDegrees:roundedStart.getHours()*30,startMinuteDegrees:roundedStart.getMinutes()*6});if(f){Ext.apply(c,{endHourDegrees:g.getHours()*30,endMinuteDegrees:g.getMinutes()*6})}}return this.startEndTemplate.apply(c)},getDurationContent:function(f,b,d,a){var c=a.getDurationUnit()||Sch.util.Date.DAY;var e=a.calculateDuration(f,b,c);return this.durationTemplate.apply({cls:d?"sch-tip-ok":"sch-tip-notok",startText:this.gantt.getFormattedDate(f),duration:parseFloat(Ext.Number.toFixed(e,1)),unit:Sch.util.Date.getReadableNameOfUnit(c,e>1)})},show:function(a){if(a){this.setTarget(a)}this.callParent([])}});Ext.define("Gnt.feature.TaskDragDrop",{extend:"Ext.dd.DragZone",requires:["Gnt.Tooltip","Ext.dd.StatusProxy","Ext.dd.ScrollManager"],onDragEnter:Ext.emptyFn,onDragOut:Ext.emptyFn,constructor:function(a){a=a||{};Ext.apply(this,a);this.proxy=this.proxy||Ext.create("Ext.dd.StatusProxy",{shadow:false,dropAllowed:"sch-gantt-dragproxy",dropNotAllowed:"sch-gantt-dragproxy",ensureAttachedToBody:Ext.emptyFn});var c=this,b=c.gantt;if(c.useTooltip){c.tip=Ext.create("Gnt.Tooltip",{gantt:b})}c.callParent([b.el,Ext.apply(a,{ddGroup:c.gantt.id+"-task-dd"})]);c.scroll=false;c.isTarget=true;c.ignoreSelf=false;c.addInvalidHandleClass("sch-resizable-handle");c.addInvalidHandleClass("x-resizable-handle");c.addInvalidHandleClass("sch-gantt-terminal");c.addInvalidHandleClass("sch-gantt-progressbar-handle");Ext.dd.ScrollManager.register(c.gantt.el);c.gantt.ownerCt.el.appendChild(this.proxy.el);c.gantt.on({destroy:c.cleanUp,scope:c})},useTooltip:true,validatorFn:function(a,b,d,c){return true},validatorFnScope:null,cleanUp:function(){if(this.gantt.dragZone){this.gantt.dragZone.destroy()}if(this.tip){this.tip.destroy()}},containerScroll:false,dropAllowed:"sch-gantt-dragproxy",dropNotAllowed:"sch-gantt-dragproxy",destroy:function(){this.callParent(arguments);Ext.dd.ScrollManager.unregister(this.gantt.el)},autoOffset:function(a,e){var d=this.dragData.repairXY,c=a-d[0],b=e-d[1];this.setDelta(c,b)},setXConstraint:function(c,b,a){this.leftConstraint=c;this.rightConstraint=b;this.minX=c;this.maxX=b;if(a){this.setXTicks(this.initPageX,a)}this.constrainX=true},setYConstraint:function(a,c,b){this.topConstraint=a;this.bottomConstraint=c;this.minY=a;this.maxY=c;if(b){this.setYTicks(this.initPageY,b)}this.constrainY=true},constrainTo:function(a,b){this.resetConstraints();this.initPageX=a.left;this.initPageY=b.top;this.setXConstraint(a.left,a.right-(b.right-b.left),this.xTickSize);this.setYConstraint(b.top-1,b.top-1,this.yTickSize)},onDragOver:function(g,h){var f=this.dragData,d=f.record,c=this.gantt,b=this.proxy.el.getX()+c.getXOffset(d),a=c.getDateFromXY([b,0],"round");if(!f.hidden){Ext.fly(f.sourceNode).hide();f.hidden=true}if(!a||a-f.start===0){return}f.start=a;this.valid=this.validatorFn.call(this.validatorFnScope||c,d,a,f.duration,g)!==false;if(this.tip){this.tip.update(a,d.calculateEndDate(a,d.getDuration(),d.getDurationUnit()),this.valid)}},onStartDrag:function(){var a=this.dragData.record;if(this.tip){this.tip.enable();this.tip.show(Ext.get(this.dragData.sourceNode));this.tip.update(a.getStartDate(),a.getEndDate(),true)}this.gantt.fireEvent("taskdragstart",this.gantt,a)},getDragData:function(i){var h=this.gantt,f=i.getTarget(h.eventSelector);if(f&&!i.getTarget(".sch-gantt-baseline-item")){var c=Ext.get(f),d=h.resolveTaskRecord(c);if(h.fireEvent("beforetaskdrag",h,d,i)===false){return null}var j=f.cloneNode(true),b=h.getSnapPixelAmount(),a=c.getXY();j.id=Ext.id();if(b<=1){Ext.fly(j).setStyle("left",0)}this.constrainTo(Ext.fly(h.findItemByChild(f)).getRegion(),c.getRegion());if(b>=1){this.setXConstraint(this.leftConstraint,this.rightConstraint,b)}return{sourceNode:f,repairXY:a,ddel:j,record:d,duration:Sch.util.Date.getDurationInMinutes(d.getStartDate(),d.getEndDate())}}return null},afterRepair:function(){Ext.fly(this.dragData.sourceNode).show();if(this.tip){this.tip.hide()}this.dragging=false},getRepairXY:function(){this.gantt.fireEvent("afterdnd",this.gantt);return this.dragData.repairXY},onDragDrop:function(h,j){var f=this.cachedTarget||Ext.dd.DragDropMgr.getDDById(j),d=this.dragData,c=this.gantt,b=d.record,i=d.start;var a=false;if(this.tip){this.tip.disable()}if(this.valid&&i&&b.getStartDate()-i!==0){this.gantt.taskStore.on("update",function(){a=true},null,{single:true});b.setStartDate(i,true,this.gantt.taskStore.skipWeekendsDuringDragDrop);if(a){c.fireEvent("taskdrop",c,b);this.onValidDrop(f,h,j)}}if(!a){this.onInvalidDrop(f,h,j)}c.fireEvent("aftertaskdrop",c,b)}});Ext.define("Gnt.feature.DependencyDragDrop",{extend:"Ext.util.Observable",constructor:function(b){this.addEvents("beforednd","dndstart","drop","afterdnd");var a=b.ganttView;Ext.apply(this,{el:a.el.parent(),ddGroup:a.id+"-sch-dependency-dd",ganttView:a,dependencyStore:a.getDependencyStore()});this.el.on("mousemove",function(){this.setupDragZone();this.setupDropZone()},this,{single:true});this.callParent(arguments)},fromText:"From: <strong>{0}</strong> {1}<br/>",toText:"To: <strong>{0}</strong> {1}",startText:"Start",endText:"End",useLineProxy:true,terminalSelector:".sch-gantt-terminal",destroy:function(){if(this.dragZone){this.dragZone.destroy()}if(this.dropZone){this.dropZone.destroy()}if(this.lineProxyEl){this.lineProxyEl.destroy()}},initLineProxy:function(b,a){var c=this.lineProxyEl=this.el.createChild({cls:"sch-gantt-connector-proxy"});c.alignTo(b,a?"l":"r");Ext.apply(this,{containerTop:this.el.getTop(),containerLeft:this.el.getLeft(),startXY:c.getXY(),startScrollLeft:this.el.dom.scrollLeft,startScrollTop:this.el.dom.scrollTop})},updateLineProxy:function(k){var a=this.lineProxyEl,h=k[0]-this.startXY[0]+this.el.dom.scrollLeft-this.startScrollLeft,g=k[1]-this.startXY[1]+this.el.dom.scrollTop-this.startScrollTop,b=Math.max(1,Math.sqrt(Math.pow(h,2)+Math.pow(g,2))-2),f=Math.atan2(g,h)-(Math.PI/2),d;if(Ext.isIE){var i=Math.cos(f),e=Math.sin(f),j='progid:DXImageTransform.Microsoft.Matrix(sizingMethod="auto expand", M11 = '+i+", M12 = "+(-e)+", M21 = "+e+", M22 = "+i+")";d={height:b+"px",top:Math.min(0,g)+this.startXY[1]-this.containerTop+(g<0?2:0)+"px",left:Math.min(0,h)+this.startXY[0]-this.containerLeft+(h<0?2:0)+"px",filter:j,"-ms-filter":j}}else{var c="rotate("+f+"rad)";d={height:b+"px","-o-transform":c,"-webkit-transform":c,"-moz-transform":c,transform:c}}a.show().setStyle(d)},setupDragZone:function(){var b=this,a=this.ganttView;this.dragZone=Ext.create("Ext.dd.DragZone",this.el,{ddGroup:this.ddGroup,onStartDrag:function(){this.el.addCls("sch-gantt-dep-dd-dragging");b.fireEvent("dndstart",b);if(b.useLineProxy){var c=this.dragData;b.initLineProxy(c.sourceNode,c.isStart)}},getDragData:function(g){var f=g.getTarget(b.terminalSelector);if(f){var d=a.resolveTaskRecord(f);if(b.fireEvent("beforednd",this,d)===false){return null}var c=!!f.className.match("sch-gantt-terminal-start"),h=Ext.core.DomHelper.createDom({cls:"sch-dd-dependency",children:[{tag:"span",cls:"sch-dd-dependency-from",html:Ext.String.format(b.fromText,d.getName(),c?b.startText:b.endText)},{tag:"span",cls:"sch-dd-dependency-to",html:Ext.String.format(b.toText,"","")}]});return{fromId:d.getId()||d.internalId,isStart:c,repairXY:Ext.fly(f).getXY(),ddel:h,sourceNode:Ext.fly(f).up(a.eventSelector)}}return false},afterRepair:function(){this.el.removeCls("sch-gantt-dep-dd-dragging");this.dragging=false;b.fireEvent("afterdnd",this)},onMouseUp:function(){this.el.removeCls("sch-gantt-dep-dd-dragging");if(b.lineProxyEl){if(Ext.isIE){Ext.destroy(b.lineProxyEl);b.lineProxyEl=null}else{b.lineProxyEl.animate({to:{height:0},duration:500,callback:function(){Ext.destroy(b.lineProxyEl);b.lineProxyEl=null}})}}},getRepairXY:function(){return this.dragData.repairXY}})},setupDropZone:function(){var b=this,a=this.ganttView;this.dropZone=Ext.create("Ext.dd.DropZone",this.el,{ddGroup:this.ddGroup,getTargetFromEvent:function(c){if(b.useLineProxy){b.updateLineProxy(c.getXY())}return c.getTarget(b.terminalSelector)},onNodeEnter:function(h,c,g,f){var d=h.className.match("sch-gantt-terminal-start");Ext.fly(h).addCls(d?"sch-gantt-terminal-start-drophover":"sch-gantt-terminal-end-drophover")},onNodeOut:function(h,c,g,f){var d=h.className.match("sch-gantt-terminal-start");Ext.fly(h).removeCls(d?"sch-gantt-terminal-start-drophover":"sch-gantt-terminal-end-drophover")},onNodeOver:function(k,c,j,i){var d=a.resolveTaskRecord(k),f=d.getId()||d.internalId,g=k.className.match("sch-gantt-terminal-start"),h=Ext.String.format(b.toText,d.getName(),g?b.startText:b.endText);c.proxy.el.down(".sch-dd-dependency-to").update(h);if(b.dependencyStore.isValidDependency(i.fromId,f)){return this.dropAllowed}else{return this.dropNotAllowed}},onNodeDrop:function(h,l,i,f){var j,c=true,d=Gnt.model.Dependency.Type,g=a.resolveTaskRecord(h),k=g.getId()||g.internalId;if(b.lineProxyEl){Ext.destroy(b.lineProxyEl);b.lineProxyEl=null}this.el.removeCls("sch-gantt-dep-dd-dragging");if(f.isStart){if(h.className.match("sch-gantt-terminal-start")){j=d.StartToStart}else{j=d.StartToEnd}}else{if(h.className.match("sch-gantt-terminal-start")){j=d.EndToStart}else{j=d.EndToEnd}}c=b.dependencyStore.isValidDependency(f.fromId,k);if(c){b.fireEvent("drop",this,f.fromId,k,j)}b.fireEvent("afterdnd",this);return c}})}});Ext.define("Gnt.feature.DragCreator",{requires:["Ext.Template","Sch.util.DragTracker","Gnt.Tooltip"],constructor:function(a){Ext.apply(this,a||{});this.init()},disabled:false,showDragTip:true,dragTolerance:2,setDisabled:function(a){this.disabled=a;if(this.dragTip){this.dragTip.setDisabled(a)}},getProxy:function(){if(!this.proxy){this.proxy=this.template.append(this.ganttView.el,{},true)}return this.proxy},onBeforeDragStart:function(f){var c=this.ganttView,b=f.getTarget("."+c.timeCellCls,2);if(b){var a=c.resolveTaskRecord(b);var d=c.getDateFromDomEvent(f);if(!this.disabled&&b&&!a.getStartDate()&&!a.getEndDate()&&c.fireEvent("beforedragcreate",c,a,d,f)!==false){f.stopEvent();this.taskRecord=a;this.originalStart=d;this.rowRegion=c.getScheduleRegion(this.taskRecord,this.originalStart);this.dateConstraints=c.getDateConstraints(this.resourceRecord,this.originalStart);return true}}return false},onDragStart:function(){var c=this,a=c.ganttView,b=c.getProxy();c.start=c.originalStart;c.end=c.start;if(a.getOrientation()==="horizontal"){c.rowBoundaries={top:c.rowRegion.top,bottom:c.rowRegion.bottom};b.setRegion({top:c.rowBoundaries.top,right:c.tracker.startXY[0],bottom:c.rowBoundaries.bottom,left:c.tracker.startXY[0]})}else{c.rowBoundaries={left:c.rowRegion.left,right:c.rowRegion.right};b.setRegion({top:c.tracker.startXY[1],right:c.rowRegion.right,bottom:c.tracker.startXY[1],left:c.rowRegion.left})}b.show();c.ganttView.fireEvent("dragcreatestart",c.ganttView);if(c.showDragTip){c.dragTip.update(c.start,c.end,true,this.taskRecord);c.dragTip.enable();c.dragTip.show(b)}},onDrag:function(g){var d=this,c=d.ganttView,b=d.tracker.getRegion().constrainTo(d.rowRegion),f=c.getStartEndDatesFromRegion(b,"round");if(!f){return}d.start=f.start||d.start;d.end=f.end||d.end;var a=d.dateConstraints;if(a){d.end=Sch.util.Date.constrain(d.end,a.start,a.end);d.start=Sch.util.Date.constrain(d.start,a.start,a.end)}if(d.showDragTip){d.dragTip.update(d.start,d.end,true,this.taskRecord)}Ext.apply(b,d.rowBoundaries);this.getProxy().setRegion(b)},onDragEnd:function(b){var c=this.ganttView,a=true;if(this.showDragTip){this.dragTip.disable()}if(!this.start||!this.end||(this.end<this.start)){a=false}if(a){this.taskRecord.setStartEndDate(this.start,this.end);c.fireEvent("dragcreateend",c,this.taskRecord,b)}this.proxy.hide();c.fireEvent("afterdragcreate",c)},init:function(){var c=this.ganttView,a=c.el,b=Ext.Function.bind;this.lastTime=new Date();this.template=this.template||Ext.create("Ext.Template",'<div class="sch-gantt-dragcreator-proxy"></div>',{compiled:true,disableFormats:true});c.on({destroy:this.onGanttDestroy,scope:this});this.tracker=new Sch.util.DragTracker({el:a,tolerance:this.dragTolerance,onBeforeStart:b(this.onBeforeDragStart,this),onStart:b(this.onDragStart,this),onDrag:b(this.onDrag,this),onEnd:b(this.onDragEnd,this)});if(this.showDragTip){this.dragTip=Ext.create("Gnt.Tooltip",{mode:"duration",cls:"sch-gantt-dragcreate-tip",gantt:c})}},onGanttDestroy:function(){if(this.dragTip){this.dragTip.destroy()}if(this.tracker){this.tracker.destroy()}if(this.proxy){Ext.destroy(this.proxy);this.proxy=null}}});Ext.define("Gnt.feature.LabelEditor",{extend:"Ext.Editor",labelPosition:"",constructor:function(b,a){this.ganttView=b;this.ganttView.on("afterrender",this.onGanttRender,this);this.callParent([a])},edit:function(a){var b=this.ganttView.getElementFromEventRecord(a).up(this.ganttView.eventWrapSelector);this.record=a;this.startEdit(b.down(this.delegate),this.dataIndex?a.get(this.dataIndex):"")},delegate:"",dataIndex:"",shadow:false,completeOnEnter:true,cancelOnEsc:true,ignoreNoChange:true,onGanttRender:function(a){if(!this.field.width){this.autoSize="width"}this.on({beforestartedit:function(c,b,d){return a.fireEvent("labeledit_beforestartedit",a,this.record,d,c)},beforecomplete:function(c,d,b){return a.fireEvent("labeledit_beforecomplete",a,d,b,this.record,c)},complete:function(c,d,b){this.record.set(this.dataIndex,d);a.fireEvent("labeledit_complete",a,d,b,this.record,c)},scope:this});a.el.on("dblclick",function(c,b){this.edit(a.resolveTaskRecord(b))},this,{delegate:this.delegate})}});Ext.define("Gnt.feature.ProgressBarResize",{requires:["Ext.QuickTip","Ext.resizer.Resizer"],constructor:function(a){Ext.apply(this,a||{});var b=this.gantt;b.on({destroy:this.cleanUp,scope:this});b.mon(b.el,"mousedown",this.onMouseDown,this,{delegate:".sch-gantt-progressbar-handle"});this.callParent(arguments)},useTooltip:true,increment:10,onMouseDown:function(d,b){var c=this.gantt,f=c.resolveTaskRecord(b);if(c.fireEvent("beforeprogressbarresize",c,f)!==false){var a=Ext.fly(b).prev(".sch-gantt-progress-bar");d.stopEvent();this.createResizable(a,f,d);c.fireEvent("progressbarresizestart",c,f)}},createResizable:function(d,a,h){var c=h.getTarget(),i=d.up(this.gantt.eventSelector),g=i.getWidth()-2,b=g*this.increment/100;var f=Ext.create("Ext.resizer.Resizer",{target:d,taskRecord:a,handles:"e",minWidth:0,maxWidth:g,maxHeight:d.getHeight(),widthIncrement:b,listeners:{resizedrag:this.partialResize,resize:this.afterResize,scope:this}});f.resizeTracker.onMouseDown(h,f.east.dom);i.select(".x-resizable-handle, .sch-gantt-terminal, .sch-gantt-progressbar-handle").hide();if(this.useTooltip){if(!this.tip){this.tip=Ext.create("Ext.ToolTip",{autoHide:false,anchor:"b",html:"%"})}this.tip.setTarget(d);this.tip.show();this.tip.body.update(a.getPercentDone()+"%")}},partialResize:function(c,b){var a=Math.round(b*100/(c.maxWidth*this.increment))*this.increment;if(this.tip){this.tip.body.update(a+"%")}},afterResize:function(d,a,b,f){var g=d.taskRecord;if(this.tip){this.tip.hide()}var c=Math.round(a*100/(d.maxWidth*this.increment))*this.increment;d.taskRecord.setPercentDone(c);d.destroy();this.gantt.fireEvent("afterprogressbarresize",this.gantt,g)},cleanUp:function(){if(this.tip){this.tip.destroy()}}});Ext.define("Gnt.feature.TaskResize",{constructor:function(a){Ext.apply(this,a);var b=this.gantt;b.on({destroy:this.cleanUp,scope:this});b.mon(b.el,"mousedown",this.onMouseDown,this,{delegate:".sch-resizable-handle"});this.callParent(arguments)},showDuration:true,useTooltip:true,validatorFn:Ext.emptyFn,validatorFnScope:null,onMouseDown:function(c){var b=this.gantt,a=c.getTarget(b.eventSelector),d=b.resolveTaskRecord(a);if(b.fireEvent("beforetaskresize",b,d,c)===false){return}c.stopEvent();this.createResizable(Ext.get(a),d,c);b.fireEvent("taskresizestart",b,d)},createResizable:function(c,k,j){var m=j.getTarget(),i=this.gantt,a=!!m.className.match("sch-resizable-handle-west"),d=i.getSnapPixelAmount(),f=c.getWidth(),l=c.up(".x-grid-row").getRegion();this.resizable=Ext.create("Ext.resizer.Resizer",{startLeft:c.getLeft(),startRight:c.getRight(),target:c,maxHeight:c.getHeight(),taskRecord:k,handles:a?"w":"e",constrainTo:l,minWidth:d,widthIncrement:d,listeners:{resizedrag:this[a?"partialWestResize":"partialEastResize"],resize:this.afterResize,scope:this}});this.resizable.resizeTracker.onMouseDown(j,this.resizable[a?"west":"east"].dom);if(this.useTooltip){if(!this.tip){this.tip=Ext.create("Gnt.Tooltip",{mode:this.showDuration?"duration":"startend",gantt:this.gantt})}var b=k.getStartDate(),h=k.getEndDate();this.tip.show(c);this.tip.update(b,h,true,k)}},partialEastResize:function(i,f,b,g){var c=this.gantt,a=c.getDateFromXY([i.startLeft+Math.min(f,this.resizable.maxWidth),0],"round");if(!a||i.end-a===0){return}var h=i.taskRecord.getStartDate(),d=this.validatorFn.call(this.validatorFnScope||this,i.taskRecord,h,a)!==false;i.end=a;c.fireEvent("partialtaskresize",c,i.taskRecord,h,a,i.el,g);if(this.useTooltip){this.tip.update(h,a,d,i.taskRecord)}},partialWestResize:function(i,f,b,g){var c=this.gantt,h=c.getDateFromXY([i.startRight-Math.min(f,this.resizable.maxWidth),0],"round");if(!h||i.start-h===0){return}var a=i.taskRecord.getEndDate(),d=this.validatorFn.call(this.validatorFnScope||this,i.taskRecord,h,a)!==false;i.start=h;c.fireEvent("partialtaskresize",c,i.taskRecord,h,a,i.el,g);if(this.useTooltip){this.tip.update(h,a,d,i.taskRecord)}},afterResize:function(a,l,i,j){if(this.useTooltip){this.tip.hide()}var k=a.taskRecord,g=k.getStartDate(),m=k.getEndDate(),c=a.start||g,f=a.end||m,d=this.gantt;a.destroy();if(c&&f&&(f-c>=0)&&(c-g||f-m)&&this.validatorFn.call(this.validatorFnScope||this,k,c,f,j)!==false){var b=this.gantt.taskStore.skipWeekendsDuringDragDrop;if(c-g!==0){k.setStartDate(c,false,b)}else{k.setEndDate(f,false,b)}}else{d.refreshKeepingScroll()}d.fireEvent("aftertaskresize",d,k)},cleanUp:function(){if(this.tip){this.tip.destroy()}}});Ext.define("Gnt.feature.WorkingTime",{extend:"Sch.plugin.Zones",requires:["Ext.data.Store","Sch.model.Range"],calendar:null,init:function(a){if(!this.calendar){Ext.Error.raise("Required attribute 'calendar' missed during initialization of 'Gnt.feature.WorkingTime'")}this.bindCalendar(this.calendar);Ext.apply(this,{store:new Ext.data.Store({model:"Sch.model.Range"})});this.callParent(arguments);a.on("viewchange",this.onViewChange,this);this.onViewChange()},bindCalendar:function(b){var a={datachanged:this.refresh,scope:this,delay:1};if(this.calendar){this.calendar.un(a)}b.on(a);this.calendar=b},onViewChange:function(){var a=Sch.util.Date;if(a.compareUnits(this.timeAxis.unit,a.WEEK)>0){this.setDisabled(true)}else{this.setDisabled(false);this.refresh()}},refresh:function(){var a=this.schedulerView;this.store.removeAll(true);this.store.add(this.calendar.getHolidaysRanges(a.getStart(),a.getEnd(),true))}});Ext.define("Gnt.plugin.DependencyEditor",{extend:"Ext.form.FormPanel",requires:["Ext.form.DisplayField","Ext.form.ComboBox","Ext.form.NumberField","Gnt.model.Dependency"],hideOnBlur:true,fromText:"From",toText:"To",typeText:"Type",lagText:"Lag",endToStartText:"Finish-To-Start",startToStartText:"Start-To-Start",endToEndText:"Finish-To-Finish",startToEndText:"Start-To-Finish",showLag:false,border:false,height:150,width:260,frame:true,labelWidth:60,constrain:false,initComponent:function(){Ext.apply(this,{items:this.buildFields(),defaults:{width:240},floating:true,hideMode:"offsets"});this.callParent(arguments)},beforeRender:function(){this.addCls("sch-gantt-dependencyeditor");this.callParent(arguments)},init:function(a){a.on("dependencydblclick",this.onDependencyDblClick,this);a.on("render",this.onGanttRender,this,{delay:50});this.gantt=a;this.taskStore=a.getTaskStore()},onGanttRender:function(){this.render(Ext.getBody());this.collapse(Ext.Component.DIRECTION_TOP,true);this.hide();if(this.hideOnBlur){this.mon(Ext.getBody(),"click",this.onMouseClick,this)}},show:function(a,b){this.dependencyRecord=a;this.getForm().loadRecord(a);this.fromLabel.setValue(this.dependencyRecord.getSourceTask().getName());this.toLabel.setValue(this.dependencyRecord.getTargetTask().getName());this.callParent([]);this.el.setXY(b);this.expand(!this.constrain);if(this.constrain){this.doConstrain(Ext.util.Region.getRegion(Ext.getBody()))}},buildFields:function(){var c=this,d=Gnt.model.Dependency,b=d.Type,a=[this.fromLabel=Ext.create("Ext.form.DisplayField",{fieldLabel:this.fromText}),this.toLabel=Ext.create("Ext.form.DisplayField",{fieldLabel:this.toText}),this.typeField=Ext.create("Ext.form.ComboBox",{name:d.prototype.nameField,fieldLabel:this.typeText,triggerAction:"all",queryMode:"local",valueField:"value",displayField:"text",editable:false,store:Ext.create("Ext.data.JsonStore",{fields:["text","value"],data:[{text:this.endToStartText,value:b.EndToStart},{text:this.startToStartText,value:b.StartToStart},{text:this.endToEndText,value:b.EndToEnd},{text:this.startToEndText,value:b.StartToEnd}]})})];if(this.showLag){a.push(this.lagField=Ext.create("Ext.form.NumberField",{name:d.prototype.lagField,fieldLabel:this.lagText}))}return a},onDependencyDblClick:function(c,a,d,b){if(this.lagField){this.lagField.name=a.lagField}if(this.typeField){this.typeField.name=a.typeField}if(a!=this.dependencyRecord){this.show(a,d.getXY())}},onMouseClick:function(a){if(this.collapsed||a.within(this.getEl())||a.getTarget(".x-layer")||a.getTarget(".sch-ignore-click")){return}this.collapse()},afterCollapse:function(){delete this.dependencyRecord;this.hide();this.callParent(arguments)}});Ext.define("Gnt.plugin.TaskContextMenu",{extend:"Ext.menu.Menu",requires:["Gnt.model.Dependency"],plain:true,triggerEvent:"taskcontextmenu",texts:{newTaskText:"New task",newMilestoneText:"New milestone",deleteTask:"Delete task(s)",editLeftLabel:"Edit left label",editRightLabel:"Edit right label",add:"Add...",deleteDependency:"Delete dependency...",addTaskAbove:"Task above",addTaskBelow:"Task below",addMilestone:"Milestone",addSubtask:"Sub-task",addSuccessor:"Successor",addPredecessor:"Predecessor"},grid:null,rec:null,lastHighlightedItem:null,createMenuItems:function(){var a=this.texts;return[{handler:this.deleteTask,requiresTask:true,scope:this,text:a.deleteTask},{handler:this.editLeftLabel,requiresTask:true,scope:this,text:a.editLeftLabel},{handler:this.editRightLabel,requiresTask:true,scope:this,text:a.editRightLabel},{text:a.add,menu:{plain:true,items:[{handler:this.addTaskAboveAction,requiresTask:true,scope:this,text:a.addTaskAbove},{handler:this.addTaskBelowAction,scope:this,text:a.addTaskBelow},{handler:this.addMilestone,scope:this,text:a.addMilestone},{handler:this.addSubtask,requiresTask:true,scope:this,text:a.addSubtask},{handler:this.addSuccessor,requiresTask:true,scope:this,text:a.addSuccessor},{handler:this.addPredecessor,requiresTask:true,scope:this,text:a.addPredecessor}]}},{text:a.deleteDependency,requiresTask:true,menu:{plain:true,listeners:{beforeshow:this.populateDependencyMenu,mouseover:this.onDependencyMouseOver,mouseleave:this.onDependencyMouseOut,scope:this}}}]},buildMenuItems:function(){this.items=this.createMenuItems()},initComponent:function(){this.buildMenuItems();this.callParent(arguments)},init:function(b){b.on("destroy",this.cleanUp,this);var a=b.getSchedulingView(),c=b.lockedGrid.getView();if(this.triggerEvent==="itemcontextmenu"){c.on("itemcontextmenu",this.onItemContextMenu,this);a.on("itemcontextmenu",this.onItemContextMenu,this)}else{a.on("taskcontextmenu",this.onTaskContextMenu,this)}a.on("containercontextmenu",this.onContainerContextMenu,this);c.on("containercontextmenu",this.onContainerContextMenu,this);this.grid=b},populateDependencyMenu:function(f){var d=this.grid,b=d.getTaskStore(),e=this.rec.getAllDependencies(),a=d.dependencyStore;f.removeAll();if(e.length===0){return false}var c=this.rec.getId()||this.rec.internalId;Ext.each(e,function(i){var h=i.getSourceId(),g=b.getById(h==c?i.getTargetId():h);if(g){f.add({depId:i.internalId,text:Ext.util.Format.ellipsis(g.getName(),30),scope:this,handler:function(k){var j;a.each(function(l){if(l.internalId==k.depId){j=l;return false}});a.remove(j)}})}},this)},onDependencyMouseOver:function(d,a,b){if(a){var c=this.grid.getSchedulingView();if(this.lastHighlightedItem){c.unhighlightDependency(this.lastHighlightedItem.depId)}this.lastHighlightedItem=a;c.highlightDependency(a.depId)}},onDependencyMouseOut:function(b,a){if(this.lastHighlightedItem){this.grid.getSchedulingView().unhighlightDependency(this.lastHighlightedItem.depId)}},cleanUp:function(){this.destroy()},onTaskContextMenu:function(b,a,c){this.activateMenu(a,c)},onItemContextMenu:function(b,a,d,c,f){this.activateMenu(a,f)},onContainerContextMenu:function(a,b){this.activateMenu(null,b)},activateMenu:function(c,b){b.stopEvent();this.rec=c;var a=this.query("[requiresTask]");Ext.each(a,function(d){d.setDisabled(!c)});this.showAt(b.getXY())},copyTask:function(c){var b=this.grid.getTaskStore().model;var a=new b({leaf:true});a.setPercentDone(0);a.setName(this.texts.newTaskText);a.set(a.startDateField,(c&&c.getStartDate())||null);a.set(a.endDateField,(c&&c.getEndDate())||null);a.set(a.durationField,(c&&c.getDuration())||null);a.set(a.durationUnitField,(c&&c.getDurationUnit())||"d");return a},addTaskAbove:function(a){var b=this.rec;if(b){b.addTaskAbove(a)}else{this.grid.taskStore.getRootNode().appendChild(a)}},addTaskBelow:function(a){var b=this.rec;if(b){b.addTaskBelow(a)}else{this.grid.taskStore.getRootNode().appendChild(a)}},deleteTask:function(){var a=this.grid.getSelectionModel().selected;a.each(function(b){b.remove()})},editLeftLabel:function(){this.grid.getSchedulingView().editLeftLabel(this.rec)},editRightLabel:function(){this.grid.getSchedulingView().editRightLabel(this.rec)},addTaskAboveAction:function(){this.addTaskAbove(this.copyTask(this.rec))},addTaskBelowAction:function(){this.addTaskBelow(this.copyTask(this.rec))},addSubtask:function(){var a=this.rec;a.addSubtask(this.copyTask(a))},addSuccessor:function(){var a=this.rec;a.addSuccessor(this.copyTask(a))},addPredecessor:function(){var a=this.rec;a.addPredecessor(this.copyTask(a))},addMilestone:function(){var b=this.rec,a=this.copyTask(b);this.addTaskBelow(a);a.setStartDate(a.getEndDate(),false)}});Ext.define("Gnt.plugin.Printable",{extend:"Sch.plugin.Printable",getGridContent:function(b){var e=this.callParent(arguments),c=b.getSchedulingView(),d=c.dependencyView,a=d.painter.getDependencyTplData(c.dependencyStore.getRange());e.normalRows+=d.lineTpl.apply(a);return e}});Ext.define("Gnt.view.DependencyPainter",{extend:"Ext.util.Observable",requires:["Ext.util.Region"],constructor:function(a){a=a||{};Ext.apply(this,a,{xOffset:8,yOffset:7,midRowOffset:6,arrowOffset:8})},getTaskBox:function(a){var h=Sch.util.Date,m=a.getStartDate(),b=a.getEndDate(),e=this.ganttView.getStart(),k=this.ganttView.getEnd();if(!a.isVisible()||!m||!b||!h.intersectSpans(m,b,e,k)){return null}var l=this.ganttView,c=l.getXYFromDate(h.max(m,e))[0],j=l.getXYFromDate(h.min(b,k))[0],g=Ext.get(l.getEventNodeByRecord(a)||l.getNode(a));if(!g){return null}var f=this.view.getXOffset(a),d=g.getOffsetsTo(l.el),i=d[1]+l.el.getScroll().top;if(c>f){c-=f}j+=f-1;return Ext.create("Ext.util.Region",i,j,i+g.getHeight(),c)},getDependencyTplData:function(c){var n=this,j=n.taskStore;if(!Ext.isArray(c)){c=[c]}if(c.length===0||j.getCount()<=0){return}var d=[],b=Gnt.model.Dependency.Type,o=n.ganttView,p,k,g,m,h,a;for(var f=0,e=c.length;f<e;f++){a=c[f];k=a.getSourceTask();g=a.getTargetTask();if(k&&g){m=n.getTaskBox(k);h=n.getTaskBox(g);if(m&&h){switch(a.getType()){case b.StartToEnd:p=n.getStartToEndCoordinates(m,h);break;case b.StartToStart:p=n.getStartToStartCoordinates(m,h);break;case b.EndToStart:p=n.getEndToStartCoordinates(m,h);break;case b.EndToEnd:p=n.getEndToEndCoordinates(m,h);break;default:throw"Invalid dependency type: "+a.getType()}if(p){d.push({lineCoordinates:p,id:a.internalId,cls:a.getCls()})}}}}return d},intersectsViewport:function(f,d,b,a){var e=this.taskStore.indexOf(f),c=this.taskStore.indexOf(d);return !((e<b&&c<b)||(e>a&&c>a))},getStartToStartCoordinates:function(e,d,c,i){var b=e.left,g=e.top-1+((e.bottom-e.top)/2),a=d.left,f=d.top-1+((d.bottom-d.top)/2),h=e.top<d.top?(f-this.yOffset-this.midRowOffset):(f+this.yOffset+this.midRowOffset),j=this.xOffset+this.arrowOffset;if(b>(a+this.xOffset)){j+=(b-a)}return[{x1:b,y1:g,x2:b-j,y2:g},{x1:b-j,y1:g,x2:b-j,y2:f},{x1:b-j,y1:f,x2:a-this.arrowOffset,y2:f}]},getStartToEndCoordinates:function(f,e){var c=f.left,i=f.top-1+((f.bottom-f.top)/2),a=e.right,g=e.top-1+((e.bottom-e.top)/2),j=f.top<e.top?(g-this.yOffset-this.midRowOffset):(g+this.yOffset+this.midRowOffset),h,b;if(a>(c+this.xOffset-this.arrowOffset)||Math.abs(a-c)<(2*(this.xOffset+this.arrowOffset))){b=c-this.xOffset-this.arrowOffset;var d=a+this.xOffset+this.arrowOffset;h=[{x1:c,y1:i,x2:b,y2:i},{x1:b,y1:i,x2:b,y2:j},{x1:b,y1:j,x2:d,y2:j},{x1:d,y1:j,x2:d,y2:g},{x1:d,y1:g,x2:a+this.arrowOffset,y2:g}]}else{b=c-this.xOffset-this.arrowOffset;h=[{x1:c,y1:i,x2:b,y2:i},{x1:b,y1:i,x2:b,y2:g},{x1:b,y1:g,x2:a+this.arrowOffset,y2:g}]}return h},getEndToStartCoordinates:function(f,e){var c=f.right,i=f.top-1+((f.bottom-f.top)/2),a=e.left,g=e.top-1+((e.bottom-e.top)/2),j=f.top<e.top?(g-this.yOffset-this.midRowOffset):(g+this.yOffset+this.midRowOffset),h,b;if(a>=(c-6)&&g>i){b=Math.max(c-6,a)+this.xOffset;g=e.top;h=[{x1:c,y1:i,x2:b,y2:i},{x1:b,y1:i,x2:b,y2:g-this.arrowOffset}]}else{b=c+this.xOffset+this.arrowOffset;var d=a-this.xOffset-this.arrowOffset;h=[{x1:c,y1:i,x2:b,y2:i},{x1:b,y1:i,x2:b,y2:j},{x1:b,y1:j,x2:d,y2:j},{x1:d,y1:j,x2:d,y2:g},{x1:d,y1:g,x2:a-this.arrowOffset,y2:g}]}return h},getEndToEndCoordinates:function(a,c){var d=a.right,f=a.top-1+((a.bottom-a.top)/2),b=c.right+this.arrowOffset,e=c.top-1+((c.bottom-c.top)/2),g=b+this.xOffset+this.arrowOffset;if(d>(b+this.xOffset)){g+=d-b}return[{x1:d,y1:f,x2:g,y2:f},{x1:g,y1:f,x2:g,y2:e},{x1:g,y1:e,x2:b,y2:e}]}});Ext.define("Gnt.view.Dependency",{extend:"Ext.util.Observable",requires:["Gnt.feature.DependencyDragDrop","Gnt.view.DependencyPainter"],ganttView:null,painter:null,taskStore:null,store:null,dnd:null,lineTpl:null,enableDependencyDragDrop:true,renderAllDepsBuffered:false,dependencyCls:"sch-dependency",selectedCls:"sch-dependency-selected",constructor:function(a){a=a||{};Ext.apply(this,a);var b=this.ganttView;this.taskStore=b.getTaskStore();b.on({refresh:this.renderAllDependenciesBuffered,scope:this});this.taskStore.on({"root-fill-start":this.unBindTaskStore,"root-fill-end":this.bindTaskStore,scope:this});this.bindTaskStore();this.bindDependencyStore();if(!this.lineTpl){this.lineTpl=Ext.create("Ext.XTemplate",'<tpl for=".">'+Ext.String.format('<tpl for="lineCoordinates"><div class="{0} sch-dep-{parent.id} {0}-line {parent.cls}-line " style="left:{[Math.min(values.x1, values.x2)]}px;top:{[Math.min(values.y1, values.y2)]}px;width:{[Math.abs(values.x1-values.x2)'+(Ext.isBorderBox?"+2":"")+"]}px;height:{[Math.abs(values.y1-values.y2)"+(Ext.isBorderBox?"+2":"")+']}px"></div></tpl><div style="left:{[values.lineCoordinates[values.lineCoordinates.length - 1].x2]}px;top:{[values.lineCoordinates[values.lineCoordinates.length - 1].y2]}px" class="{0}-arrow-ct {0} sch-dep-{id} {cls}-arrow-ct"><img src="'+Ext.BLANK_IMAGE_URL+'" class="{0}-arrow {0}-arrow-{[this.getArrowDirection(values.lineCoordinates)]} {cls}-arrow" /></div>',this.dependencyCls)+"</tpl>",{compiled:true,disableFormats:true,getArrowDirection:function(d){var c=d[d.length-1];if(c.x1===c.x2){return"down"}else{if(c.x1>c.x2){return"left"}else{return"right"}}}})}this.painter=Ext.create("Gnt.view.DependencyPainter",Ext.apply({rowHeight:b.rowHeight,taskStore:this.taskStore,view:b},a));this.addEvents("beforednd","dndstart","drop","afterdnd","beforecascade","cascade","dependencydblclick");if(this.enableDependencyDragDrop){this.dnd=Ext.create("Gnt.feature.DependencyDragDrop",{ganttView:this.ganttView});this.dnd.on("drop",this.onDependencyDrop,this);this.relayEvents(this.dnd,["beforednd","dndstart","afterdnd","drop"])}this.ganttView.mon(this.containerEl,"dblclick",this.onDependencyDblClick,this,{delegate:"."+this.dependencyCls});this.callParent(arguments)},bindDependencyStore:function(){this.store.on({datachanged:this.renderAllDependenciesBuffered,load:this.renderAllDependenciesBuffered,add:this.onDependencyAdd,update:this.onDependencyUpdate,remove:this.onDependencyDelete,scope:this})},unBindDependencyStore:function(){this.store.un({datachanged:this.renderAllDependenciesBuffered,load:this.renderAllDependenciesBuffered,add:this.onDependencyAdd,update:this.onDependencyUpdate,remove:this.onDependencyDelete,scope:this})},bindTaskStore:function(){var a=this.taskStore;var b=this.ganttView;if(b.animate){b.on({afterexpand:this.renderAllDependenciesBuffered,aftercollapse:this.renderAllDependenciesBuffered,scope:this})}else{a.on({expand:this.renderAllDependenciesBuffered,collapse:this.renderAllDependenciesBuffered,scope:this})}a.on({cascade:function(c,d){if(d&&d.nbrAffected>0){this.renderAllDependenciesBuffered()}},remove:this.renderAllDependenciesBuffered,insert:this.renderAllDependenciesBuffered,append:this.renderAllDependenciesBuffered,move:this.renderAllDependenciesBuffered,scope:this});a.on({update:this.onTaskUpdated,scope:this})},unBindTaskStore:function(){var a=this.taskStore;var b=this.ganttView;if(b.animate){b.un({afterexpand:this.renderAllDependenciesBuffered,aftercollapse:this.renderAllDependenciesBuffered,scope:this})}else{a.un({expand:this.renderAllDependenciesBuffered,collapse:this.renderAllDependenciesBuffered,scope:this})}a.un({cascade:this.renderAllDependenciesBuffered,remove:this.renderAllDependenciesBuffered,insert:this.renderAllDependenciesBuffered,append:this.renderAllDependenciesBuffered,move:this.renderAllDependenciesBuffered,scope:this});a.un({update:this.onTaskUpdated,scope:this})},onDependencyDblClick:function(b,a){var c=this.getRecordForDependencyEl(a);this.fireEvent("dependencydblclick",this,c,b,a)},highlightDependency:function(a){if(!(a instanceof Ext.data.Model)){a=this.getDependencyRecordByInternalId(a)}this.getElementsForDependency(a).addCls(this.selectedCls)},unhighlightDependency:function(a){if(!(a instanceof Ext.data.Model)){a=this.getDependencyRecordByInternalId(a)}this.getElementsForDependency(a).removeCls(this.selectedCls)},getElementsForDependency:function(a){var b=a instanceof Ext.data.Model?a.internalId:a;return this.containerEl.select(".sch-dep-"+b)},depRe:new RegExp("sch-dep-([^\\s]+)"),getDependencyRecordByInternalId:function(d){var c,b,a;for(b=0,a=this.store.getCount();b<a;b++){c=this.store.getAt(b);if(c.internalId==d){return c}}return null},getRecordForDependencyEl:function(c){var a=c.className.match(this.depRe),d=null;if(a&&a[1]){var b=a[1];d=this.getDependencyRecordByInternalId(b)}return d},renderAllDependenciesBuffered:function(){if(this.renderAllDepsBuffered){return}this.renderAllDepsBuffered=true;var a=this;setTimeout(function(){a.renderAllDepsBuffered=false;a.renderAllDependencies()},5)},renderAllDependencies:function(){if(!this.containerEl.dom){return}this.getDependencyElements().remove();this.renderDependencies(this.store.data.items)},getDependencyElements:function(){return this.containerEl.select("."+this.dependencyCls)},renderDependencies:function(b){if(b){var a=this.painter.getDependencyTplData(b);this.lineTpl[Ext.isIE?"insertFirst":"append"](this.containerEl,a)}},renderTaskDependencies:function(d){var c=[];if(!Ext.isArray(d)){d=[d]}for(var a=0,b=d.length;a<b;a++){c=c.concat(d[a].getAllDependencies())}this.renderDependencies(c)},onDependencyUpdate:function(b,a){this.removeDependencyElements(a,false);this.renderDependencies(a)},onDependencyAdd:function(a,b){this.renderDependencies(b)},removeDependencyElements:function(a,b){if(b!==false){this.getElementsForDependency(a).fadeOut({remove:true})}else{this.getElementsForDependency(a).remove()}},onDependencyDelete:function(b,a){this.removeDependencyElements(a)},dimEventDependencies:function(a){this.containerEl.select(this.depRe+a).setOpacity(0.2)},clearSelectedDependencies:function(){this.containerEl.select("."+this.selectedCls).removeCls(this.selectedCls)},onTaskUpdated:function(c,b,a){if(a!=Ext.data.Model.COMMIT&&(!b.previous||b.startDateField in b.previous||b.endDateField in b.previous)){this.updateDependencies(b)}},updateDependencies:function(b){if(!Ext.isArray(b)){b=[b]}var a=this;Ext.each(b,function(c){Ext.each(c.getAllDependencies(),function(d){a.removeDependencyElements(d,false)})});this.renderTaskDependencies(b)},onDependencyDrop:function(e,c,b,d){var a=new this.store.model({fromTask:c,toTask:b,type:d});if(this.store.isValidDependency(a)){this.store.add(a)}},destroy:function(){if(this.dnd){this.dnd.destroy()}}});Ext.define("Gnt.view.Gantt",{extend:"Sch.view.TimelineTreeView",alias:["widget.ganttview"],requires:["Gnt.view.Dependency","Gnt.model.Task","Gnt.template.Task","Gnt.template.ParentTask","Gnt.template.Milestone","Gnt.feature.TaskDragDrop","Gnt.feature.ProgressBarResize","Gnt.feature.TaskResize","Sch.view.Horizontal"],uses:["Gnt.feature.LabelEditor","Gnt.feature.DragCreator"],_cmpCls:"sch-ganttview",rowHeight:22,barMargin:4,scheduledEventName:"task",trackOver:false,toggleOnDblClick:false,milestoneOffset:8,parentTaskOffset:6,eventSelector:".sch-gantt-item",eventWrapSelector:".sch-event-wrap",progressBarResizer:null,taskResizer:null,taskDragDrop:null,dragCreator:null,dependencyView:null,resizeConfig:null,dragDropConfig:null,constructor:function(a){var b=a.panel._top;Ext.apply(this,{taskStore:b.taskStore,dependencyStore:b.dependencyStore,enableDependencyDragDrop:b.enableDependencyDragDrop,enableTaskDragDrop:b.enableTaskDragDrop,enableProgressBarResize:b.enableProgressBarResize,enableDragCreation:b.enableDragCreation,allowParentTaskMove:b.allowParentTaskMove,toggleParentTasksOnClick:b.toggleParentTasksOnClick,resizeHandles:b.resizeHandles,enableBaseline:b.baselineVisible||b.enableBaseline,leftLabelField:b.leftLabelField,rightLabelField:b.rightLabelField,eventTemplate:b.eventTemplate,parentEventTemplate:b.parentEventTemplate,milestoneTemplate:b.milestoneTemplate,resizeConfig:b.resizeConfig,dragDropConfig:b.dragDropConfig});this.addEvents("taskclick","taskdblclick","taskcontextmenu","beforetaskresize","taskresizestart","partialtaskresize","aftertaskresize","beforeprogressbarresize","progressbarresizestart","afterprogressbarresize","beforetaskdrag","taskdragstart","taskdrop","aftertaskdrop","labeledit_beforestartedit","labeledit_beforecomplete","labeledit_complete","beforedependencydrag","dependencydragstart","dependencydrop","afterdependencydragdrop");this.callParent(arguments)},initComponent:function(){this.configureLabels();this.setupGanttEvents();this.callParent(arguments);this.setupTemplates()},getDependencyStore:function(){return this.dependencyStore},configureFeatures:function(){if(this.enableProgressBarResize!==false){this.progressBarResizer=Ext.create("Gnt.feature.ProgressBarResize",{gantt:this});this.on({beforeprogressbarresize:this.onBeforeTaskProgressBarResize,progressbarresizestart:this.onTaskProgressBarResizeStart,afterprogressbarresize:this.onTaskProgressBarResizeEnd,scope:this})}if(this.resizeHandles!=="none"){this.taskResizer=Ext.create("Gnt.feature.TaskResize",Ext.apply({gantt:this,validatorFn:this.resizeValidatorFn||Ext.emptyFn,validatorFnScope:this.validatorFnScope||this},this.resizeConfig||{}));this.on({beforedragcreate:this.onBeforeDragCreate,beforeresize:this.onBeforeTaskResize,taskresizestart:this.onTaskResizeStart,aftertaskresize:this.onTaskResizeEnd,scope:this})}if(this.enableTaskDragDrop){this.taskDragDrop=Ext.create("Gnt.feature.TaskDragDrop",Ext.apply({gantt:this,validatorFn:this.dndValidatorFn||Ext.emptyFn,validatorFnScope:this.validatorFnScope||this},this.dragDropConfig));this.on({beforetaskdrag:this.onBeforeTaskDrag,taskdragstart:this.onDragDropStart,aftertaskdrop:this.onDragDropEnd,scope:this})}if(this.enableDragCreation){this.dragCreator=Ext.create("Gnt.feature.DragCreator",Ext.apply({ganttView:this}))}},prepareData:function(d,a,b){if(this.headerCt.items.getCount()===0){return this.callParent(arguments)}var c=this,e={},f=c.gridDataColumns||c.getGridColumns();e[f[0].id]=this.renderTask(b);return e},renderTask:function(i){var j=i.getStartDate(),l=this.timeAxis,p=Sch.util.Date,b={},x="",g=l.getStart(),f=l.getEnd(),z=i.isMilestone(),u=i.isLeaf(),m,n,r;if(j){var s=i.getEndDate()||Sch.util.Date.add(j,Sch.util.Date.DAY,1),c=Sch.util.Date.intersectSpans(j,s,g,f);if(c){r=s>f;n=p.betweenLesser(j,g,f);var w=Math.floor(this.getXYFromDate(n?j:g)[0]),d=z?0:Math.floor(this.getXYFromDate(r?f:s)[0])-w;if(!z&&!u){d+=12}b={id:i.internalId,leftOffset:w,internalcls:(i.dirty?" sch-dirty ":"")+(i.getCls()||""),width:Math.max(1,d),percentDone:Math.min(i.getPercentDone()||0,100)};m=this.eventRenderer.call(this.eventRendererScope||this,i,b,i.store)||{};var q=this.leftLabelField,h=this.rightLabelField,y;if(q){b.leftLabel=q.renderer.call(q.scope||this,i.data[q.dataIndex],i)}if(h){b.rightLabel=h.renderer.call(h.scope||this,i.data[h.dataIndex],i)}Ext.apply(b,m);if(z){y=this.milestoneTemplate}else{b.width=Math.max(1,d);if(r){b.internalcls+=" sch-event-endsoutside "}if(!n){b.internalcls+=" sch-event-startsoutside "}y=this[u?"eventTemplate":"parentEventTemplate"]}x+=y.apply(b)}}if(this.enableBaseline){var o=i.getBaselineStartDate(),a=i.getBaselineEndDate();if(!m){m=this.eventRenderer.call(this,i,b,i.store)||{}}if(o&&a){var r=a>f,n=p.betweenLesser(o,g,f),e=i.isMilestone(),t=e?this.baselineMilestoneTemplate:(i.isLeaf()?this.baselineTaskTemplate:this.baselineParentTaskTemplate),k=Math.floor(this.getXYFromDate(n?o:g)[0]),v=z?0:Math.floor(this.getXYFromDate(r?f:a)[0])-k;x+=t.apply({basecls:m.basecls||"",id:i.internalId+"-base",percentDone:i.getBaselinePercentDone(),leftOffset:k,width:Math.max(1,v)})}}return x},setupTemplates:function(){var a={leftLabel:!!this.leftLabelField,rightLabel:!!this.rightLabelField,prefix:this.eventPrefix,enableDependencyDragDrop:this.enableDependencyDragDrop!==false,resizeHandles:this.resizeHandles,enableProgressBarResize:this.enableProgressBarResize};if(!this.eventTemplate){a.baseCls="sch-gantt-task {ctcls}";this.eventTemplate=Ext.create("Gnt.template.Task",a)}if(!this.parentEventTemplate){a.baseCls="sch-gantt-parent-task {ctcls}";this.parentEventTemplate=Ext.create("Gnt.template.ParentTask",a)}if(!this.milestoneTemplate){a.baseCls="sch-gantt-milestone {ctcls}";this.milestoneTemplate=Ext.create("Gnt.template.Milestone",a)}if(this.enableBaseline){a={prefix:this.eventPrefix};if(!this.baselineTaskTemplate){a.baseCls="sch-gantt-task-baseline sch-gantt-baseline-item {basecls}";this.baselineTaskTemplate=Ext.create("Gnt.template.Task",a)}if(!this.baselineParentTaskTemplate){a.baseCls="sch-gantt-parenttask-baseline sch-gantt-baseline-item {basecls}";this.baselineParentTaskTemplate=Ext.create("Gnt.template.ParentTask",a)}if(!this.baselineMilestoneTemplate){a.baseCls="sch-gantt-milestone-baseline sch-gantt-baseline-item {basecls}";this.baselineMilestoneTemplate=Ext.create("Gnt.template.Milestone",a)}}},getDependencyView:function(){return this.dependencyView},getTaskStore:function(){return this.taskStore},initDependencies:function(){if(this.dependencyStore){var b=this,a=Ext.create("Gnt.view.Dependency",{containerEl:b.el,ganttView:b,enableDependencyDragDrop:b.enableDependencyDragDrop,store:b.dependencyStore});a.on({beforednd:b.onBeforeDependencyDrag,dndstart:b.onDependencyDragStart,drop:b.onDependencyDrop,afterdnd:b.onAfterDependencyDragDrop,beforecascade:b.onBeforeCascade,cascade:b.onCascade,scope:b});b.dependencyView=a;b.relayEvents(a,["dependencydblclick"])}},setupGanttEvents:function(){var a=this.getSelectionModel();if(this.toggleParentTasksOnClick){this.on({taskclick:function(c,b){if(!b.isLeaf()){this.toggle(b)}},scope:this})}},configureLabels:function(){var c={renderer:function(d){return d},dataIndex:undefined};var b=this.leftLabelField;if(b){if(Ext.isString(b)){b=this.leftLabelField={dataIndex:b}}Ext.applyIf(b,c);if(b.editor){b.editor=Ext.create("Gnt.feature.LabelEditor",this,{alignment:"r-r",delegate:".sch-gantt-label-left",labelPosition:"left",field:b.editor,dataIndex:b.dataIndex})}}var a=this.rightLabelField;if(a){if(Ext.isString(a)){a=this.rightLabelField={dataIndex:a}}Ext.applyIf(a,c);if(a.editor){a.editor=Ext.create("Gnt.feature.LabelEditor",this,{alignment:"l-l",delegate:".sch-gantt-label-right",labelPosition:"right",field:a.editor,dataIndex:a.dataIndex})}}this.on("labeledit_beforestartedit",this.onBeforeLabelEdit,this)},onBeforeTaskDrag:function(b,a){return !this.readOnly&&(this.allowParentTaskMove||a.isLeaf())},onDragDropStart:function(){if(this.tip){this.tip.disable()}},onDragDropEnd:function(){if(this.tip){this.tip.enable()}},onTaskProgressBarResizeStart:function(){if(this.tip){this.tip.hide();this.tip.disable()}},onTaskProgressBarResizeEnd:function(){if(this.tip){this.tip.enable()}},onTaskResizeStart:function(){if(this.tip){this.tip.hide();this.tip.disable()}},onTaskResizeEnd:function(){if(this.tip){this.tip.enable()}},onBeforeDragCreate:function(){return !this.readOnly},onBeforeTaskResize:function(){return !this.readOnly},onBeforeTaskProgressBarResize:function(){return !this.readOnly},onBeforeLabelEdit:function(){return !this.readOnly},onBeforeEdit:function(){return !this.readOnly},beforeRender:function(){this.addCls("sch-ganttview");this.callParent(arguments)},afterRender:function(){this.initDependencies();this.callParent(arguments);this.el.on("mousemove",this.configureFeatures,this,{single:true})},resolveTaskRecord:function(a){var b=this.findItemByChild(a);if(b){return this.getRecord(this.findItemByChild(a))}return null},resolveEventRecord:function(a){return this.resolveTaskRecord(a)},highlightTask:function(b,a){if(!(b instanceof Ext.data.Model)){b=this.taskStore.getById(b)}if(b){var d=this.getNode(b);if(d){Ext.fly(d).addCls("sch-gantt-task-highlighted")}var c=b.getId()||b.internalId;if(a!==false){this.dependencyStore.each(function(e){if(e.getSourceId()==c){this.highlightDependency(e.id);this.highlightTask(e.getTargetId(),a)}},this)}}},unhighlightTask:function(a,c){if(!(a instanceof Ext.data.Model)){a=this.taskStore.getById(a)}if(a){Ext.fly(this.getNode(a)).removeCls("sch-gantt-task-highlighted");var b=a.getId()||a.internalId;if(c!==false){this.dependencyStore.each(function(d){if(d.getSourceId()==b){this.unhighlightDependency(d.id);this.unhighlightTask(d.getTargetId(),c)}},this)}}},clearSelectedTasksAndDependencies:function(){this.getSelectionModel().deselectAll();this.getDependencyView().clearSelectedDependencies();this.el.select("tr.sch-gantt-task-highlighted").removeCls("sch-gantt-task-highlighted")},getCriticalPaths:function(){return this.taskStore.getCriticalPaths()},highlightCriticalPaths:function(){this.clearSelectedTasksAndDependencies();var g=this.getCriticalPaths(),c=this.getDependencyView(),f=this.dependencyStore,e,d,b,a;Ext.each(g,function(h){for(d=0,b=h.length;d<b;d++){e=h[d];this.highlightTask(e,false);if(d<(b-1)){a=f.getAt(f.findBy(function(i){return i.getTargetId()===(e.getId()||e.internalId)&&i.getSourceId()===(h[d+1].getId()||h[d+1].internalId)}));c.highlightDependency(a)}}},this);this.addCls("sch-gantt-critical-chain");this.getSelectionModel().setLocked(true)},unhighlightCriticalPaths:function(){this.el.removeCls("sch-gantt-critical-chain");this.getSelectionModel().setLocked(false);this.clearSelectedTasksAndDependencies()},getXOffset:function(a){var b=0;if(a.isMilestone()){b=this.milestoneOffset}else{if(!a.isLeaf()){b=this.parentTaskOffset}}return b},onDestroy:function(){if(this.dependencyView){this.dependencyView.destroy()}this.callParent(arguments)},highlightDependency:function(a){this.dependencyView.highlightDependency(a)},unhighlightDependency:function(a){this.dependencyView.unhighlightDependency(a)},onBeforeDependencyDrag:function(b,a){return this.fireEvent("beforedependencydrag",this,a)},onDependencyDragStart:function(a){this.fireEvent("dependencydragstart",this);if(this.tip){this.tip.disable()}},onDependencyDrop:function(b,c,a,d){this.fireEvent("dependencydrop",this,this.taskStore.getNodeById(c),this.taskStore.getById(a),d)},onAfterDependencyDragDrop:function(){this.fireEvent("afterdependencydragdrop",this);if(this.tip){this.tip.enable()}},onBeforeCascade:function(a,b){this.taskStore.un("update",this.onUpdate,this)},onCascade:function(a,b){this.taskStore.on("update",this.onUpdate,this)},getLeftEditor:function(){return this.leftLabelField.editor},getRightEditor:function(){return this.rightLabelField.editor},editLeftLabel:function(a){var b=this.leftLabelField&&this.getLeftEditor();if(b){b.edit(a)}},editRightLabel:function(a){var b=this.rightLabelField&&this.getRightEditor();if(b){b.edit(a)}},getOuterElementFromEventRecord:function(a){var b=this.callParent([a]);return b&&b.up(this.eventWrapSelector)||null},getDependenciesForTask:function(a){console.warn("`ganttPanel.getDependenciesForTask()` is deprecated, use `task.getAllDependencies()` instead");return a.getAllDependencies()},setNewTemplate:function(){var b=this,a=b.headerCt.getColumnsForTpl(true);b.tpl=b.getTableChunker().getTableTpl({columns:[a[0]],features:b.features})},getAnimWrap:function(a){if(!this.animate){return null}while(a){if(a.animWrapNormal){return a.animWrapNormal}a=a.parentNode}return null},onBeforeExpand:function(d,b,c){var e=this,a;if(!e.rendered||!e.animate){return}if(e.getNode(d)){a=e.getAnimWrap(d);if(!a){a=d.animWrapNormal=e.createAnimWrap(d);a.animateEl.setHeight(0)}else{if(a.collapsing){a.targetEl.select(e.itemSelector).remove()}}a.expanding=true;a.collapsing=false}},onBeforeCollapse:function(d,b,c){var e=this,a;if(!e.rendered||!e.animate){return}if(e.getNode(d)){a=e.getAnimWrap(d);if(!a){a=d.animWrapNormal=e.createAnimWrap(d,c)}else{if(a.expanding){a.targetEl.select(this.itemSelector).remove()}}a.expanding=false;a.collapsing=true}},onExpand:function(c){var d=this,a=d.animQueue,h=c.getId(),b,e,f,g;if(d.singleExpand){d.ensureSingleExpand(c)}b=d.getAnimWrap(c);if(!b){return}e=b.animateEl;f=b.targetEl;e.stopAnimation();a[h]=true;e.slideIn("t",{duration:d.expandDuration,listeners:{scope:d,lastframe:function(){b.el.insertSibling(f.query(d.itemSelector),"before");b.el.remove();delete b.record.animWrapNormal;delete a[h];d.fireEvent("afterexpand",d)}}});b.isAnimating=true},onCollapse:function(c){var d=this,a=d.animQueue,g=c.getId(),b=d.getAnimWrap(c),e,f;if(!b){return}e=b.animateEl;f=b.targetEl;a[g]=true;e.stopAnimation();e.slideOut("t",{duration:d.collapseDuration,listeners:{scope:d,lastframe:function(){b.el.remove();delete b.record.animWrapNormal;delete a[g];d.fireEvent("aftercollapse",d)}}});b.isAnimating=true}});Ext.define("Gnt.panel.Gantt",{extend:"Sch.panel.TimelineTreePanel",alias:["widget.ganttpanel"],alternateClassName:["Sch.gantt.GanttPanel"],requires:["Gnt.view.Gantt","Gnt.model.Dependency","Gnt.data.ResourceStore","Gnt.data.AssignmentStore","Gnt.feature.WorkingTime","Gnt.data.Calendar","Gnt.data.TaskStore","Gnt.data.DependencyStore"],uses:["Sch.plugin.CurrentTimeLine"],lockedXType:"treepanel",normalXType:"ganttpanel",viewType:"ganttview",syncRowHeight:false,leftLabelField:null,rightLabelField:null,highlightWeekends:true,weekendsAreWorkdays:false,skipWeekendsDuringDragDrop:true,enableTaskDragDrop:true,enableDependencyDragDrop:true,enableProgressBarResize:false,toggleParentTasksOnClick:true,addRowOnTab:true,recalculateParents:true,cascadeChanges:false,showTodayLine:false,enableBaseline:false,baselineVisible:false,enableAnimations:false,workingTimePlugin:null,todayLinePlugin:null,allowParentTaskMove:false,enableDragCreation:true,eventRenderer:Ext.emptyFn,eventRendererScope:null,eventTemplate:null,parentEventTemplate:null,milestoneTemplate:null,autoHeight:null,calendar:null,taskStore:null,dependencyStore:null,resourceStore:null,assignmentStore:null,columnLines:false,dndValidatorFn:Ext.emptyFn,resizeHandles:"both",resizeValidatorFn:Ext.emptyFn,resizeConfig:null,dragDropConfig:null,initStores:function(){var a=this.taskStore||this.store;if(!a){Ext.Error.raise("You must specify an taskStore config")}if(!(a instanceof Gnt.data.TaskStore)){Ext.Error.raise("A `taskStore` should be an instance of `Gnt.data.TaskStore` (or of its subclass)")}Ext.apply(this,{store:a,taskStore:a});var b=this.calendar=a.calendar;if(this.hasOwnProperty("weekendsAreWorkdays")){b.weekendsAreWorkdays=this.weekendsAreWorkdays}if(a.dependencyStore){this.dependencyStore=a.dependencyStore}else{if(this.dependencyStore){a.setDependencyStore(this.dependencyStore)}else{this.dependencyStore=Ext.create("Gnt.data.DependencyStore");a.setDependencyStore(this.dependencyStore)}}if(!(this.dependencyStore instanceof Gnt.data.DependencyStore)){Ext.Error.raise("The Gantt dependency store should be a Gnt.data.DependencyStore, or a subclass thereof.");this.dependencyStore.self.mixin("dependencyStoreAdaptions",Gnt.data.DependencyStore);this.dependencyStore.init()}if(a.getResourceStore()){this.resourceStore=a.getResourceStore()}else{if(this.resourceStore){a.setResourceStore(this.resourceStore)}else{this.resourceStore=Ext.create("Gnt.data.ResourceStore");a.setResourceStore(this.resourceStore)}}if(a.getAssignmentStore()){this.assignmentStore=a.getAssignmentStore()}else{if(this.assignmentStore){a.setAssignmentStore(this.assignmentStore)}else{this.assignmentStore=Ext.create("Gnt.data.AssignmentStore");a.setAssignmentStore(this.assignmentStore)}}if(this.lockable){if(this.assignmentStore){this.assignmentStore.on({datachanged:function(){this.getView().refreshKeepingScroll()},scope:this})}if(this.resourceStore){this.resourceStore.on({datachanged:function(){this.getView().refreshKeepingScroll()},scope:this})}}},initComponent:function(){if(Ext.isBoolean(this.showBaseline)){this.enableBaseline=this.baselineVisible=this.showBaseline;this.showBaseline=Gnt.panel.Gantt.prototype.showBaseline}this.autoHeight=false;this.initStores();if(Ext.isBoolean(this.showBaseline)){this.enableBaseline=this.baselineVisible=this.showBaseline;this.showBaseline=Gnt.panel.Gantt.prototype.showBaseline}this.autoHeight=false;if(this.hasOwnProperty("cascadeChanges")){this.setCascadeChanges(this.cascadeChanges)}if(this.hasOwnProperty("recalculateParents")){this.setRecalculateParents(this.recalculateParents)}if(this.hasOwnProperty("skipWeekendsDuringDragDrop")){this.setSkipWeekendsDuringDragDrop(this.skipWeekendsDuringDragDrop)}if(this.lockable){this.configureFunctionality()}this.callParent(arguments);if(this.lockable){var a=this.getSchedulingView();a.store.calendar=this.calendar;this.relayEvents(a,["taskclick","taskdblclick","taskcontextmenu","beforetaskresize","taskresizestart","partialtaskresize","aftertaskresize","beforeprogressbarresize","progressbarresizestart","afterprogressbarresize","beforetaskdrag","taskdragstart","taskdrop","aftertaskdrop","labeledit_beforestartedit","labeledit_beforecomplete","labeledit_complete","beforedependencydrag","dependencydragstart","dependencydrop","afterdependencydragdrop","dependencydblclick"]);if(this.lockable&&this.addRowOnTab){var b=this.lockedGrid,c=this.getSelectionModel();c.onEditorTab=Ext.Function.createInterceptor(c.onEditorTab,function(h,i){var g=b.view,f=h.getActiveRecord(),j=h.getActiveColumn(),d=g.getPosition(f,j);if(d.column===b.headerCt.getColumnCount()-1&&d.row===b.view.store.getCount()-1){f.addTaskBelow({leaf:true})}})}}},fixSelectionModel:function(){var a=this.getSelectionModel();var d=this.lockedGrid.getView();var c=this.normalGrid.getView();d.__lockedType="locked";c.__lockedType="normal";var e=d.onAdd;d.onAdd=function(){a.__preventUpdateOf="normal";e.apply(this,arguments);delete a.__preventUpdateOf};var b=c.onAdd;c.onAdd=function(){a.__preventUpdateOf="locked";b.apply(this,arguments);delete a.__preventUpdateOf};Ext.apply(a,{onSelectChange:function(l,h,p,f){var n=this,q=n.views,j=q.length,o=n.store,g=o.indexOf(l),m=h?"select":"deselect",k=0;if((p||n.fireEvent("before"+m,n,l,g))!==false&&f()!==false){for(;k<j;k++){if(!this.__preventUpdateOf||q[k].__lockedType!=this.__preventUpdateOf){if(h){q[k].onRowSelect(g,p)}else{q[k].onRowDeselect(g,p)}}}if(!p){n.fireEvent(m,n,l,g)}}}})},getDependencyView:function(){return this.getSchedulingView().getDependencyView()},disableWeekendHighlighting:function(a){this.workingTimePlugin.setDisabled(a)},resolveTaskRecord:function(a){return this.getSchedulingView().getRecord(a)},fitTimeColumns:function(){this.getSchedulingView().fitColumns()},getTaskStore:function(){return this.taskStore},getDependencyStore:function(){return this.dependencyStore},onDragDropStart:function(){if(this.tip){this.tip.hide();this.tip.disable()}},onDragDropEnd:function(){if(this.tip){this.tip.enable()}},configureFunctionality:function(){var a=this.plugins=[].concat(this.plugins||[]);if(this.highlightWeekends){this.workingTimePlugin=Ext.create("Gnt.feature.WorkingTime",{calendar:this.calendar});a.push(this.workingTimePlugin)}if(this.showTodayLine){this.todayLinePlugin=new Sch.plugin.CurrentTimeLine();a.push(this.todayLinePlugin)}},beforeRender:function(){if(this.lockable){var a=" sch-ganttpanel sch-horizontal ";if(this.highlightWeekends){a+=" sch-ganttpanel-highlightweekends "}this.addCls(a);if(this.baselineVisible){this.showBaseline()}}this.callParent(arguments)},afterRender:function(){this.callParent(arguments);if(this.lockable){this.applyPatches()}},showBaseline:function(){this.addCls("sch-ganttpanel-showbaseline")},hideBaseline:function(){this.removeCls("sch-ganttpanel-showbaseline")},toggleBaseline:function(){this.toggleCls("sch-ganttpanel-showbaseline")},zoomToFit:function(){var a=this.taskStore.getTotalTimeSpan();if(a.start&&a.end&&a.start<a.end){this.setTimeSpan(a.start,a.end);this.fitTimeColumns()}},getCascadeChanges:function(){return this.taskStore.cascadeChanges},setCascadeChanges:function(a){this.taskStore.cascadeChanges=a},getRecalculateParents:function(){return this.taskStore.recalculateParents},setRecalculateParents:function(a){this.taskStore.recalculateParents=a},setSkipWeekendsDuringDragDrop:function(a){this.taskStore.skipWeekendsDuringDragDrop=this.skipWeekendsDuringDragDrop=a},getSkipWeekendsDuringDragDrop:function(){return this.taskStore.skipWeekendsDuringDragDrop},applyPatches:function(){if(Ext.tree.plugin&&Ext.tree.plugin.TreeViewDragDrop){var a;Ext.each(this.lockedGrid.getView().plugins,function(b){if(b instanceof Ext.tree.plugin.TreeViewDragDrop){a=b;return false}});if(!a||!a.dropZone){return}a.dropZone.handleNodeDrop=function(e,l,f){var n=this,o=n.view,g=l.parentNode,p=o.getStore(),r=[],b,d,k,c,j,m,q,h;if(e.copy){b=e.records;e.records=[];for(d=0,k=b.length;d<k;d++){e.records.push(Ext.apply({},b[d].data))}}n.cancelExpand();if(f=="before"){c=g.insertBefore;j=[null,l];l=g}else{if(f=="after"){if(l.nextSibling){c=g.insertBefore;j=[null,l.nextSibling]}else{c=g.appendChild;j=[null]}l=g}else{if(!l.isExpanded()){m=true}c=l.appendChild;j=[null]}}q=function(){var i;for(d=0,k=e.records.length;d<k;d++){j[0]=e.records[d];j[0].isMove=true;i=c.apply(l,j);delete j[0].isMove;if(Ext.enableFx&&n.dropHighlight){r.push(o.getNode(i))}}if(Ext.enableFx&&n.dropHighlight){Ext.Array.forEach(r,function(s){if(s){Ext.fly(s.firstChild?s.firstChild:s).highlight(n.dropHighlightColor)}})}};if(m){l.expand(false,q)}else{q()}}}}});Ext.define("Gnt.column.Duration.Field",{extend:"Ext.form.field.Number",alias:"widget.durationfield",disableKeyFilter:true,minValue:0,durationRegex:/(-?\d+(?:[.,]\d+)?)\s*(\w+)?/i,unitsRegex:{MILLI:/^ms$|^mil/i,SECOND:/^s$|^sec/i,MINUTE:/^m$|^min/i,HOUR:/^h$|^hr$|^hour/i,DAY:/^d$|^day/i,WEEK:/^w$|^wk|^week/i,MONTH:/^mo|^mnt/i,QUARTER:/^q$|^quar|^qrt/i,YEAR:/^y$|^yr|^year/i},durationUnit:"h",rawToValue:function(b){var a=this.parseDuration(b);if(!a){return null}this.durationUnit=a.unit;return a.value!=null?a.value:null},valueToRaw:function(a){if(Ext.isNumber(a)){return parseFloat(Ext.Number.toFixed(a,this.decimalPrecision))+" "+Sch.util.Date.getReadableNameOfUnit(this.durationUnit)}return""},parseDuration:function(c){if(c==null||!this.durationRegex.test(c)){return null}var a=this.durationRegex.exec(c);var e=this.parseValue(a[1]);var b=a[2];var d;if(b){Ext.iterate(this.unitsRegex,function(f,g){if(g.test(b)){d=Sch.util.Date.getUnitByName(f);return false}})}return{value:e,unit:d||this.durationUnit}},getDurationValue:function(){return this.parseDuration(this.getRawValue())},getErrors:function(b){var a=this.parseDuration(b);if(!a){return["Invalid number format"]}return this.callParent([a.value])}});Ext.define("Gnt.column.Duration.Editor",{extend:"Ext.grid.CellEditor",alias:"widget.durationcolumneditor",context:null,decimalPrecision:2,getDurationUnitMethod:"getDurationUnit",setDurationMethod:"setDuration",constructor:function(a){a=a||{};a.field=a.field||Ext.create("Gnt.column.Duration.Field",{decimalPrecision:a.decimalPrecision||2});this.callParent([a])},startEdit:function(c,b,a){this.context=a;this.field.durationUnit=a.record[this.getDurationUnitMethod]();return this.callParent(arguments)},completeEdit:function(a){var d=this,g=d.field,e;if(!d.editing){return}if(g.assertValue){g.assertValue()}e=d.getValue();if(!g.isValid()){if(d.revertInvalid!==false){d.cancelEdit(a)}return}if(String(e)===String(d.startValue)&&d.ignoreNoChange){d.hideEdit(a);return}if(d.fireEvent("beforecomplete",d,e,d.startValue)!==false){e=d.getValue();if(d.updateEl&&d.boundEl){d.boundEl.update(e)}d.hideEdit(a);var c=this.context;var b=c.record;var f=this.field.getDurationValue();b[this.setDurationMethod](f.value,f.unit)}}});Ext.define("Gnt.column.AssignmentUnits",{extend:"Ext.grid.column.Number",alias:"widget.assignmentunitscolumn",text:"Units",dataIndex:"Units",format:"0 %",align:"left"});Ext.define("Gnt.column.Duration",{extend:"Ext.grid.column.Column",alias:"widget.durationcolumn",requires:["Gnt.column.Duration.Field","Gnt.column.Duration.Editor"],text:"Duration",dataIndex:"Duration",width:80,align:"left",decimalPrecision:2,getDurationUnitMethod:"getDurationUnit",setDurationMethod:"setDuration",constructor:function(a){a=a||{};a.editor=a.editor||Ext.create("Gnt.column.Duration.Editor",{decimalPrecision:a.decimalPrecision||2,getDurationUnitMethod:a.getDurationUnitMethod||this.getDurationUnitMethod,setDurationMethod:a.setDurationMethod||this.setDurationMethod});this.scope=this;this.callParent([a]);this.mon(this.editor,"beforestartedit",this.onBeforeStartEdit,this)},onBeforeStartEdit:function(b){var a=b.context.record;return a.isEditable(this.dataIndex)},renderer:function(b,c,a){if(!Ext.isNumber(b)){return""}if(!a.isEditable(this.dataIndex)){c.tdCls=(c.tdCls||"")+" sch-column-readonly"}b=parseFloat(Ext.Number.toFixed(b,this.decimalPrecision));return b+" "+Sch.util.Date.getReadableNameOfUnit(a[this.getDurationUnitMethod](),b>1)}});Ext.define("Gnt.column.Effort",{extend:"Gnt.column.Duration",alias:"widget.effortcolumn",header:"Effort",dataIndex:"Effort",getDurationUnitMethod:"getEffortUnit",setDurationMethod:"setEffort"});Ext.define("Gnt.column.EndDate",{extend:"Ext.grid.column.Date",alias:"widget.enddatecolumn",requires:["Ext.grid.CellEditor"],text:"Finish",width:100,align:"left",dataIndex:"EndDate",task:null,constructor:function(a){a=a||{};var b=a.field||a.editor;delete a.field;delete a.editor;this.field=Ext.create("Ext.grid.CellEditor",{ignoreNoChange:true,field:b||{xtype:"datefield",format:a.format||this.format||Ext.Date.defaultFormat},listeners:{beforecomplete:this.onBeforeEditComplete,scope:this}});this.callParent([a]);this.scope=this;this.renderer=this.rendererFunc},rendererFunc:function(b,c,a){if(!b){return}if(!a.isEditable(this.dataIndex)){c.tdCls=(c.tdCls||"")+" sch-column-readonly"}if(a.getEndDate()>a.getStartDate()&&b-Ext.Date.clearTime(b,true)==0){b=Sch.util.Date.add(b,Sch.util.Date.MILLI,-1)}return Ext.util.Format.date(b,this.format)},afterRender:function(){this.callParent(arguments);this.tree=this.ownerCt.up("treepanel");this.tree.on({edit:this.onTreeEdit,beforeedit:this.onBeforeTreeEdit,scope:this})},onBeforeTreeEdit:function(b){if(b.column==this){var a=this.task=b.record;if(!a.isEditable(this.dataIndex)){return false}if(a.getEndDate()>a.getStartDate()){var c=b.value;if(c-Ext.Date.clearTime(c,true)==0){c=Sch.util.Date.add(c,Sch.util.Date.MILLI,-1)}this.field.startValue=b.value=Ext.Date.clearTime(c)}}},onBeforeEditComplete:function(b,c,a){if(this.task&&c<this.task.getStartDate()){return false}},adjustEndDate:function(b,a){return a.getCalendar().getCalendarDay(b).getAvailabilityEndFor(b)},onTreeEdit:function(c,b){if(b.column===this&&b.value){var a=b.record;var d=b.value;if(d-b.originalValue!==0){b.record.setEndDate(this.adjustEndDate(d,a)||d,false)}}}});Ext.define("Gnt.column.PercentDone",{extend:"Ext.grid.column.Number",alias:"widget.percentdonecolumn",text:"% Done",dataIndex:"PercentDone",width:50,format:"0",align:"center",field:{xtype:"numberfield",minValue:0,maxValue:100}});Ext.define("Gnt.column.ResourceAssignment",{extend:"Ext.grid.column.Column",alias:"widget.resourceassignmentcolumn",text:"Assigned Resources",dataIndex:"Id",tdCls:"sch-assignment-cell",showUnits:true,assignmentStore:null,initComponent:function(){this.formatString="{0}"+(this.showUnits?" [{1}%]":"");this.callParent(arguments)},afterRender:function(){this.scope=this;this.callParent(arguments);this.assignmentStore=this.getOwnerHeaderCt().up("ganttpanel").assignmentStore},renderer:function(j,n,d,g,m,k,h){var f=[],e=this.assignmentStore,a;if(e.resourceStore.getCount()>0){for(var c=0,b=e.getCount();c<b;c++){a=e.getAt(c);if(a.getTaskId()===j){f.push(Ext.String.format(this.formatString,a.getResourceName(),a.getUnits()))}}return f.join(", ")}}});Ext.define("Gnt.column.ResourceName",{extend:"Ext.grid.column.Column",alias:"widget.resourcenamecolumn",text:"Resource Name",dataIndex:"ResourceName",flex:1,align:"left"});Ext.define("Gnt.column.StartDate",{extend:"Ext.grid.column.Date",alias:"widget.startdatecolumn",text:"Start",dataIndex:"StartDate",width:100,align:"left",constructor:function(a){a=a||{};var b=a.field||a.editor;a.field=b||{xtype:"datefield",format:a.format||this.format||Ext.Date.defaultFormat};this.callParent([a])},afterRender:function(){this.callParent(arguments);this.tree=this.ownerCt.up("treepanel");this.tree.on({edit:this.onTreeEdit,beforeedit:this.onBeforeTreeEdit,scope:this})},onBeforeTreeEdit:function(b){if(b.column==this){var a=this.task=b.record;if(!a.isEditable(this.dataIndex)){return false}this.field.startValue=b.value=Ext.Date.clearTime(b.value)}},adjustStartDate:function(b,a){return a.getCalendar().getCalendarDay(b).getAvailabilityStartFor(b)},onTreeEdit:function(c,b){var a=b.record;var d=b.value;if(b.column==this&&d&&d-b.originalValue!==0){a.setStartDate(this.adjustStartDate(d,a)||d,true)}}});Ext.define("Gnt.column.WBS",{extend:"Ext.grid.column.Column",alias:"widget.wbscolumn",text:"#",width:40,align:"left",dataIndex:"index",renderer:function(f,g,b,h,d,e){var a=e.getRootNode(),c=[];while(b!==a){c.push(b.data.index+1);b=b.parentNode}return c.reverse().join(".")}});Ext.define("Gnt.column.SchedulingMode",{extend:"Ext.grid.column.Column",alias:"widget.schedulingmodecolumn",text:"Mode",dataIndex:"SchedulingMode",width:100,align:"left",data:[["FixedDuration","Fixed duration"],["EffortDriven","Effort driven"],["DynamicAssignment","Dynamic assignment"],["Manual","Manual"],["Normal","Normal"]],modeNames:null,pickerAlign:"tl-bl?",matchFieldWidth:true,constructor:function(a){a=a||{};var c=a.field||a.editor;a.field=c||{xtype:"combo",editable:false,store:this.data,pickerAlign:this.pickerAlign,matchFieldWidth:this.matchFieldWidth};var b=this.modeNames={};Ext.Array.each(this.data,function(d){b[d[0]]=d[1]});this.scope=this;this.callParent([a])},renderer:function(a){return this.modeNames[a]},afterRender:function(){this.callParent(arguments);this.tree=this.ownerCt.up("treepanel");this.tree.on("edit",this.onTreeEdit,this)},onTreeEdit:function(b,a){if(a.column==this){a.record.setSchedulingMode(a.value)}}});Ext.define("Gnt.widget.AssignmentGrid",{requires:["Gnt.model.Resource","Gnt.model.Assignment","Gnt.column.ResourceName","Gnt.column.AssignmentUnits","Ext.grid.plugin.CellEditing"],extend:"Ext.grid.Panel",alias:"widget.assignmentgrid",readOnly:false,cls:"gnt-assignmentgrid",defaultAssignedUnits:100,sorter:{sorterFn:function(b,a){var d=b.getUnits(),c=a.getUnits();if((!d&&!c)||(d&&c)){return b.get("ResourceName")<a.get("ResourceName")?-1:1}return d?-1:1}},constructor:function(a){this.store=Ext.create("Ext.data.JsonStore",{model:Ext.define("Gnt.model.AssignmentEditing",{extend:"Gnt.model.Assignment",fields:["ResourceName"]})});this.columns=this.buildColumns();if(!this.readOnly){this.plugins=this.buildPlugins()}Ext.apply(this,{selModel:{selType:"checkboxmodel",mode:"MULTI",checkOnly:true}});this.callParent(arguments)},initComponent:function(){this.loadResources();this.resourceStore.on({datachanged:this.loadResources,scope:this});this.getSelectionModel().on("select",this.onSelect,this,{delay:50});this.callParent(arguments)},onSelect:function(b,a){if(!a.getUnits()){a.setUnits(this.defaultAssignedUnits)}},loadResources:function(){var d=[],b=this.resourceStore,e;for(var c=0,a=b.getCount();c<a;c++){e=b.getAt(c).getId();d.push({ResourceId:e,ResourceName:b.getById(e).getName()})}this.store.loadData(d)},buildPlugins:function(){var a=Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1});a.on("edit",this.onEditingDone,this);return[a]},onEditingDone:function(a,b){if(b.value){this.getSelectionModel().select(b.record,true)}else{this.getSelectionModel().deselect(b.record);b.record.reject()}},buildColumns:function(){return[{xtype:"resourcenamecolumn",resourceStore:this.resourceStore},{xtype:"assignmentunitscolumn",assignmentStore:this.assignmentStore,editor:{xtype:"numberfield",minValue:0,step:10}}]},loadTaskAssignments:function(d){var b=this.store,f=this.getSelectionModel();f.deselectAll(true);for(var c=0,a=b.getCount();c<a;c++){b.getAt(c).data.Units="";b.getAt(c).data.Id=null}b.suspendEvents();var e=this.assignmentStore.queryBy(function(g){return g.getTaskId()===d});e.each(function(h){var g=b.findRecord("ResourceId",h.getResourceId(),0,false,true,true);if(g){g.setUnits(h.getUnits());g.set(g.idProperty,h.getId());f.select(g,true,true)}});b.resumeEvents();b.sort(this.sorter);this.getView().refresh()}});Ext.define("Gnt.widget.AssignmentField",{extend:"Ext.form.field.Picker",alias:"widget.assignmenteditor",requires:["Gnt.widget.AssignmentGrid"],matchFieldWidth:false,editable:false,cancelText:"Cancel",closeText:"Save and Close",assignmentStore:null,resourceStore:null,createPicker:function(){var a=Ext.create("Gnt.widget.AssignmentGrid",{ownerCt:this.ownerCt,renderTo:document.body,frame:true,floating:true,hidden:true,height:200,width:300,resourceStore:this.resourceStore,assignmentStore:this.assignmentStore,fbar:this.buildButtons()});return a},buildButtons:function(){return["->",{text:this.closeText,handler:function(){Ext.Function.defer(this.onGridClose,Ext.isIE&&!Ext.isIE9?60:30,this)},scope:this},{text:this.cancelText,handler:this.collapse,scope:this}]},onExpand:function(){var a=this.resourceStore,b=this.picker;b.loadTaskAssignments(this.taskId)},onGridClose:function(){var b=this.picker.getSelectionModel(),a=b.selected;this.fireEvent("select",this,a);this.collapse()}});Ext.define("Gnt.widget.AssignmentCellEditor",{extend:"Ext.grid.CellEditor",requires:["Gnt.model.Assignment","Gnt.widget.AssignmentField"],assignmentStore:null,resourceStore:null,taskId:null,fieldConfig:null,constructor:function(a){a=a||{};var b=a.fieldConfig||{};this.field=Ext.create("Gnt.widget.AssignmentField",Ext.apply(b,{assignmentStore:a.assignmentStore,resourceStore:a.resourceStore}));this.field.on("select",this.onSelect,this);this.callParent(arguments)},startEdit:function(c,d,b){this.parentEl=null;var a=c.child("div").dom.innerHTML;this.taskId=this.field.taskId=b.value;this.callParent([c,a==="&nbsp;"?"":a]);this.field.expand()},onSelect:function(g,f){var a=this.assignmentStore,e=this.taskId;var d={};var c=[];f.each(function(i){var h=i.getUnits();if(h>0){var k=i.getId();if(k){d[k]=true;a.getById(k).setUnits(h)}else{var j=Ext.create(a.model,{TaskId:e,ResourceId:i.getResourceId(),Units:h});d[j.internalId]=true;c.push(j)}}});var b=[];a.each(function(h){if(h.getTaskId()===e&&!d[h.getId()||h.internalId]){b.push(h)}});a.remove(b);a.add(c);this.completeEdit()}});Ext.define("Gnt.widget.Calendar",{extend:"Ext.picker.Date",alias:"widget.ganttcalendar",requires:["Gnt.data.Calendar","Sch.util.Date"],calendar:null,startDate:null,endDate:null,disabledDatesText:"Holiday",initComponent:function(){if(!this.calendar){Ext.Error.raise('Required attribute "calendar" is missed during initialization of `Gnt.widget.Calendar`')}if(!this.startDate){Ext.Error.raise('Required attribute "startDate" is missed during initialization of `Gnt.widget.Calendar`')}if(!this.endDate){this.endDate=Sch.util.Date.add(this.startDate,Sch.util.Date.MONTH,1)}this.setCalendar(this.calendar);this.minDate=this.value=this.startDate;this.injectDates();this.callParent(arguments)},injectDates:function(){var a=this;var b=a.disabledDates=[];Ext.each(a.calendar.getHolidaysRanges(a.startDate,a.endDate),function(c){c.forEachDate(function(d){b.push(Ext.Date.format(d,a.format))})});a.setDisabledDates(b)},setCalendar:function(b){var a={update:this.injectDates,remove:this.injectDates,add:this.injectDates,load:this.injectDates,clear:this.injectDates,scope:this};if(this.calendar){this.calendar.un(a)}this.calendar=b;b.on(a)}});